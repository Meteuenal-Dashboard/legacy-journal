<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Legacy Vision Journal</title>
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" id="meta-theme-color" content="#f4f4f5">
  
  <link rel="manifest" href="manifest.json">
  
  <!-- Moderne Premium-Schriftarten -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,500;0,600;1,500&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class', 
      theme: {
        extend: {
          colors: {
            graphite: {
              900: '#18181b',
              950: '#09090b',
            },
            paper: {
              100: '#f4f4f5',
              50: '#ffffff',
            }
          }
        }
      }
    }
  </script>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Modernes Typografie & Farb-System */
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Inter', -apple-system, sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      transition: background-color 0.4s ease, color 0.4s ease;
    }

    h1, h2, h3, .font-serif {
      font-family: 'Playfair Display', serif !important;
    }
    
    html:not(.dark) body { background-color: #f4f4f5 !important; color: #18181b !important; }
    html:not(.dark) .card-bg { background-color: #ffffff !important; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
    html.dark body { background-color: #09090b !important; color: #f4f4f5 !important; }
    html.dark .card-bg { background-color: #18181b !important; border: 1px solid rgba(255,255,255,0.05); }

    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 32px); }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
    @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; } 
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } 
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(150, 150, 150, 0.3); border-radius: 10px; }
    .hide-scrollbar::-webkit-scrollbar { display: none; } .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .legacy-editor-content ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .legacy-editor-content li { margin-bottom: 0.25rem; }
    .legacy-editor-content b, .legacy-editor-content strong { font-weight: 600; }
    .legacy-editor-content i, .legacy-editor-content em { font-style: italic; }
    .legacy-editor-content blockquote { border-left: 3px solid #f59e0b; padding-left: 1rem; font-style: italic; opacity: 0.8; background: rgba(245, 158, 11, 0.05); padding: 1rem; border-radius: 0 8px 8px 0; margin: 1rem 0; }
    
    [contenteditable="true"]:empty:before { 
        content: attr(data-placeholder); 
        opacity: 0.4; 
        pointer-events: none; 
        display: block; 
    }

    html, body, #root { width: 100%; height: 100%; overflow-x: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const safeStorageGet = (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } };
    const safeStorageSet = (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      render() { 
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-graphite-950 text-white p-8 text-center">
              <div>
                <h1 className="text-2xl font-bold text-rose-500 mb-4 font-serif">Ein Moment bitte...</h1>
                <p className="opacity-70 mb-8">Die App hat sich verschluckt. Bitte lade die Seite neu.</p>
                <button onClick={() => window.location.reload()} className="px-6 py-3 bg-amber-500 text-slate-900 font-bold rounded-xl shadow-lg">Neu laden</button>
              </div>
            </div>
          );
        }
        return this.props.children; 
      }
    }

    const Icon = ({ name, size = 24, className = '', ...props }) => {
      const spanRef = useRef(null);
      useEffect(() => {
        const renderIcon = () => {
          if (spanRef.current && window.lucide) {
            spanRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
            window.lucide.createIcons({ root: spanRef.current });
            const svg = spanRef.current.querySelector('svg');
            if (svg) {
              svg.setAttribute('width', size);
              svg.setAttribute('height', size);
              if (className) svg.setAttribute('class', `lucide lucide-${name} ${className}`);
            }
          }
        };
        if (window.lucide) renderIcon();
        else setTimeout(renderIcon, 100);
      }, [name, size, className]);

      return <span ref={spanRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} {...props}></span>;
    };

    const COLORS = [
      '#f4f4f5', '#e4e4e7', '#d4d4d8', '#a1a1aa', '#71717a', '#52525b', '#3f3f46', '#27272a', '#18181b', '#09090b',
      '#fef3c7', '#fde68a', '#fcd34d', '#fbbf24', '#f59e0b', '#d97706', '#b45309', '#92400e', '#78350f', '#451a03',
      '#ffe4e6', '#fecdd3', '#fda4af', '#fb7185', '#f43f5e', '#e11d48', '#be123c', '#9f1239', '#881337', '#4c0519'
    ];

    const CATEGORIES = ['Allgemein', 'Familie', 'Karriere', 'Seele', 'Gesundheit', 'Finanzen'];
    const MOODS = [
      { id: 'smile', label: 'Strahlend', color: 'text-amber-500', iconName: 'smile' },
      { id: 'heart', label: 'Liebevoll', color: 'text-rose-500', iconName: 'heart' },
      { id: 'coffee', label: 'Fokussiert', color: 'text-amber-700', iconName: 'coffee' },
      { id: 'cloud-lightning', label: 'Stürmisch', color: 'text-indigo-500', iconName: 'cloud-lightning' },
      { id: 'frown', label: 'Nachdenklich', color: 'text-slate-500', iconName: 'frown' }
    ];

    const DEEP_PROMPTS = [
      "Wofür bist du heute am tiefsten dankbar?",
      "Welche Angst hat dich heute zurückgehalten?",
      "Was würdest du deinem jüngeren Ich heute sagen?",
      "Was ist dein größter Traum, den du dich noch nicht traust auszusprechen?",
      "Welchen Meilenstein möchtest du in einem Jahr erreicht haben?"
    ];

    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    const getDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371e3; 
      const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180;
      const dp = (lat2-lat1) * Math.PI/180, dl = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    };

    const initDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('LegacyVisionDB', 3);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('entries')) db.createObjectStore('entries', { keyPath: 'id' });
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    };

    const App = () => {
      const [db, setDb] = useState(null);
      const [entries, setEntries] = useState([]);
      const [user, setUser] = useState({ name: '', motto: '', pin: '', avatar: null, nameColor: '#f59e0b', testamentId: null, isDark: true });
      const [view, setView] = useState('loading'); 
      const [isLoaded, setIsLoaded] = useState(false);
      
      const [searchQuery, setSearchQuery] = useState('');
      const [activeCategory, setActiveCategory] = useState('Alle');
      const [isSearchOpen, setIsSearchOpen] = useState(false);
      
      const [dialog, setDialog] = useState(null);
      const [picker, setPicker] = useState(null);
      const [installHint, setInstallHint] = useState('');
      
      const [viewingEntry, setViewingEntry] = useState(null);
      const [showEditor, setShowEditor] = useState(false);
      const [affirmation, setAffirmation] = useState(null);
      
      const [unlockTarget, setUnlockTarget] = useState(null);
      const [pinInput, setPinInput] = useState('');
      const [pinError, setPinError] = useState(false);
      const [isChangingPin, setIsChangingPin] = useState(false);
      const [oldPinInput, setOldPinInput] = useState('');
      const [newPinInput, setNewPinInput] = useState('');

      const [editingId, setEditingId] = useState(null);
      const [title, setTitle] = useState('');
      const [text, setText] = useState('');
      const [selectedColor, setSelectedColor] = useState(COLORS[8]);
      const [selectedImage, setSelectedImage] = useState(null);
      const [selectedVideo, setSelectedVideo] = useState(null);
      const [isLocked, setIsLocked] = useState(false);
      const [audioUrl, setAudioUrl] = useState(null);
      const [isManifested, setIsManifested] = useState(false);
      const [unlockDate, setUnlockDate] = useState(''); 
      const [unlockLocation, setUnlockLocation] = useState(null); 
      const [entryType, setEntryType] = useState('vision');
      const [category, setCategory] = useState(CATEGORIES[0]);
      const [mood, setMood] = useState(null);
      const [location, setLocation] = useState(null);
      const [parentId, setParentId] = useState(''); 
      const [zenMode, setZenMode] = useState(false);
      const [inheritedFrom, setInheritedFrom] = useState(null); 

      const [isDrawing, setIsDrawing] = useState(false);
      const canvasRef = useRef(null);
      const editorRef = useRef(null); 
      const [autoSaveStatus, setAutoSaveStatus] = useState('');
      const [burnText, setBurnText] = useState('');
      const [isBurning, setIsBurning] = useState(false);
      
      const [isRecording, setIsRecording] = useState(false);
      const mediaRecorderRef = useRef(null);

      const viewRef = useRef(view);
      const editorRefState = useRef(showEditor);
      const viewingEntryRef = useRef(viewingEntry);
      const closeEditorRef = useRef(null);

      useEffect(() => { viewRef.current = view; }, [view]);
      useEffect(() => { editorRefState.current = showEditor; }, [showEditor]);
      useEffect(() => { viewingEntryRef.current = viewingEntry; }, [viewingEntry]);

      const showDialog = (options) => {
         setDialog({ type: 'alert', confirmLabel: 'Verstanden', ...options });
      };

      const closeEditor = () => {
        setShowEditor(false);
        if (isRecording) stopRecording();
      };

      useEffect(() => {
        closeEditorRef.current = closeEditor;
      });

      useEffect(() => {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
        if (!isStandalone) {
          if (window.location.protocol.includes('file') || window.location.protocol.includes('content')) {
             setInstallHint("Tipp: Du hast die Datei lokal geöffnet (Datenbank blockiert!). Rufe deinen GitHub-Link auf und installiere sie von dort!");
          }
        }
      }, []);

      useEffect(() => {
        if (!isLoaded) return;
        window.history.pushState({ locked: true }, '');

        const handlePopState = (e) => {
          window.history.pushState({ locked: true }, '');

          if (viewingEntryRef.current) {
             setViewingEntry(null);
          } else if (editorRefState.current) {
             closeEditor();
          } else if (viewRef.current !== 'dashboard' && viewRef.current !== 'loading' && viewRef.current !== 'onboarding') {
             setView('dashboard');
          } else if (viewRef.current === 'dashboard') {
            showDialog({
                type: 'confirm',
                title: 'Journal verlassen?',
                message: 'Möchtest du das Vermächtnis wirklich verlassen?',
                icon: 'log-out',
                iconColor: 'text-rose-500',
                confirmLabel: 'Verlassen',
                confirmColor: 'bg-rose-600',
                onConfirm: () => { window.location.href = "about:blank"; }
            });
          }
        };

        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, [isLoaded]);

      useEffect(() => {
        const loadApp = async () => {
          try {
            const savedUser = safeStorageGet('legacy_user');
            let currentUser = { name: '', motto: '', pin: '', avatar: null, nameColor: '#f59e0b', testamentId: null, isDark: true };
            if (savedUser) {
              const parsed = JSON.parse(savedUser);
              if (parsed.isDark !== undefined) delete parsed.isDark;
              currentUser = { ...currentUser, ...parsed };
              setUser(currentUser);
            }

            try {
                const database = await initDB();
                setDb(database);
                
                const transaction = database.transaction('entries', 'readonly');
                const request = transaction.objectStore('entries').getAll();
                
                request.onsuccess = () => {
                  let loadedEntries = request.result || [];
                  const lastActiveStr = safeStorageGet('legacy_last_active');
                  const lastActive = lastActiveStr ? new Date(lastActiveStr) : new Date();
                  const daysInactive = (new Date() - lastActive) / (1000 * 60 * 60 * 24);
                  
                  safeStorageSet('legacy_last_active', new Date().toISOString());
                  setEntries(loadedEntries.sort((a,b) => new Date(b.date) - new Date(a.date)));
                  setIsLoaded(true);

                  if (!currentUser.name) {
                    setView('onboarding');
                  } else if (currentUser.testamentId && daysInactive > 365) {
                    setView('testament'); 
                  } else {
                    setView('dashboard');
                    checkDailyAffirmation(loadedEntries);
                  }
                };
            } catch (dbError) {
                console.error("IndexedDB blocked", dbError);
                showDialog({
                   title: 'Datenbank blockiert',
                   message: 'Dein Browser blockiert den Speicher. Nutze einen normalen Browser für den vollen Umfang!',
                   icon: 'alert-triangle',
                   iconColor: 'text-amber-500'
                });
                setIsLoaded(true);
                if (!currentUser.name) setView('onboarding');
                else setView('dashboard');
            }
          } catch (e) {
            setIsLoaded(true);
            setView('onboarding');
          }
        };
        loadApp();
      }, []);

      const checkDailyAffirmation = (allEntries) => {
        const today = new Date().toDateString();
        if (safeStorageGet('legacy_last_affirmation') !== today && allEntries.length > 0) {
          const publicEntries = allEntries.filter(e => !e.locked && !e.archived);
          if (publicEntries.length > 0) {
            setAffirmation(publicEntries[Math.floor(Math.random() * publicEntries.length)]);
            safeStorageSet('legacy_last_affirmation', today);
          }
        }
      };

      useEffect(() => {
        if (isLoaded) {
           safeStorageSet('legacy_user', JSON.stringify(user));
        }
        
        const metaThemeColor = document.getElementById("meta-theme-color");
        
        if (user.isDark) {
          document.documentElement.classList.add('dark');
          if (metaThemeColor) metaThemeColor.setAttribute("content", "#09090b");
        } else {
          document.documentElement.classList.remove('dark');
          if (metaThemeColor) metaThemeColor.setAttribute("content", "#f4f4f5");
        }
      }, [user, isLoaded]);

      const saveToDB = async (entry) => {
        try {
            if (db) {
              const tx = db.transaction('entries', 'readwrite');
              tx.objectStore('entries').put(entry);
              tx.oncomplete = () => {
                setEntries(prev => {
                  const exists = prev.find(e => e.id === entry.id);
                  if (exists) return prev.map(e => e.id === entry.id ? entry : e);
                  return [entry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
                });
              };
            } else {
              setEntries(prev => {
                  const exists = prev.find(e => e.id === entry.id);
                  if (exists) return prev.map(e => e.id === entry.id ? entry : e);
                  return [entry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
              });
            }
        } catch (e) { console.error("Save Error", e); }
      };

      const checkSaveEntry = () => {
        const executeSave = () => {
            const foundEntry = entries.find(e => e.id === editingId);
            const newEntry = {
              id: editingId || generateId(),
              title: title || 'Neue Seite', text, color: selectedColor,
              image: selectedImage, video: selectedVideo, audio: audioUrl,
              locked: isLocked, archived: false, manifested: isManifested,
              unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
              date: editingId ? (foundEntry ? foundEntry.date : new Date().toISOString()) : new Date().toISOString(),
            };
            saveToDB(newEntry);
            closeEditor();
        };

        const isEmpty = !title.trim() && !text.replace(/<[^>]*>?/gm, '').trim() && !selectedImage && !selectedVideo && !audioUrl;
        if (isEmpty && unlockDate) {
            showDialog({
                type: 'confirm',
                title: 'Leeres Datums-Siegel?',
                message: 'Du hast ein Datum im Kalender ausgewählt, aber keinen Text geschrieben. Möchtest du diese leere Kapsel wirklich versiegeln?',
                icon: 'calendar-clock',
                iconColor: 'text-indigo-500',
                confirmLabel: 'Trotzdem speichern',
                confirmColor: 'bg-indigo-600',
                cancelLabel: 'Abbrechen',
                onConfirm: () => { executeSave(); setDialog(null); }
            });
        } else if (isEmpty && !editingId) {
            showDialog({
                type: 'confirm',
                title: 'Leere Seite',
                message: 'Diese Seite deines Journals ist noch komplett leer. Willst du sie verwerfen oder trotzdem ablegen?',
                icon: 'file-question',
                iconColor: 'text-slate-400',
                confirmLabel: 'Ablegen',
                confirmColor: 'bg-slate-700',
                cancelLabel: 'Verwerfen',
                onCancel: () => { closeEditor(); setDialog(null); },
                onConfirm: () => { executeSave(); setDialog(null); }
            });
        } else {
            executeSave();
        }
      };

      const confirmDelete = (id) => {
        showDialog({
            type: 'confirm',
            title: 'Seite herausreißen?',
            message: 'Bist du sicher, dass du diese Seite für immer aus deinem Journal reißen möchtest? Dieser Schritt kann nicht rückgängig gemacht werden.',
            icon: 'trash-2',
            iconColor: 'text-rose-500',
            confirmLabel: 'Ja, löschen',
            confirmColor: 'bg-rose-600',
            onConfirm: () => { deleteFromDB(id); closeEditor(); setViewingEntry(null); setDialog(null); }
        });
      };

      const confirmArchiveDelete = (id) => {
        showDialog({
            type: 'confirm',
            title: 'Endgültig löschen?',
            message: 'Dieser Eintrag wird unwiderruflich aus dem Archiv gelöscht. Es gibt kein Zurück.',
            icon: 'alert-triangle',
            iconColor: 'text-rose-500',
            confirmLabel: 'Vernichten',
            confirmColor: 'bg-rose-600',
            onConfirm: () => { deleteFromDB(id); setDialog(null); }
        });
      };

      useEffect(() => {
        if (showEditor && editorRef.current && editorRef.current.innerHTML !== text) {
           editorRef.current.innerHTML = text || '';
        }
      }, [showEditor, editingId]);

      useEffect(() => {
        if (!showEditor || (!title && !text) || view === 'burn') return;
        const timer = setTimeout(() => {
          setAutoSaveStatus('Speichert...');
          const foundEntry = entries.find(e => e.id === editingId);
          const currentEntry = {
            id: editingId || generateId(),
            title: title || 'Neue Seite', text, color: selectedColor,
            image: selectedImage, video: selectedVideo, audio: audioUrl,
            locked: isLocked, archived: false, manifested: isManifested,
            unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
            date: editingId ? (foundEntry ? foundEntry.date : new Date().toISOString()) : new Date().toISOString(),
          };
          if (!editingId) setEditingId(currentEntry.id);
          if (db) {
            const tx = db.transaction('entries', 'readwrite');
            tx.objectStore('entries').put(currentEntry);
            tx.oncomplete = () => {
              setEntries(prev => {
                const exists = prev.find(e => e.id === currentEntry.id);
                if (exists) return prev.map(e => e.id === currentEntry.id ? currentEntry : e);
                return [currentEntry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
              });
              setAutoSaveStatus('Gespeichert');
              setTimeout(() => setAutoSaveStatus(''), 2000);
            };
          }
        }, 2000);
        return () => clearTimeout(timer);
      }, [title, text, selectedColor, selectedImage, selectedVideo, audioUrl, isLocked, isManifested, unlockDate, unlockLocation, category, mood, location, parentId, inheritedFrom, db, showEditor, editingId, entries, view]);

      const startDrawing = (e) => {
        if (!canvasRef.current) return;
        const ctx = canvasRef.current.getContext('2d');
        const rect = canvasRef.current.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        ctx.beginPath();
        ctx.moveTo(x, y);
        canvasRef.current.isPainting = true;
      };

      const draw = (e) => {
        if (!canvasRef.current?.isPainting) return;
        const ctx = canvasRef.current.getContext('2d');
        const rect = canvasRef.current.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = user.isDark ? '#ffffff' : '#000000';
        ctx.lineTo(x, y);
        ctx.stroke();
      };

      const stopDrawing = () => {
        if (canvasRef.current) canvasRef.current.isPainting = false;
      };

      useEffect(() => {
        let canvasEl = canvasRef.current;
        const preventScroll = (e) => { e.preventDefault(); };
        if (isDrawing && canvasEl) {
           canvasEl.addEventListener('touchstart', preventScroll, { passive: false });
           canvasEl.addEventListener('touchmove', preventScroll, { passive: false });
           setTimeout(() => {
             if (!canvasEl) return;
             const rect = canvasEl.parentElement.getBoundingClientRect();
             canvasEl.width = rect.width; canvasEl.height = rect.height;
             const ctx = canvasEl.getContext('2d'); 
             ctx.fillStyle = user.isDark ? '#18181b' : '#ffffff'; 
             ctx.fillRect(0, 0, rect.width, rect.height);
           }, 50);
        }
        return () => {
          if (canvasEl) { canvasEl.removeEventListener('touchstart', preventScroll); canvasEl.removeEventListener('touchmove', preventScroll); }
        };
      }, [isDrawing, user.isDark]);

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            if (type === 'image') { setSelectedImage(reader.result); setSelectedVideo(null); }
            if (type === 'video') { setSelectedVideo(reader.result); setSelectedImage(null); }
          };
          reader.readAsDataURL(file);
        }
      };
      
      const handleAudioUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setAudioUrl(reader.result);
          };
          reader.readAsDataURL(file);
        }
      };

      const handleAvatarUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const MAX_SIZE = 400; let width = img.width; let height = img.height;
              if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
              else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
              canvas.width = width; canvas.height = height;
              const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
              setUser(prev => ({ ...prev, avatar: canvas.toDataURL('image/jpeg', 0.8) }));
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
        e.target.value = null;
      };

      const exportText = () => {
        let textContent = "# LEGACY VISION JOURNAL\n\n";
        textContent += `Eigentümer: ${user.name}\n`;
        if (user.motto) textContent += `Lebensmotto: ${user.motto}\n`;
        textContent += `Exportiert am: ${new Date().toLocaleDateString('de-DE')}\n\n`;
        textContent += "=========================================\n\n";
        
        entries.filter(e => !e.locked && !e.archived).forEach(entry => {
            textContent += `## ${entry.title}\n`;
            textContent += `Datum: ${new Date(entry.date).toLocaleDateString('de-DE')}\n`;
            if (entry.category) textContent += `Kategorie: ${entry.category}\n`;
            if (entry.mood) textContent += `Stimmung: ${entry.mood}\n`;
            textContent += "\n";
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = entry.text || '';
            textContent += tempDiv.textContent || tempDiv.innerText || "";
            textContent += "\n\n-----------------------------------------\n\n";
        });
        
        const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Legacy_Text_Export_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
      };

      const exportBackup = () => {
        const data = { user, entries };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Legacy_Backup_${new Date().toISOString().split('T')[0]}.legacy`;
        a.click();
      };

      const importBackup = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.entries) {
              const isForeign = data.user && data.user.name !== user.name;
              if (db) {
                  const tx = db.transaction('entries', 'readwrite');
                  const store = tx.objectStore('entries');
                  let mergedCount = 0;
                  data.entries.forEach(entry => {
                     if (!entries.find(ex => ex.id === entry.id)) {
                        if (isForeign) entry.inheritedFrom = data.user.name;
                        store.put(entry);
                        mergedCount++;
                     }
                  });
                  const req = store.getAll();
                  req.onsuccess = () => {
                     setEntries(req.result.sort((a,b) => new Date(b.date) - new Date(a.date)));
                     showDialog({ title: 'Erfolg', message: `Fusion erfolgreich! ${mergedCount} neue Seiten importiert.`, icon: 'check' });
                  };
              }
            }
          } catch (err) { showDialog({ title: 'Fehler', message: 'Ungültige Legacy-Datei.', icon: 'x' }); }
        };
        reader.readAsText(file);
      };

      const deleteFromDB = async (id) => {
        if (!db) return;
        const tx = db.transaction('entries', 'readwrite');
        tx.objectStore('entries').delete(id);
        tx.oncomplete = () => setEntries(prev => prev.filter(e => e.id !== id));
      };

      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream);
          audioChunksRef.current = [];
          mediaRecorderRef.current.ondataavailable = (e) => { if (e.data.size > 0) audioChunksRef.current.push(e.data); };
          mediaRecorderRef.current.onstop = () => {
            const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => setAudioUrl(reader.result); 
          };
          mediaRecorderRef.current.start();
          setIsRecording(true);
        } catch (err) { showDialog({ title: 'Fehler', message: 'Mikrofon-Zugriff verweigert.', icon: 'x' }); }
      };
      
      const stopRecording = () => { if (mediaRecorderRef.current) { mediaRecorderRef.current.stop(); setIsRecording(false); } };

      const setGeoLock = () => {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition((pos) => {
            setUnlockLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            setLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            showDialog({ title: 'Erfolg', message: 'Die Seite wurde magisch an diesen physischen Ort gebunden!', icon: 'map-pin', iconColor: 'text-emerald-500' });
          }, () => showDialog({ title: 'Fehler', message: 'Dein Standort konnte nicht ermittelt werden.', icon: 'x' }));
        }
      };

      const triggerBurn = () => { setIsBurning(true); setTimeout(() => { setBurnText(''); setIsBurning(false); setView('dashboard'); }, 2000); };
      
      const insertPrompt = () => {
        const prompt = DEEP_PROMPTS[Math.floor(Math.random() * DEEP_PROMPTS.length)];
        if (editorRef.current) { 
           editorRef.current.focus(); 
           document.execCommand('insertHTML', false, `<br><strong>[Reflexion]</strong> ${prompt}<br><br>`); 
           setText(editorRef.current.innerHTML); 
        }
      };

      const openEditor = (entry = null) => {
        if (entry && entry.id) {
          setEditingId(entry.id); setTitle(entry.title); 
          let initialText = entry.text || '';
          if (initialText && !initialText.includes('<') && (initialText.includes('**') || initialText.includes('*'))) {
              initialText = initialText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
          }
          setText(initialText); setSelectedColor(entry.color); setSelectedImage(entry.image); setSelectedVideo(entry.video);
          setIsLocked(entry.locked); setAudioUrl(entry.audio); setIsManifested(entry.manifested || false);
          setUnlockDate(entry.unlockDate || ''); setUnlockLocation(entry.unlockLocation || null);
          setEntryType(entry.type || 'vision'); setCategory(entry.category || CATEGORIES[0]);
          setMood(entry.mood || null); setLocation(entry.location || null);
          setParentId(entry.parentId || ''); setInheritedFrom(entry.inheritedFrom || null);
        } else {
          setEditingId(null); setTitle(''); setText(''); 
          setSelectedColor(user.isDark ? COLORS[8] : COLORS[1]); 
          setSelectedImage(null); setSelectedVideo(null); setIsLocked(view === 'vault');
          setAudioUrl(null); setIsManifested(false); setUnlockDate(''); setUnlockLocation(null);
          setEntryType('vision'); setCategory(activeCategory === 'Alle' ? CATEGORIES[0] : activeCategory);
          setMood(null); setLocation(null); setParentId(''); setInheritedFrom(null);
        }
        setZenMode(false); setShowEditor(true);
      };

      const startNewChapter = (parent) => {
        setViewingEntry(null);
        setEditingId(null); 
        setTitle(''); 
        setText(''); 
        setSelectedColor(user.isDark ? COLORS[8] : COLORS[1]); 
        setSelectedImage(null); setSelectedVideo(null); 
        setIsLocked(parent.locked || false);
        setAudioUrl(null); setIsManifested(false); setUnlockDate(''); setUnlockLocation(null);
        setEntryType('vision'); 
        setCategory(parent.category || CATEGORIES[0]);
        setMood(null); setLocation(null); 
        setParentId(parent.id); 
        setInheritedFrom(null);
        setZenMode(false); 
        setShowEditor(true);
      };

      const handleVaultClick = async (entry) => {
        if (entry.unlockLocation) {
           if (!("geolocation" in navigator)) { showDialog({ title: 'Fehler', message: 'Ortung nicht verfügbar.', icon: 'x' }); return; }
           navigator.geolocation.getCurrentPosition((pos) => {
             const dist = getDistance(pos.coords.latitude, pos.coords.longitude, entry.unlockLocation.lat, entry.unlockLocation.lng);
             if (dist > 200) { showDialog({ title: 'Blockiert', message: 'Das Orts-Siegel hält stand. Du bist zu weit entfernt. Gehe an den Ursprungsort zurück.', icon: 'lock', iconColor: 'text-rose-500' }); return; } 
             else { triggerUnlock(entry); }
           }, () => { showDialog({ title: 'Fehler', message: 'Dein Ort konnte nicht ermittelt werden.', icon: 'x' }); });
        } else { triggerUnlock(entry); }
      };

      const triggerUnlock = (entry) => {
        if (!user.pin) { showDialog({ title: 'Hinweis', message: 'Bitte richte zuerst eine PIN in den Einstellungen ein.', icon: 'key-round' }); setView('settings'); return; }
        setUnlockTarget(entry); setPinInput(''); setPinError(false); 
      };

      const submitPin = () => {
        if (pinInput === user.pin) { openEditor(unlockTarget); setUnlockTarget(null); } 
        else { setPinError(true); setTimeout(() => setPinError(false), 800); setPinInput(''); }
      };

      const findResonance = () => {
        if (entries.length < 2) return;
        const withMood = entries.filter(e => e.mood && !e.locked);
        if (withMood.length > 0) setEchoEntry(withMood[Math.floor(Math.random() * withMood.length)]);
      };

      const now = new Date();
      
      const visibleEntries = entries.filter(e => {
        const matchesSearch = e.title.toLowerCase().includes(searchQuery.toLowerCase()) || (e.text && e.text.toLowerCase().includes(searchQuery.toLowerCase()));
        const matchesCategory = activeCategory === 'Alle' || e.category === activeCategory;
        if (!matchesSearch || !matchesCategory) return false;
        if (view === 'dashboard') return !e.locked && !e.archived;
        if (view === 'vault') return e.locked && !e.archived;
        if (view === 'archive') return e.archived;
        return false;
      });

      let renderEntries = visibleEntries;

      if (view === 'loading') return <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-graphite-950"><div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div></div>;

      if (view === 'onboarding') {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50 dark:bg-graphite-950 text-slate-900 dark:text-white relative">
            <div className="max-w-md w-full space-y-8 animate-slide-up z-10">
              <div className="text-center space-y-2">
                <Icon name="book-open" size={48} className="mx-auto text-amber-500 mb-6" />
                <h1 className="text-4xl font-extrabold font-serif">Dein Vermächtnis</h1>
                <p className="text-lg opacity-60 font-light">Ein Ort für deine tiefsten Visionen.</p>
              </div>
              <div className="p-8 rounded-[2rem] shadow-xl border bg-white border-slate-200 dark:bg-graphite-900 dark:border-white/10">
                <div className="space-y-6">
                  <div>
                    <label className="block text-xs font-bold opacity-70 mb-3 uppercase tracking-widest">Wie lautet dein Name?</label>
                    <input type="text" value={user.name} onChange={(e) => setUser({...user, name: e.target.value})} className="w-full p-4 rounded-xl border focus:ring-2 focus:ring-amber-500 outline-none text-lg bg-slate-50 border-slate-200 dark:bg-black/20 dark:border-transparent" placeholder="Schreibe hier..." />
                  </div>
                  <button onClick={() => user.name.trim() ? setView('dashboard') : showDialog({ title: 'Name fehlt', message: 'Bitte gib deinen Namen ein.', icon: 'user', iconColor: 'text-amber-500'})} className="w-full py-4 rounded-xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 font-bold text-lg hover:scale-[1.02] transition-transform shadow-md">
                    Journal beginnen
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <ErrorBoundary>
        <div className="min-h-screen">
          
          {/* FOKUS LESE-MODUS (Buch-Ansicht) */}
          {viewingEntry && !showEditor && (() => {
             const currentIndex = renderEntries.findIndex(e => e.id === viewingEntry.id);
             const olderEntry = currentIndex < renderEntries.length - 1 ? renderEntries[currentIndex + 1] : null;
             const newerEntry = currentIndex > 0 ? renderEntries[currentIndex - 1] : null;

             return (
              <div className="fixed inset-0 z-[80] bg-paper-100 dark:bg-graphite-950 overflow-y-auto animate-fade-in custom-scrollbar flex flex-col">
                 <div className="max-w-2xl w-full mx-auto min-h-screen flex flex-col p-6 sm:p-12">
                     
                     <div className="flex justify-between items-center mb-10 pt-4 shrink-0">
                         <button onClick={() => setViewingEntry(null)} className="p-3 bg-white dark:bg-white/5 rounded-full shadow-sm border border-slate-200 dark:border-transparent hover:scale-105 transition-transform"><Icon name="x" size={20}/></button>
                         <button onClick={() => { const e = viewingEntry; setViewingEntry(null); openEditor(e); }} className="px-5 py-2.5 bg-slate-200 dark:bg-white/10 rounded-full font-bold text-sm hover:scale-105 transition-transform">Bearbeiten</button>
                     </div>
                     
                     <div className="flex-1">
                         {viewingEntry.image && <img src={viewingEntry.image} className="w-full rounded-[2rem] mb-10 object-cover shadow-lg border border-slate-200 dark:border-white/5" alt="Vision" />}
                         <h1 className="text-4xl sm:text-5xl font-bold mb-6 leading-tight font-serif">{viewingEntry.title}</h1>
                         <div className="flex flex-wrap gap-4 mb-10 text-xs font-bold uppercase tracking-widest opacity-60">
                             <span className="flex items-center gap-1"><Icon name="calendar" size={14}/> {new Date(viewingEntry.date).toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' })}</span>
                             <span>•</span>
                             <span>{viewingEntry.category}</span>
                             {viewingEntry.mood && (() => {
                                const moodObj = MOODS.find(m=>m.label===viewingEntry.mood);
                                if (!moodObj) return null;
                                return <><span className="mx-2">•</span><span className={`flex items-center gap-1`}><Icon name={moodObj.iconName} size={14}/> {viewingEntry.mood}</span></>
                             })()}
                         </div>
                         <div className="text-lg sm:text-xl leading-relaxed legacy-content pb-10" dangerouslySetInnerHTML={{__html: viewingEntry.text}} />
                         {viewingEntry.audio && <div className="mt-8 mb-10 p-4 rounded-2xl bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10"><audio src={viewingEntry.audio} controls className="w-full" /></div>}
                     </div>

                     {/* BUCH-NAVIGATION */}
                     <div className="flex flex-col gap-6 mt-12 pt-8 border-t border-slate-300 dark:border-white/10 pb-20 shrink-0">
                        
                        <button onClick={() => startNewChapter(viewingEntry)} className="w-full py-4 rounded-2xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 font-bold text-base hover:scale-[1.02] transition-transform shadow-md flex items-center justify-center gap-2">
                           <Icon name="plus" size={20}/> Neue Seite (Weiterblättern)
                        </button>

                        <div className="flex justify-between items-center w-full">
                           {olderEntry ? (
                              <button onClick={() => setViewingEntry(olderEntry)} className="flex items-center gap-3 text-left group flex-1">
                                 <div className="p-3 bg-white dark:bg-white/5 rounded-full shadow-sm border border-slate-200 dark:border-transparent group-hover:scale-105 transition-transform"><Icon name="chevron-left" size={20} /></div>
                                 <div className="overflow-hidden">
                                    <p className="text-[10px] uppercase tracking-widest font-bold opacity-50">Ältere Seite</p>
                                    <p className="text-sm font-medium truncate w-full">{olderEntry.title}</p>
                                 </div>
                              </button>
                           ) : <div className="flex-1" />}
                           
                           {newerEntry ? (
                              <button onClick={() => setViewingEntry(newerEntry)} className="flex items-center justify-end gap-3 text-right group flex-1">
                                 <div className="overflow-hidden">
                                    <p className="text-[10px] uppercase tracking-widest font-bold opacity-50">Neuere Seite</p>
                                    <p className="text-sm font-medium truncate w-full">{newerEntry.title}</p>
                                 </div>
                                 <div className="p-3 bg-white dark:bg-white/5 rounded-full shadow-sm border border-slate-200 dark:border-transparent group-hover:scale-105 transition-transform"><Icon name="chevron-right" size={20} /></div>
                              </button>
                           ) : <div className="flex-1" />}
                        </div>
                     </div>

                 </div>
              </div>
             );
          })()}

          {/* DAS NEUE GLASSMORPHISM DIALOG SYSTEM */}
          {dialog && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-900/60 dark:bg-slate-950/80 backdrop-blur-xl animate-fade-in" onClick={() => { if(dialog.type === 'alert') setDialog(null); }}>
              <div className="w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl border bg-white border-slate-200 dark:bg-graphite-900 dark:border-white/10 animate-scale-in" onClick={e => e.stopPropagation()}>
                {dialog.icon && (
                  <div className="w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-6 shadow-inner bg-slate-50 dark:bg-slate-800">
                    <Icon name={dialog.icon} size={36} className={dialog.iconColor || 'text-indigo-500'} />
                  </div>
                )}
                <h3 className="text-2xl font-bold leading-tight mb-4 font-serif">{dialog.title}</h3>
                <p className="text-base opacity-70 mb-8 leading-relaxed px-2">{dialog.message}</p>
                
                {dialog.type === 'prompt' && (
                  <textarea 
                    autoFocus
                    value={dialog.inputValue || ''}
                    onChange={(e) => setDialog({...dialog, inputValue: e.target.value})}
                    className="w-full p-4 mb-6 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/30 focus:ring-2 focus:ring-amber-500 outline-none resize-none h-32 custom-scrollbar font-serif"
                    placeholder={dialog.placeholder || "Schreibe hier..."}
                  />
                )}

                <div className="flex flex-col gap-3 w-full">
                  <button 
                    className={`w-full py-4 text-white rounded-2xl font-bold shadow-md text-base transition-transform active:scale-95 ${dialog.confirmColor || 'bg-slate-900 dark:bg-white dark:text-slate-900'}`} 
                    onClick={() => { if(dialog.onConfirm) dialog.onConfirm(); else setDialog(null); }}
                  >
                    {dialog.confirmLabel || 'Verstanden'}
                  </button>
                  {dialog.type !== 'alert' && (
                    <button 
                      className="w-full py-4 rounded-2xl font-bold text-base bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 transition-colors active:scale-95" 
                      onClick={() => { if(dialog.onCancel) dialog.onCancel(); else setDialog(null); }}
                    >
                      {dialog.cancelLabel || 'Abbrechen'}
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* CUSTOM PICKER (BOTTOM SHEET) */}
          {picker && (
            <div className="fixed inset-0 z-[250] flex items-end sm:items-center justify-center p-4 sm:p-6 bg-slate-900/60 dark:bg-slate-950/80 backdrop-blur-xl animate-fade-in" onClick={() => setPicker(null)}>
              <div className="w-full max-w-sm rounded-[2.5rem] shadow-2xl border overflow-hidden animate-slide-up flex flex-col max-h-[80vh] bg-white border-slate-200 dark:bg-graphite-900 dark:border-white/10" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b border-slate-100 dark:border-white/10 flex justify-between items-center bg-slate-50 dark:bg-white/5 shrink-0">
                  <h3 className="font-bold text-xl font-serif">{picker.title}</h3>
                  <button onClick={() => setPicker(null)} className="p-2 bg-slate-200 dark:bg-white/10 rounded-full hover:scale-110 transition-transform"><Icon name="x" size={20}/></button>
                </div>
                <div className="overflow-y-auto custom-scrollbar p-3 space-y-1">
                  {picker.options.map(opt => (
                    <button
                      key={opt.value}
                      onClick={() => { picker.onSelect(opt.value); setPicker(null); }}
                      className={`w-full text-left p-4 rounded-2xl transition-all font-bold text-base flex justify-between items-center ${picker.currentValue === opt.value ? 'bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-md' : 'hover:bg-slate-100 dark:hover:bg-white/10'}`}
                    >
                      <span className="truncate">{opt.label}</span>
                      {picker.currentValue === opt.value && <Icon name="check" size={18} />}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* TRESOR PIN MODAL */}
          {unlockTarget && (
            <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => { setUnlockTarget(null); }} />
              <div className="relative w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl animate-scale-in border bg-slate-900 border-white/10 z-10">
                <div className="flex flex-col items-center w-full animate-fade-in">
                  <div className="w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-inner bg-slate-800"><Icon name="lock" size={28} className="text-rose-500" /></div>
                  <h3 className="text-2xl font-bold mb-2 font-serif">Tresor Entsperren</h3>
                  <p className="text-sm opacity-60 mb-6 truncate w-full font-serif">"{unlockTarget.title}"</p>
                  <input type="password" autoFocus value={pinInput} onChange={(e) => setPinInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && submitPin()} className={`w-full p-4 text-center text-2xl tracking-[1em] rounded-xl border-2 outline-none ${pinError ? 'border-rose-500 bg-rose-50/10 animate-shake' : 'bg-black/50 border-transparent focus:border-indigo-500'}`} placeholder="••••" />
                  <div className="flex gap-3 w-full mt-6">
                    <button onClick={() => setUnlockTarget(null)} className="flex-1 py-3 font-medium opacity-60 bg-white/5 rounded-xl hover:bg-white/10">Abbrechen</button>
                    <button onClick={submitPin} className="flex-1 py-3 rounded-xl font-bold text-white bg-rose-600 shadow-md">Öffnen</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          <header className="sticky top-0 z-30 backdrop-blur-xl border-b px-4 py-3 sm:px-6 sm:py-4 transition-all duration-500 flex justify-between items-center bg-white/90 border-slate-200 dark:bg-graphite-950/80 dark:border-white/10 relative">
            <div className="flex items-center gap-3 flex-1 overflow-hidden z-10">
              {view === 'settings' ? <h1 className="text-xl font-bold tracking-tight font-serif">Einstellungen</h1> :
               view === 'menu' ? <h1 className="text-xl font-bold tracking-tight font-serif">Entdecken</h1> :
              (
                <>
                  {user.avatar && <img src={user.avatar} alt="Profil" className="w-10 h-10 rounded-full object-cover border-2 shadow-sm shrink-0" style={{ borderColor: user.nameColor || '#f59e0b' }} />}
                  <div className="flex flex-col overflow-hidden">
                    <h1 className="text-xl font-bold tracking-tight truncate font-serif" style={{ color: user.nameColor || '#f59e0b' }}>
                      {view === 'archive' ? 'Archiv' : user.name}
                    </h1>
                    {view === 'vault' && <p className="text-xs mt-0.5 font-medium flex items-center gap-1 text-rose-500"><Icon name="shield-check" size={14} /> Sicherer Tresor</p>}
                    {view === 'dashboard' && user.motto && <p className="text-[10px] mt-0.5 italic font-medium truncate max-w-[200px] opacity-50">"{user.motto}"</p>}
                  </div>
                </>
              )}
            </div>
            
            <div className="flex gap-1 items-center z-10">
              {view === 'dashboard' && (
                 <>
                   <button onClick={findResonance} className="p-2.5 rounded-full transition-colors bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20" title="Resonanz finden"><Icon name="eye" size={18}/></button>
                   <div className="flex items-center relative">
                      <input type="text" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} placeholder="Suchen..." className={`transition-all duration-300 border-none focus:ring-0 text-sm rounded-full bg-black/5 dark:bg-white/10 text-slate-900 dark:text-white ${isSearchOpen ? 'w-32 px-4 py-2 mr-1 opacity-100' : 'w-0 p-0 opacity-0 pointer-events-none'}`} />
                      <button onClick={() => setIsSearchOpen(!isSearchOpen)} className={`p-2.5 rounded-full transition-colors bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20 ${isSearchOpen ? 'bg-amber-100 text-amber-600' : ''}`}><Icon name="search" size={18}/></button>
                   </div>
                   <button onClick={() => setView('menu')} className="p-2.5 rounded-full transition-colors bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20"><Icon name="menu" size={18}/></button>
                 </>
              )}
              {(view === 'settings' || view === 'menu' || view === 'archive') && <button onClick={() => setView('dashboard')} className="p-2.5 rounded-full border border-transparent bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20"><Icon name="x" size={18} /></button>}
            </div>
          </header>

          <main className="p-4 sm:p-6 max-w-4xl mx-auto min-h-[60vh] relative z-10">
            
            {view === 'menu' && (
              <div className="grid grid-cols-2 gap-4 sm:gap-6 animate-slide-up">
                 <button onClick={() => setView('wisdom')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-sm bg-amber-50 dark:bg-amber-950/20 border-amber-200 dark:border-amber-900/50">
                    <Icon name="book-open" size={32} className="text-amber-500" />
                    <span className="font-bold text-xs">Buch der Weisheit</span>
                 </button>
                 <button onClick={() => setView('symphony')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-sm bg-indigo-50 dark:bg-indigo-950/20 border-indigo-200 dark:border-indigo-900/50">
                    <Icon name="headphones" size={32} className="text-indigo-500" />
                    <span className="font-bold text-xs">Symphonie</span>
                 </button>
                 <button onClick={() => setView('burn')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-sm bg-rose-50 dark:bg-rose-950/20 border-rose-200 dark:border-rose-900/50">
                    <Icon name="flame" size={32} className="text-rose-500" />
                    <span className="font-bold text-xs">Katharsis (Burn)</span>
                 </button>
                 <button onClick={() => setView('galaxy')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-sm bg-white dark:bg-slate-900/50 border-slate-200 dark:border-white/10">
                    <Icon name="orbit" size={32} className="text-slate-800 dark:text-white" />
                    <span className="font-bold text-xs">Galaxie</span>
                 </button>
                 <button onClick={() => setView('archive')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-sm bg-white dark:bg-slate-900/50 border-slate-200 dark:border-white/10">
                    <Icon name="archive" size={32} className="opacity-50" />
                    <span className="font-bold text-xs">Archiv</span>
                 </button>
                 <button onClick={() => setView('settings')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-sm bg-white dark:bg-slate-900/50 border-slate-200 dark:border-white/10">
                    <Icon name="settings" size={32} className="opacity-50" />
                    <span className="font-bold text-xs">Einstellungen</span>
                 </button>
              </div>
            )}

            {view === 'settings' && (
              <div className="space-y-6 animate-slide-up grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div className="p-6 rounded-[2rem] shadow-sm border card-bg">
                  <h2 className="text-lg font-bold mb-6 flex items-center gap-2 font-serif"><Icon name="user" size={20} className="text-amber-500" /> Profil</h2>
                  <div className="flex items-center gap-5 mb-6">
                    <div className="relative shrink-0">
                      <div className="w-20 h-20 rounded-full overflow-hidden border-[3px] shadow-sm flex items-center justify-center bg-slate-100 dark:bg-slate-800 border-slate-200 dark:border-slate-700" style={{ borderColor: user.avatar ? user.nameColor : undefined }}>
                        {user.avatar ? <img src={user.avatar} alt="Avatar" className="w-full h-full object-cover" /> : <Icon name="user" size={32} className="opacity-30" />}
                      </div>
                      <label className="absolute -bottom-1 -right-1 p-2 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-full cursor-pointer shadow-lg hover:scale-110 transition-transform"><Icon name="camera" size={14} /><input type="file" accept="image/*" onChange={handleAvatarUpload} className="hidden" /></label>
                    </div>
                    <div className="flex-1 space-y-3">
                      <input type="text" value={user.name} onChange={(e) => setUser({...user, name: e.target.value})} className="w-full p-3 rounded-xl border-none focus:ring-2 focus:ring-amber-500 text-base font-bold bg-slate-100 dark:bg-black/30 outline-none" placeholder="Dein Name" />
                      <div className="flex gap-2 flex-wrap">
                        {['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#8b5cf6', '#1e293b'].map(color => (
                          <button key={color} onClick={() => setUser({...user, nameColor: color})} className={`w-6 h-6 rounded-full border-2 transition-transform ${user.nameColor === color ? 'border-slate-400 scale-125' : 'border-transparent hover:scale-110'}`} style={{ backgroundColor: color }} />
                        ))}
                      </div>
                    </div>
                  </div>
                  <textarea value={user.motto} onChange={(e) => setUser({...user, motto: e.target.value})} className="w-full p-4 rounded-xl border-none focus:ring-2 focus:ring-amber-500 h-20 resize-none text-sm bg-slate-100 dark:bg-black/30 outline-none italic" placeholder="Dein Lebensmotto..." />
                </div>
                
                <div className="p-6 rounded-[2rem] shadow-sm border bg-white dark:bg-graphite-900 border-slate-200 dark:border-white/10">
                  <h2 className="text-lg font-bold mb-4 flex items-center gap-2 font-serif"><Icon name="archive" size={20} className="text-indigo-500" /> Erscheinungsbild</h2>
                  <div className="flex justify-between items-center p-2 bg-slate-100 dark:bg-black/30 rounded-2xl">
                     <button onClick={() => setUser({...user, isDark: false})} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-sm transition-all ${!user.isDark ? 'bg-white shadow-sm text-slate-900' : 'opacity-50 hover:opacity-100'}`}><Icon name="sun" size={18}/> Hell</button>
                     <button onClick={() => setUser({...user, isDark: true})} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-sm transition-all ${user.isDark ? 'bg-slate-800 shadow-sm text-white' : 'opacity-50 hover:opacity-100'}`}><Icon name="moon" size={18}/> Dunkel</button>
                  </div>
                </div>

                <div className="p-6 rounded-[2rem] shadow-sm border bg-rose-50 dark:bg-rose-950/20 border-rose-100 dark:border-rose-900/50">
                  <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-rose-600 font-serif"><Icon name="key-round" size={20} /> Tresor PIN</h2>
                  {!user.pin ? (
                    <div>
                      <input type="password" value={newPinInput} onChange={(e) => setNewPinInput(e.target.value)} placeholder="Neue PIN (z.B. 4 Zahlen)" className="w-full p-4 rounded-xl border-none focus:ring-2 focus:ring-rose-500 tracking-[0.5em] text-center text-xl mb-4 bg-white dark:bg-black/30 outline-none" />
                      <button onClick={() => { if(newPinInput.length >= 4) { setUser({...user, pin: newPinInput}); setNewPinInput(''); } else showDialog({ title: 'PIN zu kurz', message: 'Die PIN muss mindestens 4 Zeichen lang sein.', icon: 'x' }); }} className="w-full py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold text-sm transition-colors shadow-sm">PIN speichern</button>
                    </div>
                  ) : isChangingPin ? (
                    <div className="space-y-3">
                      <input type="password" value={oldPinInput} onChange={(e) => setOldPinInput(e.target.value)} placeholder="Alte PIN" className="w-full p-3 rounded-xl text-center tracking-[0.5em] text-lg bg-white dark:bg-black/30 outline-none" />
                      <input type="password" value={newPinInput} onChange={(e) => setNewPinInput(e.target.value)} placeholder="Neue PIN" className="w-full p-3 rounded-xl text-center tracking-[0.5em] text-lg bg-white dark:bg-black/30 outline-none" />
                      <div className="flex gap-3">
                        <button onClick={() => setIsChangingPin(false)} className="flex-1 py-3 bg-slate-200 dark:bg-slate-800 rounded-xl text-sm font-bold">Abbrechen</button>
                        <button onClick={() => { if (oldPinInput === user.pin) { setUser({...user, pin: newPinInput}); setIsChangingPin(false); showDialog({ title: 'Erfolg', message: 'PIN erfolgreich geändert.', icon: 'check', iconColor: 'text-emerald-500' }); } else showDialog({ title: 'Fehler', message: 'Die alte PIN ist falsch.', icon: 'x', iconColor: 'text-rose-500' }); }} className="flex-1 py-3 bg-rose-600 text-white rounded-xl text-sm font-bold shadow-sm hover:bg-rose-700">Speichern</button>
                      </div>
                    </div>
                  ) : (
                    <div className="flex justify-between items-center bg-black/5 p-3 rounded-xl border border-transparent">
                      <span className="font-bold text-sm">PIN Aktiv</span>
                      <button onClick={() => setIsChangingPin(true)} className="px-4 py-2 bg-white dark:bg-rose-500/20 shadow-sm transition-colors text-rose-500 rounded-lg font-bold text-xs">Ändern</button>
                    </div>
                  )}
                </div>

                <div className="p-6 rounded-[2rem] shadow-sm border bg-white dark:bg-graphite-900 border-slate-200 dark:border-white/10">
                  <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="sparkles" size={20} className="text-amber-500" /> Lebensstatistik</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-4 rounded-2xl text-center bg-slate-50 dark:bg-black/30 border border-slate-100 dark:border-white/5 shadow-sm">
                      <p className="text-3xl font-black text-indigo-500">{entries.length}</p>
                      <p className="text-xs opacity-60 uppercase tracking-widest mt-1">Erinnerungen</p>
                    </div>
                    <div className="p-4 rounded-2xl text-center bg-amber-50 dark:bg-black/30 border border-amber-100 dark:border-white/5 shadow-sm">
                      <p className="text-3xl font-black text-amber-500">{entries.filter(e => e.manifested).length}</p>
                      <p className="text-xs opacity-60 uppercase tracking-widest mt-1">Manifestiert</p>
                    </div>
                  </div>
                </div>

                <div className="p-6 rounded-[2rem] shadow-sm border space-y-3 bg-indigo-50 dark:bg-indigo-950/20 border-indigo-200 dark:border-indigo-900/50">
                  <h2 className="text-base font-bold mb-1 flex items-center gap-2 text-indigo-600"><Icon name="archive" size={18} /> System</h2>
                  
                  <div className="p-3 bg-white/50 dark:bg-black/30 rounded-xl space-y-2 border border-slate-200 dark:border-transparent shadow-sm">
                     <div className="flex items-center justify-between">
                        <span className="font-medium text-xs">Testament</span>
                        <Icon name="skull" size={14} className="opacity-50" />
                     </div>
                     <select value={user.testamentId || ''} onChange={e => setUser({...user, testamentId: e.target.value})} className="w-full p-2 rounded-lg text-xs bg-white border border-slate-300 dark:bg-white/10 outline-none shadow-sm dark:text-white">
                       <option value="">Kein Testament gewählt</option>
                       {entries.map(e => <option key={e.id} value={e.id}>{e.title.substring(0, 20)}...</option>)}
                     </select>
                  </div>

                  <div className="flex gap-2">
                    <button onClick={exportBackup} className="flex-1 flex items-center justify-center gap-1.5 p-2.5 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700"><Icon name="download" size={14}/> Backup</button>
                    <label className="flex-1 flex items-center justify-center gap-1.5 p-2.5 bg-white text-slate-700 dark:bg-slate-700 dark:text-slate-200 rounded-xl text-xs font-bold cursor-pointer border border-slate-300 dark:border-transparent shadow-sm hover:bg-slate-50">
                      <Icon name="upload" size={14}/> Import
                      <input type="file" accept=".legacy,.json" onChange={importBackup} className="hidden" />
                    </label>
                  </div>
                </div>

              </div>
            )}

            {['dashboard', 'vault', 'archive'].includes(view) && (
              <>
                {view === 'dashboard' && (
                  <div className="flex overflow-x-auto gap-3 pb-4 mb-6 custom-scrollbar snap-x">
                    {['Alle', ...CATEGORIES].map(cat => (
                      <button 
                        key={cat} onClick={() => setActiveCategory(cat)}
                        className={`px-5 py-2.5 rounded-full whitespace-nowrap snap-start text-sm font-bold transition-all ${activeCategory === cat ? 'bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-md' : 'bg-slate-100 border border-slate-200 dark:bg-white/5 dark:border-white/10 opacity-70 hover:opacity-100 dark:text-white'}`}
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                )}

                {visibleEntries.length === 0 && view !== 'menu' && view !== 'settings' && (
                  <div className="flex flex-col items-center justify-center py-32 text-center opacity-30 animate-fade-in">
                    {view === 'vault' ? <Icon name="shield-check" size={64} className="mb-6"/> : view === 'archive' ? <Icon name="archive" size={64} className="mb-6"/> : <Icon name="book-open" size={64} className="mb-6"/>}
                    <p className="text-xl font-bold font-serif">
                      {view === 'vault' ? 'Tresor leer.' : view === 'archive' ? 'Archiv leer.' : 'Dein Buch ist noch leer.'}
                    </p>
                  </div>
                )}

                <div className="columns-1 sm:columns-2 gap-6 space-y-6 pb-20">
                  {renderEntries.map(entry => {
                    const isCapsuleLocked = entry.unlockDate && new Date(entry.unlockDate) > now;
                    const isGeoLocked = entry.unlockLocation;
                    
                    if (view === 'vault' || isCapsuleLocked || isGeoLocked) {
                      return (
                        <div 
                          key={entry.id} onClick={() => (!isCapsuleLocked || isGeoLocked) && handleVaultClick(entry)}
                          className="break-inside-avoid relative rounded-[2rem] p-6 shadow-sm transition-all cursor-pointer border flex flex-col justify-between items-center text-center aspect-square flex justify-center card-bg hover:shadow-md"
                        >
                          <div className={`p-5 rounded-full mb-6 ${isCapsuleLocked ? 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-500' : isGeoLocked ? 'bg-emerald-100 dark:bg-emerald-900/50 text-emerald-500' : 'bg-rose-100 dark:bg-rose-900/50 text-rose-500'}`}>
                            {isCapsuleLocked ? <Icon name="calendar-clock" size={40} /> : isGeoLocked ? <Icon name="map-pin" size={40} /> : <Icon name="lock" size={40} />}
                          </div>
                          <div className="w-full px-2">
                            <h3 className="font-bold text-xl tracking-tight leading-snug truncate font-serif">{entry.title}</h3>
                            <span className="text-[10px] opacity-50 uppercase tracking-widest mt-2 block truncate font-medium">
                              {isCapsuleLocked ? `Öffnet ${new Date(entry.unlockDate).toLocaleDateString('de-DE')}` : isGeoLocked ? 'Orts-Siegel' : 'Verwahrt'}
                            </span>
                          </div>
                        </div>
                      );
                    }

                    const isDarkTheme = user.isDark;
                    const entryColor = entry.color || (isDarkTheme ? COLORS[8] : COLORS[1]);
                    
                    let cardBg = entryColor;
                    if (isDarkTheme && entryColor === '#ffffff') cardBg = '#18181b';
                    if (!isDarkTheme && entryColor === '#0f172a') cardBg = '#ffffff';

                    const borderStyle = isDarkTheme ? (cardBg === '#18181b' ? 'border-white/10' : 'border-white/5') : 'border-slate-200';

                    return (
                      <div 
                        key={entry.id} onClick={() => view === 'dashboard' ? setViewingEntry(entry) : null}
                        className={`break-inside-avoid group relative rounded-[2.5rem] shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden cursor-pointer border ${borderStyle} ${entry.manifested ? 'ring-2 ring-amber-400/50' : ''}`}
                        style={{ backgroundColor: cardBg, color: isDarkTheme ? '#f8fafc' : '#0f172a' }}
                      >
                        {entry.inheritedFrom && (
                          <div className="absolute top-4 left-4 z-30 bg-black/80 text-amber-400 text-[9px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1 backdrop-blur-md">
                            <Icon name="git-merge" size={12}/> Von {entry.inheritedFrom.split(' ')[0]}
                          </div>
                        )}
                        {entry.manifested && (
                          <div className="absolute top-4 right-4 z-30 bg-amber-500 text-slate-900 text-[9px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
                            <Icon name="sparkles" size={12}/> Manifestiert
                          </div>
                        )}
                        
                        {entry.image && (
                          <div className="w-full relative overflow-hidden bg-slate-100 dark:bg-black/20 flex justify-center items-center min-h-[200px]">
                            <img src={entry.image} alt="Vision" className="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-1000" />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/10 to-transparent z-10 pointer-events-none" />
                            <h3 className="absolute bottom-6 left-6 right-6 z-20 font-bold text-2xl text-white drop-shadow-md leading-snug line-clamp-2 font-serif">{entry.title}</h3>
                          </div>
                        )}

                        <div className="p-6 sm:p-8 flex-1 flex flex-col">
                          {!entry.image && <h3 className={`font-bold text-2xl leading-tight mb-4 line-clamp-2 font-serif`}>{entry.title}</h3>}
                          
                          {entry.type === 'letter' && <div className="mb-4 text-[10px] font-bold uppercase tracking-widest opacity-50 flex items-center gap-1"><Icon name="quote" size={12}/> Brief an die Zukunft</div>}
                          
                          {entry.text && (
                            <div className={`text-sm leading-relaxed mb-6 font-medium line-clamp-4 legacy-content opacity-80`} dangerouslySetInnerHTML={{ __html: entry.text }} />
                          )}

                          <div className={`flex flex-wrap items-center justify-between pt-4 border-t mt-auto ${isDarkTheme ? 'border-white/10' : 'border-black/10'}`}>
                            <div className="flex flex-col">
                               <span className={`text-[10px] font-bold uppercase tracking-widest opacity-60`}>
                                 {new Date(entry.date).toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' })}
                               </span>
                            </div>
                            
                            <div className="flex gap-2 items-center opacity-60">
                              {entry.mood && (() => {
                                 const moodObj = MOODS.find(m=>m.label===entry.mood);
                                 if (!moodObj) return null;
                                 return <Icon name={moodObj.iconName} size={16} className={moodObj.color} />;
                              })()}
                              {entry.location && <Icon name="map-pin" size={16} />}
                              {(entry.audio || entry.video) && <Icon name="mic" size={16} />}
                              
                              {view === 'archive' && (
                                <div className="flex gap-2 ml-2">
                                  <button onClick={(e) => { e.stopPropagation(); setEntries(prev => prev.map(ex => ex.id === entry.id ? { ...ex, archived: false } : ex)); }} className={`p-2 rounded-full bg-black/5 dark:bg-white/10`}><Icon name="rotate-ccw" size={16} /></button>
                                  <button onClick={(e) => { e.stopPropagation(); confirmArchiveDelete(entry.id); }} className="p-2 rounded-full bg-rose-500/10 text-rose-500"><Icon name="trash-2" size={16} /></button>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}
          </main>

          {/* EDITOR OVERLAY */}
          {showEditor && (
            <div className="fixed inset-0 z-[100] flex items-end sm:items-center justify-center sm:p-6 transition-all bg-slate-900/40 dark:bg-slate-950/80 backdrop-blur-md">
              <div className="absolute inset-0 bg-transparent" onClick={() => checkSaveEntry()} />
              
              <div 
                className="relative w-full max-w-3xl mx-auto flex flex-col shadow-2xl transition-all h-[100dvh] sm:rounded-none bg-white dark:bg-graphite-900 sm:h-[90dvh] max-h-[900px] rounded-t-[2rem] sm:rounded-[2.5rem] border border-slate-200 dark:border-white/10"
                style={{ backgroundColor: zenMode ? 'transparent' : (user.isDark && selectedColor === '#ffffff' ? '#18181b' : selectedColor) }}
              >
                <div className={`flex justify-between items-center px-6 py-5 border-b ${zenMode ? 'border-transparent' : 'border-black/5 dark:border-white/5'}`}>
                  <button onClick={() => checkSaveEntry()} className={`p-2 rounded-full transition-colors ${user.isDark ? 'text-white hover:bg-white/10' : 'text-slate-900 hover:bg-black/5'}`}><Icon name="chevron-down" size={24}/></button>
                  
                  {!zenMode && (
                    <div className="flex gap-2 overflow-x-auto hide-scrollbar items-center">
                      {autoSaveStatus && <span className="flex items-center text-xs font-bold text-emerald-500 animate-pulse mr-2"><Icon name="check" size={14} className="mr-1"/> {autoSaveStatus}</span>}
                      
                      {editingId && <button onClick={() => confirmDelete(editingId)} className="p-2.5 rounded-full hover:bg-rose-500/10 opacity-50 hover:opacity-100 text-rose-500 transition-colors" title="Seite herausreißen"><Icon name="trash-2" size={20}/></button>}
                      
                      <button onClick={() => setZenMode(true)} className={`p-2.5 rounded-full opacity-50 hover:opacity-100 transition-colors ${user.isDark ? 'text-white hover:bg-white/10' : 'text-slate-900 hover:bg-black/5'}`} title="Fokus Modus"><Icon name="maximize-2" size={20}/></button>
                    </div>
                  )}
                  {zenMode && <button onClick={() => setZenMode(false)} className="text-current opacity-50 hover:opacity-100"><Icon name="minimize-2" size={24}/></button>}

                  <button onClick={checkSaveEntry} className={`px-6 py-2.5 rounded-full font-bold shadow-md hover:scale-105 transition-transform text-sm ${user.isDark ? 'bg-white text-slate-900' : 'bg-slate-900 text-white'}`}>Sichern</button>
                </div>

                <div className={`flex-1 overflow-y-auto p-6 sm:p-10 flex flex-col gap-6 custom-scrollbar w-full ${zenMode ? '' : user.isDark ? 'text-white' : 'text-slate-900'}`}>
                  
                  {!zenMode && (
                    <div className="flex flex-wrap gap-3 text-xs font-bold uppercase tracking-widest opacity-60 shrink-0">
                      <button onClick={() => setPicker({
                          title: 'Kategorie', currentValue: category, options: CATEGORIES.map(c => ({label: c, value: c})), onSelect: setCategory
                      })} className="bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20 transition-colors px-3 py-1.5 rounded-lg flex items-center gap-2">
                        {category} <Icon name="chevron-down" size={14} className="shrink-0"/>
                      </button>
                      
                      <button onClick={() => setPicker({
                          title: 'Art des Eintrags', currentValue: entryType, options: [{label: 'Vision', value: 'vision'}, {label: 'Brief an die Zukunft', value: 'letter'}], onSelect: setEntryType
                      })} className="bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20 transition-colors px-3 py-1.5 rounded-lg flex items-center gap-2">
                        {entryType === 'vision' ? 'Vision' : 'Brief'} <Icon name="chevron-down" size={14} className="shrink-0"/>
                      </button>
                    </div>
                  )}

                  <input type="text" placeholder="Titel..." value={title} onChange={(e) => setTitle(e.target.value)} className="w-full shrink-0 bg-transparent text-4xl sm:text-5xl font-bold placeholder-current opacity-90 border-none focus:ring-0 p-0 focus:outline-none font-serif" style={{'::placeholder': { opacity: 0.3 }}} />
                  
                  {!zenMode && (
                    <div className="flex gap-2 py-3 border-y border-current border-opacity-10 opacity-70 shrink-0">
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('bold', false, null); }} className="p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition-colors" title="Fett"><Icon name="bold" size={18}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('italic', false, null); }} className="p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition-colors" title="Kursiv"><Icon name="italic" size={18}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('insertUnorderedList', false, null); }} className="p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition-colors"><Icon name="list-todo" size={18}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('formatBlock', false, 'blockquote'); }} className="p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition-colors" title="Zitat / Weisheit"><Icon name="quote" size={18}/></button>
                    </div>
                  )}

                  <div 
                    ref={editorRef}
                    contentEditable={true}
                    suppressContentEditableWarning={true}
                    data-placeholder="Schreibe deine Gedanken auf diese leere Seite..."
                    onInput={(e) => {
                       setText(e.currentTarget.innerHTML);
                    }}
                    className="w-full flex-1 min-h-[300px] bg-transparent text-lg sm:text-xl leading-relaxed focus:outline-none font-medium empty:before:content-[attr(data-placeholder)] empty:before:cursor-text legacy-editor-content pb-20"
                    style={{'::before': { opacity: 0.3 }}}
                  />

                  {!zenMode && (
                    <div className="space-y-4 shrink-0 pb-6">
                      {selectedImage && <div className="relative rounded-[2rem] overflow-hidden shadow-md bg-black/5 dark:bg-black/20 flex justify-center"><img src={selectedImage} alt="Preview" className="w-full h-auto max-h-[40vh] object-cover" /><button onClick={() => setSelectedImage(null)} className="absolute top-4 right-4 bg-white/80 dark:bg-black/60 backdrop-blur-md p-3 rounded-full hover:scale-110 transition-transform"><Icon name="x" size={18}/></button></div>}
                    </div>
                  )}
                </div>

                {!zenMode && (
                  <div className="border-t border-black/5 dark:border-white/5 bg-white/50 dark:bg-black/40 backdrop-blur-2xl p-4 sm:p-6 flex flex-col gap-4 pb-[env(safe-area-inset-bottom,24px)]">
                    
                    <div className="flex justify-between items-center overflow-x-auto hide-scrollbar gap-4">
                      <div className="flex gap-2 shrink-0">
                        <label className={`p-3.5 rounded-full shadow-sm cursor-pointer transition-colors ${user.isDark ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-white hover:bg-slate-50 text-slate-800 border border-slate-200'}`}><Icon name="image" size={20}/><input type="file" accept="image/*" onChange={(e)=>handleFileUpload(e,'image')} className="hidden" /></label>
                        <button onClick={() => setIsDrawing(true)} className={`p-3.5 rounded-full shadow-sm transition-colors ${user.isDark ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-white hover:bg-slate-50 text-slate-800 border border-slate-200'}`}><Icon name="pen-tool" size={20}/></button>
                      </div>
                      
                      <div className={`flex gap-2 shrink-0 border-l pl-4 ${user.isDark ? 'border-white/10' : 'border-black/10'}`}>
                        <label className={`relative p-3.5 rounded-full shadow-sm flex items-center justify-center cursor-pointer overflow-hidden transition-colors ${unlockDate ? 'bg-indigo-500 text-white' : user.isDark ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-white hover:bg-slate-50 text-slate-800 border border-slate-200'}`}>
                          <Icon name="calendar-clock" size={20}/>
                          <input type="date" value={unlockDate} onChange={e=>setUnlockDate(e.target.value)} className="absolute opacity-0 w-[200%] h-[200%] -top-1/2 -left-1/2 cursor-pointer" />
                        </label>
                        <button onClick={() => setIsLocked(!isLocked)} className={`p-3.5 rounded-full shadow-sm transition-colors ${isLocked ? 'bg-rose-500 text-white' : user.isDark ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-white hover:bg-slate-50 text-slate-800 border border-slate-200'}`}><Icon name="lock" size={20}/></button>
                      </div>
                    </div>

                    <div className={`flex justify-between items-center overflow-x-auto hide-scrollbar gap-6 border-t pt-4 ${user.isDark ? 'border-white/5' : 'border-black/5'}`}>
                      <div className="flex gap-2 shrink-0">
                         {MOODS.map(m => (
                           <button key={m.id} onClick={()=>setMood(m.label===mood ? null : m.label)} className={`p-2.5 rounded-full transition-all ${mood===m.label ? 'bg-slate-800 dark:bg-white shadow-lg scale-110 ' + m.color : 'opacity-40 hover:opacity-100 text-current'}`}>
                             <Icon name={m.iconName} size={20} />
                           </button>
                         ))}
                      </div>
                      <div className="flex gap-2 shrink-0">
                        {COLORS.slice(0, 18).map((c) => (
                          <button key={c} onClick={() => setSelectedColor(c)} className={`w-8 h-8 rounded-full shadow-sm border-2 transition-transform ${selectedColor === c ? 'scale-110 border-current z-10' : 'border-transparent opacity-60 hover:opacity-100 hover:scale-105'}`} style={{ backgroundColor: c }} />
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* DRAWING MODAL */}
          {isDrawing && (
            <div className="fixed inset-0 z-[120] flex flex-col bg-slate-900 text-white">
              <div className="flex justify-between items-center p-6 border-b border-white/10 bg-slate-950">
                <button onClick={() => setIsDrawing(false)} className="p-3 text-white/70 hover:text-white bg-white/5 rounded-full"><Icon name="x" size={24} /></button>
                <span className="font-bold text-xl font-serif">Skizze</span>
                <button 
                  onClick={() => {
                     if(canvasRef.current) {
                       setSelectedImage(canvasRef.current.toDataURL());
                       setIsDrawing(false);
                     }
                  }} 
                  className="bg-amber-500 text-slate-900 px-6 py-3 rounded-full font-bold flex gap-2 items-center shadow-lg"
                >
                  <Icon name="check" size={18}/> Fertig
                </button>
              </div>
              <div className="flex-1 relative bg-white touch-none">
                <canvas 
                  ref={canvasRef} 
                  className="absolute inset-0 w-full h-full cursor-crosshair touch-none"
                  onMouseDown={startDrawing}
                  onMouseMove={draw}
                  onMouseUp={stopDrawing}
                  onMouseLeave={stopDrawing}
                  onTouchStart={startDrawing}
                  onTouchMove={draw}
                  onTouchEnd={stopDrawing}
                />
              </div>
              <div className="p-4 bg-slate-950 flex justify-center">
                 <button onClick={() => { 
                   if (!canvasRef.current) return;
                   const canvas = canvasRef.current; 
                   const ctx = canvas.getContext('2d'); 
                   ctx.save();
                   ctx.setTransform(1, 0, 0, 1, 0, 0);
                   ctx.fillStyle = user.isDark ? '#18181b' : '#ffffff'; 
                   ctx.fillRect(0, 0, canvas.width, canvas.height); 
                   ctx.restore();
                 }} className="p-3 bg-white/10 rounded-full hover:bg-white/20 text-white"><Icon name="eraser" size={24}/></button>
              </div>
            </div>
          )}

          <nav className="fixed bottom-0 left-0 right-0 backdrop-blur-3xl border-t z-40 transition-colors duration-500 bg-white/90 border-slate-200 dark:bg-graphite-950/90 dark:border-white/10 pb-[env(safe-area-inset-bottom,0px)]">
            <div className="flex justify-between items-center h-20 max-w-md mx-auto px-8">
              <button onClick={() => setView('dashboard')} className={`flex flex-col items-center justify-center h-full space-y-1 transition-all ${view === 'dashboard' ? 'text-amber-500 scale-105' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}><Icon name="layout-grid" size={24} /><span className="text-[10px] font-bold uppercase tracking-widest">Buch</span></button>
              
              <div className="relative -top-6">
                <button onClick={() => openEditor()} className="w-16 h-16 rounded-full shadow-xl flex items-center justify-center hover:scale-105 active:scale-95 text-white border-[4px] border-slate-50 dark:border-graphite-950 transition-transform duration-300 bg-slate-900 dark:bg-white dark:text-slate-900"><Icon name="plus" size={32} /></button>
              </div>
              
              <button onClick={() => setView('vault')} className={`flex flex-col items-center justify-center h-full space-y-1 transition-all ${view === 'vault' ? 'text-indigo-500 scale-105' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}><Icon name="lock" size={24} /><span className="text-[10px] font-bold uppercase tracking-widest">Tresor</span></button>
            </div>
          </nav>
          
        </div>
        </ErrorBoundary>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
