<!DOCTYPE html>
<html lang="de" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Legacy Vision Journal</title>
  
  <!-- PWA & Standalone App Setup -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">
  
  <link rel="manifest" href="manifest.json">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel für JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* PURE DARK MODE - Kein Zurück, keine Überschreibungen durch Samsung */
    :root { color-scheme: dark !important; }
    
    body { 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      background-color: #020617 !important; 
      color: #f8fafc !important;
    }
    
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 24px); }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
    @keyframes slide-up { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } } .animate-scale-in { animation: scale-in 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } } .animate-shake { animation: shake 0.4s ease-in-out; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; } .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    .hide-scrollbar::-webkit-scrollbar { display: none; } .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .legacy-editor-content ul, .legacy-content ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .legacy-editor-content li, .legacy-content li { margin-bottom: 0.25rem; }
    .legacy-editor-content b, .legacy-editor-content strong, .legacy-content b, .legacy-content strong { font-weight: bold; color: white; }
    .legacy-editor-content i, .legacy-editor-content em, .legacy-content i, .legacy-content em { font-style: italic; }
    .legacy-editor-content blockquote, .legacy-content blockquote { border-left: 4px solid #f59e0b; padding-left: 1rem; margin-left: 0; font-style: italic; opacity: 0.9; background: rgba(245, 158, 11, 0.1); padding: 0.5rem 1rem; border-radius: 0 8px 8px 0; }
    [contenteditable="true"]:empty:before { content: attr(data-placeholder); opacity: 0.3; pointer-events: none; display: block; color: #cbd5e1; }

    html, body, #root { width: 100%; height: 100%; overflow-x: hidden; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const safeStorageGet = (key) => {
      try { return localStorage.getItem(key); } catch(e) { return null; }
    };
    const safeStorageSet = (key, val) => {
      try { localStorage.setItem(key, val); } catch(e) {}
    };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      componentDidCatch(error, errorInfo) { console.error("App Crash:", error, errorInfo); }
      render() { 
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white p-8 text-center">
              <div>
                <h1 className="text-2xl font-bold text-rose-500 mb-4">Ein Moment bitte...</h1>
                <p className="opacity-70 mb-8">Die App hat sich beim Laden verschluckt. Bitte öffne den Link direkt im Browser neu.</p>
                <button onClick={() => window.location.reload()} className="px-6 py-3 bg-amber-500 text-slate-900 font-bold rounded-xl shadow-lg">Neu laden</button>
              </div>
            </div>
          );
        }
        return this.props.children; 
      }
    }

    const Icon = ({ name, size = 24, className = '', ...props }) => {
      const spanRef = useRef(null);
      useEffect(() => {
        const renderIcon = () => {
          if (spanRef.current && window.lucide) {
            spanRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
            window.lucide.createIcons({ root: spanRef.current });
            const svg = spanRef.current.querySelector('svg');
            if (svg) {
              svg.setAttribute('width', size);
              svg.setAttribute('height', size);
              if (className) svg.setAttribute('class', `lucide lucide-${name} ${className}`);
            }
          }
        };
        if (window.lucide) renderIcon();
        else setTimeout(renderIcon, 100);
      }, [name, size, className]);

      return <span ref={spanRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} {...props}></span>;
    };

    const COLORS = [
      '#1f2937', '#111827', '#0f172a', '#374151', '#475569', '#334155',
      '#7f1d1d', '#991b1b', '#78350f', '#92400e', '#14532d', '#166534',
      '#1e3a8a', '#1e40af', '#4c1d95', '#5b21b6', '#831843', '#9d174d'
    ];

    const CATEGORIES = ['Allgemein', 'Familie', 'Karriere', 'Seele', 'Gesundheit', 'Finanzen'];
    const MOODS = [
      { id: 'smile', label: 'Strahlend', color: 'text-amber-500' },
      { id: 'heart', label: 'Liebevoll', color: 'text-rose-500' },
      { id: 'coffee', label: 'Fokussiert', color: 'text-amber-700' },
      { id: 'cloud-lightning', label: 'Stürmisch', color: 'text-indigo-500' },
      { id: 'frown', label: 'Nachdenklich', color: 'text-slate-400' }
    ];

    const DEEP_PROMPTS = [
      "Wofür bist du heute am tiefsten dankbar?",
      "Welche Angst hat dich heute zurückgehalten?",
      "Was würdest du deinem 10 Jahre jüngeren Ich heute sagen?",
      "Was ist dein größter Traum, den du dich noch nicht traust auszusprechen?",
      "Welchen Meilenstein möchtest du in genau einem Jahr erreicht haben?"
    ];

    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    const getDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371e3; 
      const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180;
      const dp = (lat2-lat1) * Math.PI/180, dl = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    };

    const initDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('LegacyVisionDB', 3);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('entries')) db.createObjectStore('entries', { keyPath: 'id' });
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    };

    const App = () => {
      const [db, setDb] = useState(null);
      const [entries, setEntries] = useState([]);
      const [user, setUser] = useState({ name: '', motto: '', pin: '', avatar: null, nameColor: '#f59e0b', testamentId: null });
      const [view, setView] = useState('loading'); 
      const [isLoaded, setIsLoaded] = useState(false);
      
      const [searchQuery, setSearchQuery] = useState('');
      const [activeCategory, setActiveCategory] = useState('Alle');
      const [isSearchOpen, setIsSearchOpen] = useState(false);
      
      // DAS NEUE GLASSMORPHISM DIALOG SYSTEM
      const [dialog, setDialog] = useState(null);
      const [installHint, setInstallHint] = useState('');
      
      const [showEditor, setShowEditor] = useState(false);
      const [affirmation, setAffirmation] = useState(null);
      const [echoEntry, setEchoEntry] = useState(null);
      
      // Security State
      const [unlockTarget, setUnlockTarget] = useState(null);
      const [pinInput, setPinInput] = useState('');
      const [pinError, setPinError] = useState(false);
      const [isChangingPin, setIsChangingPin] = useState(false);
      const [oldPinInput, setOldPinInput] = useState('');
      const [newPinInput, setNewPinInput] = useState('');

      // Editor State
      const [editingId, setEditingId] = useState(null);
      const [title, setTitle] = useState('');
      const [text, setText] = useState('');
      const [selectedColor, setSelectedColor] = useState(COLORS[2]);
      const [selectedImage, setSelectedImage] = useState(null);
      const [selectedVideo, setSelectedVideo] = useState(null);
      const [isLocked, setIsLocked] = useState(false);
      const [audioUrl, setAudioUrl] = useState(null);
      const [isManifested, setIsManifested] = useState(false);
      const [unlockDate, setUnlockDate] = useState(''); 
      const [unlockLocation, setUnlockLocation] = useState(null); 
      const [entryType, setEntryType] = useState('vision');
      const [category, setCategory] = useState(CATEGORIES[0]);
      const [mood, setMood] = useState(null);
      const [location, setLocation] = useState(null);
      const [parentId, setParentId] = useState(''); 
      const [zenMode, setZenMode] = useState(false);
      const [inheritedFrom, setInheritedFrom] = useState(null); 

      const [isDrawing, setIsDrawing] = useState(false);
      const canvasRef = useRef(null);
      const editorRef = useRef(null); 
      const [autoSaveStatus, setAutoSaveStatus] = useState('');
      const [burnText, setBurnText] = useState('');
      const [isBurning, setIsBurning] = useState(false);
      const [symphonyIndex, setSymphonyIndex] = useState(0);
      const audioPlayerRef = useRef(null);
      
      const [isRecording, setIsRecording] = useState(false);
      const [isDictating, setIsDictating] = useState(false);
      const mediaRecorderRef = useRef(null);
      const dictationRef = useRef(null);

      const viewRef = useRef(view);
      const editorRefState = useRef(showEditor);
      const closeEditorRef = useRef(null);

      useEffect(() => { viewRef.current = view; }, [view]);
      useEffect(() => { editorRefState.current = showEditor; }, [showEditor]);

      // Hilfsfunktion für den neuen Dialog
      const showDialog = (options) => {
         setDialog({
             type: 'alert',
             confirmLabel: 'Verstanden',
             ...options
         });
      };

      const closeEditor = () => {
        setShowEditor(false);
        if (isRecording) stopRecording();
        if (isDictating) toggleDictation();
      };

      useEffect(() => {
        closeEditorRef.current = closeEditor;
      });

      useEffect(() => {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
        if (!isStandalone) {
          if (window.location.protocol.includes('file') || window.location.protocol.includes('content')) {
             setInstallHint("Tipp: Du hast die Datei lokal geöffnet (Datenbank blockiert!). Rufe deinen GitHub-Link auf und installiere sie von dort!");
          }
        }
      }, []);

      useEffect(() => {
        if (!isLoaded) return;
        window.history.pushState({ locked: true }, '');

        const handlePopState = (e) => {
          window.history.pushState({ locked: true }, '');

          if (editorRefState.current && closeEditorRef.current) {
            closeEditorRef.current();
          } else if (viewRef.current !== 'dashboard' && viewRef.current !== 'loading' && viewRef.current !== 'onboarding') {
            setView('dashboard');
          } else if (viewRef.current === 'dashboard') {
            showDialog({
                type: 'confirm',
                title: 'Journal verlassen?',
                message: 'Möchtest du das Vermächtnis wirklich verlassen?',
                icon: 'log-out',
                iconColor: 'text-rose-500',
                confirmLabel: 'Verlassen',
                confirmColor: 'bg-rose-600',
                onConfirm: () => { window.location.href = "about:blank"; }
            });
          }
        };

        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, [isLoaded]);

      useEffect(() => {
        const loadApp = async () => {
          try {
            const savedUser = safeStorageGet('legacy_user');
            let currentUser = { name: '', motto: '', pin: '', avatar: null, nameColor: '#f59e0b', testamentId: null };
            if (savedUser) {
              const parsed = JSON.parse(savedUser);
              if (parsed.isDark !== undefined) delete parsed.isDark;
              currentUser = { ...currentUser, ...parsed };
              setUser(currentUser);
            }

            try {
                const database = await initDB();
                setDb(database);
                
                const transaction = database.transaction('entries', 'readonly');
                const request = transaction.objectStore('entries').getAll();
                
                request.onsuccess = () => {
                  let loadedEntries = request.result || [];
                  const lastActiveStr = safeStorageGet('legacy_last_active');
                  const lastActive = lastActiveStr ? new Date(lastActiveStr) : new Date();
                  const daysInactive = (new Date() - lastActive) / (1000 * 60 * 60 * 24);
                  
                  safeStorageSet('legacy_last_active', new Date().toISOString());

                  setEntries(loadedEntries.sort((a,b) => new Date(b.date) - new Date(a.date)));
                  setIsLoaded(true);

                  if (!currentUser.name) {
                    setView('onboarding');
                  } else if (currentUser.testamentId && daysInactive > 365) {
                    setView('testament'); 
                  } else {
                    setView('dashboard');
                    checkDailyAffirmation(loadedEntries);
                  }
                };
            } catch (dbError) {
                console.error("IndexedDB blocked", dbError);
                showDialog({
                   title: 'Datenbank blockiert',
                   message: 'Dein Browser blockiert den Speicher. Nutze Chrome für den vollen Umfang!',
                   icon: 'alert-triangle',
                   iconColor: 'text-amber-500'
                });
                setIsLoaded(true);
                if (!currentUser.name) setView('onboarding');
                else setView('dashboard');
            }
          } catch (e) {
            console.error("Critical Boot Error", e);
            setIsLoaded(true);
            setView('onboarding');
          }
        };
        loadApp();
      }, []);

      const checkDailyAffirmation = (allEntries) => {
        const today = new Date().toDateString();
        if (safeStorageGet('legacy_last_affirmation') !== today && allEntries.length > 0) {
          const publicEntries = allEntries.filter(e => !e.locked && !e.archived);
          if (publicEntries.length > 0) {
            setAffirmation(publicEntries[Math.floor(Math.random() * publicEntries.length)]);
            safeStorageSet('legacy_last_affirmation', today);
          }
        }
      };

      useEffect(() => {
        if (isLoaded) {
           safeStorageSet('legacy_user', JSON.stringify(user));
        }
      }, [user, isLoaded]);

      const saveToDB = async (entry) => {
        try {
            if (db) {
              const tx = db.transaction('entries', 'readwrite');
              tx.objectStore('entries').put(entry);
              tx.oncomplete = () => {
                setEntries(prev => {
                  const exists = prev.find(e => e.id === entry.id);
                  if (exists) return prev.map(e => e.id === entry.id ? entry : e);
                  return [entry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
                });
              };
            } else {
              setEntries(prev => {
                  const exists = prev.find(e => e.id === entry.id);
                  if (exists) return prev.map(e => e.id === entry.id ? entry : e);
                  return [entry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
              });
            }
        } catch (e) {
            console.error("Save Error", e);
        }
      };

      // --- DER NEUE SPEICHER-WÄCHTER ---
      const checkSaveEntry = () => {
        const executeSave = () => {
            const newEntry = {
              id: editingId || generateId(),
              title: title || 'Ohne Titel', text, color: selectedColor,
              image: selectedImage, video: selectedVideo, audio: audioUrl,
              locked: isLocked, archived: false, manifested: isManifested,
              unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
              date: editingId ? (entries.find(e => e.id === editingId)?.date || new Date().toISOString()) : new Date().toISOString(),
            };
            saveToDB(newEntry);
            closeEditor();
        };

        const isEmpty = !title.trim() && !text.replace(/<[^>]*>?/gm, '').trim() && !selectedImage && !selectedVideo && !audioUrl;
        
        if (isEmpty && unlockDate) {
            showDialog({
                type: 'confirm',
                title: 'Leeres Datums-Siegel?',
                message: 'Du hast ein Datum im Kalender ausgewählt, aber keinen Text geschrieben. Möchtest du diese leere Kapsel wirklich versiegeln?',
                icon: 'calendar-clock',
                iconColor: 'text-indigo-400',
                confirmLabel: 'Trotzdem speichern',
                confirmColor: 'bg-indigo-500 hover:bg-indigo-600',
                cancelLabel: 'Abbrechen',
                onConfirm: () => { executeSave(); setDialog(null); }
            });
        } else if (isEmpty && !editingId) {
            // Neuer, komplett leerer Eintrag
            showDialog({
                type: 'confirm',
                title: 'Leerer Gedanke',
                message: 'Dein Eintrag enthält noch keinen Inhalt. Möchtest du ihn trotzdem speichern oder den Vorgang abbrechen?',
                icon: 'file-question',
                iconColor: 'text-slate-400',
                confirmLabel: 'Speichern',
                confirmColor: 'bg-slate-700 hover:bg-slate-600',
                cancelLabel: 'Verwerfen',
                onCancel: () => { closeEditor(); setDialog(null); },
                onConfirm: () => { executeSave(); setDialog(null); }
            });
        } else {
            executeSave();
        }
      };

      // --- DER NEUE LÖSCH-WÄCHTER ---
      const confirmDelete = (id) => {
        showDialog({
            type: 'confirm',
            title: 'Vision vernichten?',
            message: 'Bist du sicher, dass du diesen Gedanken für immer aus deinem Vermächtnis löschen möchtest? Dieser Schritt kann nicht rückgängig gemacht werden.',
            icon: 'trash-2',
            iconColor: 'text-rose-500',
            confirmLabel: 'Ja, löschen',
            confirmColor: 'bg-rose-600 hover:bg-rose-700',
            onConfirm: () => {
                deleteFromDB(id);
                closeEditor();
                setDialog(null);
            }
        });
      };

      const confirmArchiveDelete = (id) => {
        showDialog({
            type: 'confirm',
            title: 'Endgültig löschen?',
            message: 'Dieser Eintrag wird unwiderruflich aus dem Archiv gelöscht. Es gibt kein Zurück.',
            icon: 'alert-triangle',
            iconColor: 'text-rose-500',
            confirmLabel: 'Vernichten',
            confirmColor: 'bg-rose-600 hover:bg-rose-700',
            onConfirm: () => {
                deleteFromDB(id);
                setDialog(null);
            }
        });
      };

      useEffect(() => {
        if (!showEditor || (!title && !text) || view === 'burn') return;
        const timer = setTimeout(() => {
          setAutoSaveStatus('Speichert...');
          const currentEntry = {
            id: editingId || generateId(),
            title: title || 'Ohne Titel', text, color: selectedColor,
            image: selectedImage, video: selectedVideo, audio: audioUrl,
            locked: isLocked, archived: false, manifested: isManifested,
            unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
            date: editingId ? (entries.find(e => e.id === editingId)?.date || new Date().toISOString()) : new Date().toISOString(),
          };
          if (!editingId) setEditingId(currentEntry.id);
          
          if (db) {
            const tx = db.transaction('entries', 'readwrite');
            tx.objectStore('entries').put(currentEntry);
            tx.oncomplete = () => {
              setEntries(prev => {
                const exists = prev.find(e => e.id === currentEntry.id);
                if (exists) return prev.map(e => e.id === currentEntry.id ? currentEntry : e);
                return [currentEntry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
              });
              setAutoSaveStatus('Gespeichert');
              setTimeout(() => setAutoSaveStatus(''), 2000);
            };
          }
        }, 2000);
        return () => clearTimeout(timer);
      }, [title, text, selectedColor, selectedImage, selectedVideo, audioUrl, isLocked, isManifested, unlockDate, unlockLocation, category, mood, location, parentId, inheritedFrom, db, showEditor, editingId, entries, view]);

      useEffect(() => {
        if (showEditor && editorRef.current && editorRef.current.innerHTML !== text) {
          editorRef.current.innerHTML = text || '';
        }
      }, [showEditor, editingId]);

      useEffect(() => {
        let canvasEl = canvasRef.current;
        const preventScroll = (e) => { e.preventDefault(); };

        if (isDrawing && canvasEl) {
           canvasEl.addEventListener('touchstart', preventScroll, { passive: false });
           canvasEl.addEventListener('touchmove', preventScroll, { passive: false });

           setTimeout(() => {
             if (!canvasEl) return;
             const rect = canvasEl.parentElement.getBoundingClientRect();
             const dpr = window.devicePixelRatio || 1;
             
             canvasEl.width = rect.width * dpr;
             canvasEl.height = rect.height * dpr;
             canvasEl.style.width = `${rect.width}px`;
             canvasEl.style.height = `${rect.height}px`;
             
             const ctx = canvasEl.getContext('2d');
             ctx.scale(dpr, dpr); 
             ctx.fillStyle = '#ffffff';
             ctx.fillRect(0, 0, rect.width, rect.height);
             
             ctx.lineCap = 'round';
             ctx.lineJoin = 'round';
             ctx.lineWidth = 5; 
             ctx.strokeStyle = '#1e293b';
           }, 50);
        }

        return () => {
          if (canvasEl) {
             canvasEl.removeEventListener('touchstart', preventScroll);
             canvasEl.removeEventListener('touchmove', preventScroll);
          }
        };
      }, [isDrawing]);

      const getCoordinates = (e, canvas) => {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        }
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      };

      const startDrawing = (e) => {
        if (!canvasRef.current) return;
        const coords = getCoordinates(e.nativeEvent || e, canvasRef.current);
        const ctx = canvasRef.current.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(coords.x, coords.y);
        canvasRef.current.isPainting = true;
      };

      const draw = (e) => {
        if (!canvasRef.current?.isPainting) return;
        const coords = getCoordinates(e.nativeEvent || e, canvasRef.current);
        const ctx = canvasRef.current.getContext('2d');
        ctx.lineTo(coords.x, coords.y);
        ctx.stroke();
      };

      const stopDrawing = () => {
        if (canvasRef.current) canvasRef.current.isPainting = false;
      };

      const deleteFromDB = async (id) => {
        if (!db) return;
        const tx = db.transaction('entries', 'readwrite');
        tx.objectStore('entries').delete(id);
        tx.oncomplete = () => setEntries(prev => prev.filter(e => e.id !== id));
      };

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            if (type === 'image') { setSelectedImage(reader.result); setSelectedVideo(null); }
            if (type === 'video') { setSelectedVideo(reader.result); setSelectedImage(null); }
          };
          reader.readAsDataURL(file);
        }
      };
      
      const handleAudioUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setAudioUrl(reader.result);
          };
          reader.readAsDataURL(file);
        }
      };

      const handleAvatarUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const MAX_SIZE = 400; 
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_SIZE) {
                  height *= MAX_SIZE / width;
                  width = MAX_SIZE;
                }
              } else {
                if (height > MAX_SIZE) {
                  width *= MAX_SIZE / height;
                  height = MAX_SIZE;
                }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
              setUser(prev => ({ ...prev, avatar: compressedDataUrl }));
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
        e.target.value = null;
      };

      const exportBackup = () => {
        const data = { user, entries };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Legacy_Backup_${new Date().toISOString().split('T')[0]}.legacy`;
        a.click();
      };

      const importBackup = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.entries) {
              const isForeign = data.user && data.user.name !== user.name;
              if (db) {
                  const tx = db.transaction('entries', 'readwrite');
                  const store = tx.objectStore('entries');
                  
                  let mergedCount = 0;
                  data.entries.forEach(entry => {
                     if (!entries.find(ex => ex.id === entry.id)) {
                        if (isForeign) entry.inheritedFrom = data.user.name;
                        store.put(entry);
                        mergedCount++;
                     }
                  });
                  
                  const req = store.getAll();
                  req.onsuccess = () => {
                     setEntries(req.result.sort((a,b) => new Date(b.date) - new Date(a.date)));
                     showDialog({ title: 'Erfolg', message: `Fusion erfolgreich! ${mergedCount} neue Visionen importiert.`, icon: 'check' });
                  };
              }
            }
          } catch (err) { showDialog({ title: 'Fehler', message: 'Ungültige Legacy-Datei.', icon: 'x' }); }
        };
        reader.readAsText(file);
      };

      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream);
          audioChunksRef.current = [];
          mediaRecorderRef.current.ondataavailable = (e) => { if (e.data.size > 0) audioChunksRef.current.push(e.data); };
          mediaRecorderRef.current.onstop = () => {
            const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => setAudioUrl(reader.result); 
          };
          mediaRecorderRef.current.start();
          setIsRecording(true);
        } catch (err) { 
          showDialog({ title: 'Fehler', message: 'Mikrofon-Zugriff verweigert. Nutze den Upload-Button (Kassette), wenn du keine HTTPS-Verbindung hast.', icon: 'x' }); 
        }
      };
      
      const stopRecording = () => { if (mediaRecorderRef.current) { mediaRecorderRef.current.stop(); setIsRecording(false); } };

      const toggleDictation = () => {
        if (isDictating) { dictationRef.current?.stop(); setIsDictating(false); return; }
        const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRec) { showDialog({ title: 'Fehler', message: 'Dein Browser unterstützt leider kein automatisches Diktieren. Tipp: Nutze die Spracheingabe deiner Handy-Tastatur!', icon: 'x' }); return; }
        
        dictationRef.current = new SpeechRec();
        dictationRef.current.lang = 'de-DE';
        dictationRef.current.continuous = true;
        dictationRef.current.interimResults = true;
        dictationRef.current.onresult = (e) => {
          let finalTranscript = '';
          for (let i = e.resultIndex; i < e.results.length; ++i) {
            if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript + ' ';
          }
          if (finalTranscript && editorRef.current) {
             editorRef.current.focus();
             document.execCommand('insertText', false, finalTranscript);
             setText(editorRef.current.innerHTML);
          }
        };
        
        try {
          dictationRef.current.start();
          setIsDictating(true);
        } catch(e) {
          showDialog({ title: 'Fehler', message: 'Mikrofon-Zugriff verweigert. Diktieren ist ohne HTTPS oder entsprechende Browser-Rechte nicht möglich.', icon: 'x' });
        }
      };

      const setGeoLock = () => {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition((pos) => {
            setUnlockLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            setLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            showDialog({ title: 'Erfolg', message: 'Der Eintrag wurde magisch an diesen physischen Ort gebunden!', icon: 'map-pin', iconColor: 'text-emerald-500' });
          }, () => showDialog({ title: 'Fehler', message: 'Dein Standort konnte nicht ermittelt werden. Überprüfe dein GPS.', icon: 'x' }));
        }
      };

      const triggerBurn = () => {
        setIsBurning(true);
        setTimeout(() => {
          setBurnText('');
          setIsBurning(false);
          setView('dashboard');
        }, 2000);
      };

      const findResonance = () => {
        if (entries.length < 2) return;
        const withMood = entries.filter(e => e.mood && !e.locked);
        if (withMood.length > 0) {
           const randomEntry = withMood[Math.floor(Math.random() * withMood.length)];
           setEchoEntry(randomEntry);
        }
      };

      const insertPrompt = () => {
        const prompt = DEEP_PROMPTS[Math.floor(Math.random() * DEEP_PROMPTS.length)];
        if (editorRef.current) {
           editorRef.current.focus();
           document.execCommand('insertHTML', false, `<br><strong>[Reflexion]</strong> ${prompt}<br><br>`);
           setText(editorRef.current.innerHTML);
        }
      };

      const openEditor = (entry = null) => {
        if (entry && entry.id) {
          setEditingId(entry.id);
          setTitle(entry.title); 
          let initialText = entry.text || '';
          if (initialText && !initialText.includes('<') && (initialText.includes('**') || initialText.includes('*'))) {
              initialText = initialText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
          }
          setText(initialText);
          setSelectedColor(entry.color);
          setSelectedImage(entry.image); setSelectedVideo(entry.video);
          setIsLocked(entry.locked); setAudioUrl(entry.audio);
          setIsManifested(entry.manifested || false);
          setUnlockDate(entry.unlockDate || '');
          setUnlockLocation(entry.unlockLocation || null);
          setEntryType(entry.type || 'vision');
          setCategory(entry.category || CATEGORIES[0]);
          setMood(entry.mood || null);
          setLocation(entry.location || null);
          setParentId(entry.parentId || '');
          setInheritedFrom(entry.inheritedFrom || null);
        } else {
          setEditingId(null);
          setTitle(''); setText('');
          setSelectedColor(COLORS[2]); // Dunkles Default-Blau
          setSelectedImage(null); setSelectedVideo(null);
          setIsLocked(view === 'vault'); setAudioUrl(null);
          setIsManifested(false); setUnlockDate(''); setUnlockLocation(null);
          setEntryType('vision'); 
          setCategory(activeCategory === 'Alle' ? CATEGORIES[0] : activeCategory);
          setMood(null); setLocation(null); setParentId(''); setInheritedFrom(null);
        }
        setZenMode(false);
        setShowEditor(true);
      };

      const handleVaultClick = async (entry) => {
        if (entry.unlockLocation) {
           if (!("geolocation" in navigator)) { showDialog({ title: 'Fehler', message: 'Ortung nicht verfügbar.', icon: 'x' }); return; }
           navigator.geolocation.getCurrentPosition((pos) => {
             const dist = getDistance(pos.coords.latitude, pos.coords.longitude, entry.unlockLocation.lat, entry.unlockLocation.lng);
             if (dist > 200) {
               showDialog({ title: 'Blockiert', message: 'Das Orts-Siegel hält stand. Du bist zu weit entfernt. Gehe an den Ursprungsort zurück.', icon: 'lock', iconColor: 'text-rose-500' });
               return;
             } else {
               triggerUnlock(entry);
             }
           }, () => { showDialog({ title: 'Fehler', message: 'Dein Ort konnte nicht ermittelt werden.', icon: 'x' }); });
        } else {
           triggerUnlock(entry);
        }
      };

      const triggerUnlock = (entry) => {
        if (!user.pin) { showDialog({ title: 'Hinweis', message: 'Bitte richte zuerst eine PIN in den Einstellungen ein.', icon: 'key-round' }); setView('settings'); return; }
        setUnlockTarget(entry); 
        setPinInput(''); 
        setPinError(false); 
      };

      const submitPin = () => {
        if (pinInput === user.pin) {
          openEditor(unlockTarget);
          setUnlockTarget(null);
        } else {
          setPinError(true);
          setTimeout(() => setPinError(false), 800);
          setPinInput('');
        }
      };

      const now = new Date();
      const visibleEntries = entries.filter(e => {
        const matchesSearch = e.title.toLowerCase().includes(searchQuery.toLowerCase()) || (e.text && e.text.toLowerCase().includes(searchQuery.toLowerCase()));
        const matchesCategory = activeCategory === 'Alle' || e.category === activeCategory;
        
        if (!matchesSearch || !matchesCategory) return false;
        
        if (view === 'dashboard') return !e.locked && !e.archived;
        if (view === 'vault') return e.locked && !e.archived;
        if (view === 'archive') return e.archived;
        return false;
      });
      
      const getWisdoms = () => {
        let wisdoms = [];
        entries.forEach(e => {
           if (e.text && e.text.includes('<blockquote>')) {
             const matches = e.text.match(/<blockquote>(.*?)<\/blockquote>/g);
             if (matches) {
                matches.forEach(m => wisdoms.push({ text: m.replace(/<\/?blockquote>/g, ''), entry: e }));
             }
           }
        });
        return wisdoms;
      };

      if (view === 'loading') return <div className="min-h-screen flex items-center justify-center bg-slate-950"><div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div></div>;

      if (view === 'testament') {
        const testamentEntry = entries.find(e => e.id === user.testamentId);
        return (
          <div className="min-h-screen bg-black text-white p-6 sm:p-20 flex flex-col justify-center items-center text-center animate-fade-in relative overflow-hidden">
             <div className="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-amber-500 via-black to-black animate-pulse" />
             <Icon name="skull" size={48} className="text-amber-500 mb-8 z-10 opacity-50" />
             <h1 className="text-3xl font-serif italic mb-12 z-10 text-amber-200">Das Testament von {user.name}</h1>
             
             {testamentEntry ? (
               <div className="max-w-3xl z-10 bg-white/5 p-6 sm:p-10 rounded-3xl backdrop-blur-xl border border-white/10 w-full mx-4">
                 <h2 className="text-2xl sm:text-4xl font-bold mb-6">{testamentEntry.title}</h2>
                 {testamentEntry.video && <video src={testamentEntry.video} controls className="w-full rounded-xl mb-6 shadow-2xl" />}
                 <div className="text-base sm:text-xl leading-relaxed font-serif text-white/80" dangerouslySetInnerHTML={{__html: testamentEntry.text}} />
                 {testamentEntry.audio && <audio src={testamentEntry.audio} controls className="w-full mt-6 opacity-70" />}
               </div>
             ) : (
               <p className="z-10 text-white/50">Es wurde keine finale Botschaft hinterlassen.</p>
             )}
             
             <button onClick={() => { localStorage.setItem('legacy_last_active', new Date().toISOString()); setView('dashboard'); }} className="mt-20 z-10 text-xs uppercase tracking-widest opacity-30 hover:opacity-100 transition-opacity p-4">
               Zurück ins Leben (App entsperren)
             </button>
          </div>
        );
      }

      if (view === 'burn') {
        return (
          <div className={`min-h-screen transition-colors duration-1000 p-4 sm:p-6 flex flex-col ${isBurning ? 'bg-black' : 'bg-rose-950'} relative overflow-hidden`}>
            {isBurning && <div className="absolute inset-0 bg-red-600/20 animate-pulse z-0 mix-blend-overlay" />}
            <div className="flex justify-between items-center mb-8 z-10">
              <button onClick={() => setView('dashboard')} className="text-rose-200 hover:text-white p-2"><Icon name="x" size={28}/></button>
              <span className="text-rose-400 font-serif italic tracking-widest uppercase text-xs font-bold">Lass es los</span>
            </div>
            <textarea 
              value={burnText} onChange={e => setBurnText(e.target.value)} 
              placeholder="Was beschwert deine Seele? Schreibe es auf. Es wird nie gespeichert." 
              className={`flex-1 bg-transparent text-rose-100 placeholder-rose-400/30 text-xl sm:text-4xl leading-relaxed font-serif resize-none focus:outline-none z-10 transition-all duration-1000 ${isBurning ? 'opacity-0 blur-xl translate-y-10 scale-95' : 'opacity-100'} p-2`}
            />
            <div className="py-10 flex justify-center z-10">
              <button onClick={triggerBurn} disabled={!burnText || isBurning} className="p-5 rounded-full bg-rose-600 text-white shadow-[0_0_40px_rgba(225,29,72,0.6)] hover:scale-110 hover:bg-rose-500 transition-all disabled:opacity-30 disabled:hover:scale-100">
                <Icon name="flame" size={32} className={isBurning ? 'animate-bounce' : ''} />
              </button>
            </div>
          </div>
        );
      }

      if (view === 'galaxy') {
        return (
          <div className="min-h-screen bg-slate-950 text-white overflow-hidden relative touch-pan-x touch-pan-y">
             <button onClick={() => setView('dashboard')} className="absolute top-4 left-4 z-50 p-3 bg-white/10 rounded-full hover:bg-white/20 backdrop-blur-md"><Icon name="x" size={24}/></button>
             <div className="absolute top-6 right-6 z-50 text-right opacity-50 font-serif italic">Deine Gedanken-Galaxie<br/><span className="text-xs font-sans">Ziehe zum Entdecken</span></div>
             
             <div className="w-[300vw] h-[300vh] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center">
                {entries.filter(e => !e.locked && !e.archived).map((entry, i) => {
                   const angle = (i * 137.5) * (Math.PI / 180);
                   const radius = 80 + (i * 15);
                   const x = Math.cos(angle) * radius;
                   const y = Math.sin(angle) * radius;
                   
                   const isBig = entry.manifested;
                   const starColor = MOODS.find(m => m.label === entry.mood)?.color.replace('text-', 'bg-') || 'bg-slate-700';
                   
                   return (
                     <div 
                       key={entry.id} 
                       onClick={() => openEditor(entry)}
                       className={`absolute rounded-full cursor-pointer transition-transform hover:scale-150 shadow-[0_0_20px_currentColor] ${starColor} ${isBig ? 'w-5 h-5' : 'w-2 h-2 animate-pulse'}`}
                       style={{ transform: `translate(${x}px, ${y}px)` }}
                       title={entry.title}
                     >
                        {isBig && <div className="absolute inset-0 bg-white/30 rounded-full animate-ping" />}
                        <div className="absolute top-full mt-2 left-1/2 -translate-x-1/2 whitespace-nowrap text-[10px] opacity-0 hover:opacity-100 transition-opacity bg-black/80 px-2 py-1 rounded">
                          {entry.title}
                        </div>
                     </div>
                   )
                })}
             </div>
          </div>
        );
      }

      if (view === 'symphony') {
        const audioEntries = entries.filter(e => e.audio);
        const currentAudio = audioEntries[symphonyIndex];

        return (
          <div className="min-h-screen bg-slate-950 text-white flex flex-col p-4 sm:p-6 items-center justify-center relative overflow-hidden">
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/40 via-slate-950 to-slate-950 animate-pulse" />
            <button onClick={() => setView('dashboard')} className="absolute top-4 left-4 p-3 bg-white/10 rounded-full hover:bg-white/20 z-10"><Icon name="x" size={24}/></button>
            
            <Icon name="headphones" size={48} className="text-indigo-500 mb-8 z-10 opacity-80" />
            <h1 className="text-2xl sm:text-3xl font-serif mb-2 z-10">Lebens-Symphonie</h1>
            <p className="opacity-50 mb-10 z-10 text-sm">{audioEntries.length} Erinnerungen in deiner Stimme</p>
            
            {currentAudio ? (
              <div className="w-full max-w-md bg-white/5 p-6 rounded-3xl backdrop-blur-md border border-white/10 z-10 text-center">
                 <h2 className="text-xl sm:text-2xl font-bold mb-2">{currentAudio.title}</h2>
                 <p className="text-xs opacity-50 mb-6">{new Date(currentAudio.date).toLocaleDateString('de-DE')}</p>
                 <audio 
                   ref={audioPlayerRef} 
                   src={currentAudio.audio} 
                   controls 
                   autoPlay 
                   onEnded={() => setSymphonyIndex(prev => (prev + 1) % audioEntries.length)}
                   className="w-full custom-audio-player h-10" 
                 />
                 <div className="flex justify-between mt-6">
                    <button onClick={() => setSymphonyIndex(prev => prev > 0 ? prev - 1 : audioEntries.length - 1)} className="p-2 opacity-50 hover:opacity-100 text-sm">Zurück</button>
                    <button onClick={() => setSymphonyIndex(prev => (prev + 1) % audioEntries.length)} className="p-2 opacity-50 hover:opacity-100 text-sm">Nächste</button>
                 </div>
              </div>
            ) : (
              <p className="z-10 opacity-50 text-sm text-center">Du hast noch keine Sprachnotizen aufgenommen.</p>
            )}
            <style>{`.custom-audio-player::-webkit-media-controls-panel { background-color: rgba(255,255,255,0.1); }`}</style>
          </div>
        );
      }

      if (view === 'wisdom') {
        const wisdoms = getWisdoms();
        return (
          <div className="min-h-screen bg-slate-900 text-slate-100 p-4 sm:p-10 font-serif">
            <button onClick={() => setView('dashboard')} className="mb-8 p-3 bg-black/20 rounded-full hover:bg-black/40"><Icon name="x" size={24}/></button>
            <div className="max-w-2xl mx-auto">
               <h1 className="text-3xl sm:text-5xl font-bold mb-4 text-center border-b border-white/10 pb-4">Buch der Weisheit</h1>
               <p className="text-center italic opacity-60 mb-12 text-sm">Extrahierte Essenzen deines Lebens.</p>
               
               <div className="space-y-12">
                 {wisdoms.length === 0 ? <p className="text-center opacity-50 text-sm">Nutze im Editor das Zitat-Icon, um Sätze als Weisheit zu markieren.</p> : null}
                 {wisdoms.map((w, i) => (
                    <div key={i} className="relative px-4">
                      <Icon name="quote" size={28} className="absolute -top-3 -left-2 text-amber-500/20 rotate-180" />
                      <p className="text-lg sm:text-2xl leading-relaxed z-10 relative text-white/90">{w.text}</p>
                      <p className="text-[10px] font-sans uppercase tracking-widest mt-3 opacity-40">— aus "{w.entry.title}" ({new Date(w.entry.date).getFullYear()})</p>
                    </div>
                 ))}
               </div>
            </div>
          </div>
        );
      }

      if (view === 'legacy_print') {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-10 print-container">
            <div className="no-print mb-8 flex justify-between">
              <button onClick={() => setView('settings')} className="px-4 py-2 bg-slate-800 rounded-xl">Zurück</button>
              <button onClick={() => window.print()} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-bold flex gap-2"><Icon name="printer" /> Als PDF drucken</button>
            </div>
            <div className="max-w-3xl mx-auto space-y-20">
              <div className="text-center space-y-4 py-32 border-b-2 border-white/20">
                <h1 className="text-5xl font-serif font-bold">Das Vermächtnis</h1>
                <h2 className="text-3xl font-light">von {user.name}</h2>
                <p className="italic text-xl">"{user.motto}"</p>
              </div>
              {entries.filter(e => !e.locked && !e.archived).map(entry => (
                <div key={entry.id} className="break-inside-avoid space-y-6">
                  <h3 className="text-3xl font-serif font-bold border-b border-white/20 pb-2">{entry.title}</h3>
                  <p className="text-sm opacity-50">{new Date(entry.date).toLocaleDateString('de-DE')} • {entry.category}</p>
                  {entry.image && <img src={entry.image} className="w-full max-h-96 object-cover rounded-xl" alt="Vision"/>}
                  <div className="text-lg leading-relaxed font-serif legacy-content" dangerouslySetInnerHTML={{ __html: entry.text }} />
                </div>
              ))}
            </div>
          </div>
        );
      }

      if (view === 'onboarding') {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 transition-colors duration-700 bg-slate-950 text-white">
            <div className="max-w-md w-full space-y-8 animate-slide-up">
              <div className="text-center space-y-2">
                <Icon name="book-open" size={48} className="mx-auto text-amber-500 mb-6" />
                <h1 className="text-4xl font-extrabold bg-gradient-to-r from-amber-500 to-rose-600 bg-clip-text text-transparent">Dein Vermächtnis</h1>
                <p className="text-lg opacity-60 font-light">Ein Ort für deine tiefsten Visionen. Für die Ewigkeit.</p>
              </div>
              <div className="p-8 rounded-3xl shadow-2xl backdrop-blur-xl border bg-white/5 border-white/10">
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium opacity-70 mb-2">Wie lautet dein Name?</label>
                    <input type="text" value={user.name} onChange={(e) => setUser({...user, name: e.target.value})} className="w-full p-4 rounded-xl border-none focus:ring-2 focus:ring-amber-500 transition-all text-lg bg-black/20 text-white" placeholder="Dein Name..." />
                  </div>
                  <button onClick={() => user.name.trim() ? setView('dashboard') : showDialog({ title: 'Name fehlt', message: 'Bitte gib deinen Namen ein.', icon: 'user', iconColor: 'text-amber-500'})} className="w-full py-4 rounded-xl bg-gradient-to-r from-amber-500 to-rose-600 text-white font-bold text-lg hover:opacity-90 transition-opacity shadow-lg">
                    Journal beginnen
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <ErrorBoundary>
        <div className="min-h-screen transition-colors duration-700 font-sans pb-[env(safe-area-inset-bottom,4rem)] mb-16 sm:mb-20 text-slate-100 selection:bg-amber-900 selection:text-amber-100 bg-slate-950">
          
          {/* DAS NEUE GLASSMORPHISM DIALOG SYSTEM (Ersetzt alle alert() und prompt() Boxen) */}
          {dialog && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-950/80 backdrop-blur-xl animate-fade-in" onClick={() => { if(dialog.type === 'alert') setDialog(null); }}>
              <div className="w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)] border border-white/10 bg-slate-900/90 backdrop-blur-md animate-scale-in" onClick={e => e.stopPropagation()}>
                {dialog.icon && (
                  <div className="w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-6 shadow-inner bg-slate-800 border border-white/5">
                    <Icon name={dialog.icon} size={36} className={dialog.iconColor || 'text-indigo-500'} />
                  </div>
                )}
                <h3 className="text-2xl font-bold leading-tight mb-4 text-white tracking-tight">{dialog.title}</h3>
                <p className="text-base opacity-70 mb-8 text-white leading-relaxed px-2">{dialog.message}</p>
                
                {dialog.type === 'prompt' && (
                  <textarea 
                    autoFocus
                    value={dialog.inputValue || ''}
                    onChange={(e) => setDialog({...dialog, inputValue: e.target.value})}
                    className="w-full p-4 mb-6 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/30 focus:ring-2 focus:ring-amber-500 outline-none resize-none h-32 custom-scrollbar"
                    placeholder={dialog.placeholder || "Schreibe hier..."}
                  />
                )}

                <div className="flex flex-col gap-3 w-full">
                  <button 
                    className={`w-full py-4 text-white rounded-2xl font-bold shadow-lg text-base transition-transform active:scale-95 ${dialog.confirmColor || 'bg-indigo-500 hover:bg-indigo-600'}`} 
                    onClick={() => { if(dialog.onConfirm) dialog.onConfirm(dialog.inputValue); else setDialog(null); }}
                  >
                    {dialog.confirmLabel || 'Verstanden'}
                  </button>
                  {dialog.type !== 'alert' && (
                    <button 
                      className="w-full py-4 rounded-2xl font-bold text-base bg-white/5 text-white hover:bg-white/10 transition-colors active:scale-95" 
                      onClick={() => { if(dialog.onCancel) dialog.onCancel(); else setDialog(null); }}
                    >
                      {dialog.cancelLabel || 'Abbrechen'}
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* TRESOR PIN MODAL */}
          {unlockTarget && (
            <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => { setUnlockTarget(null); }} />
              <div className="relative w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl animate-scale-in border bg-slate-900 border-white/10">
                <div className="flex flex-col items-center w-full animate-fade-in">
                  <div className="w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-inner bg-slate-800"><Icon name="lock" size={28} className="text-rose-500" /></div>
                  <h3 className="text-xl font-bold mb-1">Tresor Entsperren</h3>
                  <p className="text-sm opacity-60 mb-6 truncate w-full">"{unlockTarget.title}"</p>
                  <input type="password" autoFocus value={pinInput} onChange={(e) => setPinInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && submitPin()} className={`w-full p-4 text-center text-2xl tracking-[1em] rounded-xl border-2 outline-none ${pinError ? 'border-rose-500 bg-rose-50 animate-shake' : 'bg-black/50 border-transparent focus:border-indigo-500'}`} placeholder="••••" />
                  <div className="flex gap-3 w-full mt-6">
                    <button onClick={() => setUnlockTarget(null)} className="flex-1 py-3 font-medium opacity-60 text-sm">Abbrechen</button>
                    <button onClick={submitPin} className="flex-1 py-3 rounded-xl font-bold text-white bg-rose-600 shadow-md text-sm">Öffnen</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          <header className="sticky top-0 z-30 backdrop-blur-xl border-b px-4 py-3 sm:px-6 sm:py-4 transition-all duration-500 flex justify-between items-center bg-slate-950/80 border-white/10">
            <div className="flex items-center gap-3 flex-1 overflow-hidden">
              {view === 'settings' ? <h1 className="text-xl font-extrabold tracking-tight">Einstellungen</h1> :
               view === 'menu' ? <h1 className="text-xl font-extrabold tracking-tight">Entdecken</h1> :
              (
                <>
                  {user.avatar && <img src={user.avatar} alt="Profil" className="w-10 h-10 rounded-full object-cover border-2 shadow-sm shrink-0" style={{ borderColor: user.nameColor || '#f59e0b' }} />}
                  <div className="flex flex-col overflow-hidden">
                    <h1 className="text-xl font-extrabold tracking-tight truncate" style={{ color: user.nameColor || '#f59e0b' }}>
                      {view === 'archive' ? 'Archiv' : user.name}
                    </h1>
                    {view === 'vault' && <p className="text-xs mt-0.5 font-medium flex items-center gap-1 text-rose-400"><Icon name="shield-check" size={14} /> Sicherer Tresor</p>}
                    {view === 'dashboard' && user.motto && <p className="text-[10px] mt-0.5 italic font-light truncate max-w-[200px] text-white/50">"{user.motto}"</p>}
                  </div>
                </>
              )}
            </div>
            
            <div className="flex gap-1 items-center">
              {view === 'dashboard' && (
                 <>
                   <button onClick={findResonance} className="p-2.5 rounded-full transition-colors bg-white/10 hover:bg-white/20" title="Resonanz finden"><Icon name="eye" size={18}/></button>
                   
                   <div className="flex items-center relative">
                      <input 
                        type="text" 
                        value={searchQuery} 
                        onChange={e=>setSearchQuery(e.target.value)} 
                        placeholder="Suchen..." 
                        className={`transition-all duration-300 border-none focus:ring-0 text-sm rounded-full bg-white/10 text-white ${isSearchOpen ? 'w-32 px-4 py-2 mr-1 opacity-100' : 'w-0 p-0 opacity-0 pointer-events-none'}`} 
                      />
                      <button onClick={() => setIsSearchOpen(!isSearchOpen)} className={`p-2.5 rounded-full transition-colors bg-white/10 hover:bg-white/20 ${isSearchOpen ? 'bg-amber-100 text-amber-600' : ''}`}><Icon name="search" size={18}/></button>
                   </div>
                   <button onClick={() => setView('menu')} className="p-2.5 rounded-full transition-colors bg-white/10 hover:bg-white/20"><Icon name="menu" size={18}/></button>
                 </>
              )}
              {(view === 'settings' || view === 'menu' || view === 'archive') && <button onClick={() => setView('dashboard')} className="p-2.5 rounded-full border border-transparent bg-white/10 hover:bg-white/20"><Icon name="x" size={18} /></button>}
            </div>
          </header>

          <main className="p-3 sm:p-6 max-w-4xl mx-auto min-h-[60vh]">
            
            {installHint && view === 'dashboard' && (
              <div className="mb-4 p-3 bg-indigo-500/10 border border-indigo-500/20 rounded-xl flex gap-3 items-start text-indigo-300 text-xs font-medium shadow-sm animate-fade-in">
                 <Icon name="info" size={16} className="shrink-0 mt-0.5" />
                 <p className="flex-1 leading-relaxed">{installHint}</p>
                 <button onClick={() => setInstallHint('')} className="shrink-0 opacity-50 hover:opacity-100"><Icon name="x" size={16}/></button>
              </div>
            )}
            
            {view === 'menu' && (
              <div className="grid grid-cols-2 gap-3 sm:gap-4 animate-slide-up">
                 <button onClick={() => setView('wisdom')} className="p-5 rounded-2xl flex flex-col items-center justify-center gap-3 text-center border transition-all active:scale-95 shadow-sm bg-amber-950/20 border-amber-900/50">
                    <Icon name="book-open" size={32} className="text-amber-500" />
                    <span className="font-bold text-xs">Buch der Weisheit</span>
                 </button>
                 <button onClick={() => setView('symphony')} className="p-5 rounded-2xl flex flex-col items-center justify-center gap-3 text-center border transition-all active:scale-95 shadow-sm bg-indigo-950/20 border-indigo-900/50">
                    <Icon name="headphones" size={32} className="text-indigo-500" />
                    <span className="font-bold text-xs">Symphonie</span>
                 </button>
                 <button onClick={() => setView('burn')} className="p-5 rounded-2xl flex flex-col items-center justify-center gap-3 text-center border transition-all active:scale-95 shadow-sm bg-rose-950/20 border-rose-900/50">
                    <Icon name="flame" size={32} className="text-rose-500" />
                    <span className="font-bold text-xs">Katharsis (Burn)</span>
                 </button>
                 <button onClick={() => setView('galaxy')} className="p-5 rounded-2xl flex flex-col items-center justify-center gap-3 text-center border transition-all active:scale-95 shadow-sm bg-slate-900 border-white/10">
                    <Icon name="orbit" size={32} className="text-white" />
                    <span className="font-bold text-xs">Galaxie</span>
                 </button>
                 <button onClick={() => setView('archive')} className="p-5 rounded-2xl flex flex-col items-center justify-center gap-3 text-center border transition-all active:scale-95 shadow-sm bg-slate-900 border-white/10">
                    <Icon name="archive" size={32} className="opacity-50" />
                    <span className="font-bold text-xs">Archiv</span>
                 </button>
                 <button onClick={() => setView('settings')} className="p-5 rounded-2xl flex flex-col items-center justify-center gap-3 text-center border transition-all active:scale-95 shadow-sm bg-slate-900 border-white/10">
                    <Icon name="settings" size={32} className="opacity-50" />
                    <span className="font-bold text-xs">Einstellungen</span>
                 </button>
              </div>
            )}

            {view === 'settings' && (
              <div className="space-y-6 animate-slide-up grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div className="p-5 rounded-3xl shadow-sm border bg-white/5 border-white/10">
                  <h2 className="text-base font-bold mb-5 flex items-center gap-2"><Icon name="user" size={18} className="text-amber-500" /> Profil</h2>
                  <div className="flex items-center gap-4 mb-5">
                    <div className="relative shrink-0">
                      <div className="w-16 h-16 rounded-full overflow-hidden border-[3px] shadow-sm flex items-center justify-center bg-slate-800 border-slate-700" style={{ borderColor: user.avatar ? user.nameColor : undefined }}>
                        {user.avatar ? <img src={user.avatar} alt="Avatar" className="w-full h-full object-cover" /> : <Icon name="user" size={28} className="text-slate-400" />}
                      </div>
                      <label className="absolute -bottom-1 -right-1 p-1.5 bg-amber-500 text-white rounded-full cursor-pointer shadow-md"><Icon name="camera" size={12} /><input type="file" accept="image/*" onChange={handleAvatarUpload} className="hidden" /></label>
                    </div>
                    <div className="flex-1 space-y-2">
                      <input type="text" value={user.name} onChange={(e) => setUser({...user, name: e.target.value})} className="w-full p-2.5 rounded-lg border-none focus:ring-2 focus:ring-amber-500 text-sm bg-black/30 text-white" placeholder="Dein Name" />
                      <div className="flex gap-1.5 flex-wrap">
                        {['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#8b5cf6', '#ffffff', '#1f2937'].map(color => (
                          <button key={color} onClick={() => setUser({...user, nameColor: color})} className={`w-5 h-5 rounded-full border-2 ${user.nameColor === color ? 'border-slate-400 scale-125' : 'border-transparent'}`} style={{ backgroundColor: color }} />
                        ))}
                      </div>
                    </div>
                  </div>
                  <textarea value={user.motto} onChange={(e) => setUser({...user, motto: e.target.value})} className="w-full p-3 rounded-xl border-none focus:ring-2 focus:ring-amber-500 h-16 resize-none text-sm bg-black/30 text-white" placeholder="Dein Lebensmotto..." />
                </div>
                
                <div className="p-5 rounded-3xl shadow-sm border bg-rose-950/20 border-rose-900/50">
                  <h2 className="text-base font-bold mb-3 flex items-center gap-2 text-rose-600"><Icon name="key-round" size={18} /> Sicherheit</h2>
                  {!user.pin ? (
                    <div>
                      <input type="password" value={newPinInput} onChange={(e) => setNewPinInput(e.target.value)} placeholder="Neue PIN (z.B. 4 Zahlen)" className="w-full p-3 rounded-xl border-none focus:ring-2 focus:ring-rose-500 tracking-[0.5em] text-center text-lg mb-2 bg-black/30 text-white" />
                      <button onClick={() => { if(newPinInput.length >= 4) { setUser({...user, pin: newPinInput}); setNewPinInput(''); } else showDialog({ title: 'PIN zu kurz', message: 'Die PIN muss mindestens 4 Zeichen lang sein.', icon: 'x' }); }} className="w-full py-2.5 bg-rose-600 text-white rounded-xl font-bold text-sm">PIN speichern</button>
                    </div>
                  ) : isChangingPin ? (
                    <div className="space-y-2">
                      <input type="password" value={oldPinInput} onChange={(e) => setOldPinInput(e.target.value)} placeholder="Alte PIN" className="w-full p-2.5 rounded-xl text-center tracking-[0.5em] text-sm bg-black/30 text-white" />
                      <input type="password" value={newPinInput} onChange={(e) => setNewPinInput(e.target.value)} placeholder="Neue PIN" className="w-full p-2.5 rounded-xl text-center tracking-[0.5em] text-sm bg-black/30 text-white" />
                      <div className="flex gap-2">
                        <button onClick={() => setIsChangingPin(false)} className="flex-1 py-2.5 bg-slate-500/20 rounded-xl text-sm font-medium">Abbrechen</button>
                        <button onClick={() => { if (oldPinInput === user.pin) { setUser({...user, pin: newPinInput}); setIsChangingPin(false); showDialog({ title: 'Erfolg', message: 'PIN erfolgreich geändert.', icon: 'check' }); } else showDialog({ title: 'Fehler', message: 'Die alte PIN ist falsch.', icon: 'x' }); }} className="flex-1 py-2.5 bg-rose-600 text-white rounded-xl text-sm font-bold">Speichern</button>
                      </div>
                    </div>
                  ) : (
                    <div className="flex justify-between items-center bg-black/5 p-3 rounded-xl border border-transparent">
                      <span className="font-bold text-sm">PIN Aktiv</span>
                      <button onClick={() => setIsChangingPin(true)} className="px-3 py-1.5 bg-rose-200 text-rose-700 rounded-lg font-bold text-xs">Ändern</button>
                    </div>
                  )}
                </div>

                <div className="p-5 rounded-3xl shadow-sm border bg-white/5 border-white/10">
                  <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="sparkles" size={20} className="text-amber-500" /> Lebensstatistik</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-4 rounded-2xl text-center bg-black/30">
                      <p className="text-3xl font-black text-indigo-500">{entries.length}</p>
                      <p className="text-xs opacity-60 uppercase tracking-widest mt-1">Erinnerungen</p>
                    </div>
                    <div className="p-4 rounded-2xl text-center bg-black/30">
                      <p className="text-3xl font-black text-amber-500">{entries.filter(e => e.manifested).length}</p>
                      <p className="text-xs opacity-60 uppercase tracking-widest mt-1">Manifestiert</p>
                    </div>
                  </div>
                </div>

                <div className="p-5 rounded-3xl shadow-sm border space-y-3 bg-indigo-950/20 border-indigo-900/50">
                  <h2 className="text-base font-bold mb-1 flex items-center gap-2 text-indigo-600"><Icon name="archive" size={18} /> System</h2>
                  
                  <div className="p-3 bg-white/50 dark:bg-black/30 rounded-xl space-y-2 border border-transparent">
                     <div className="flex items-center justify-between">
                        <span className="font-medium text-xs">Testament</span>
                        <Icon name="skull" size={14} className="opacity-50" />
                     </div>
                     <select value={user.testamentId || ''} onChange={e => setUser({...user, testamentId: e.target.value})} className="w-full p-2 rounded-lg text-xs bg-black/5 dark:bg-white/10 border-none outline-none text-white">
                       <option value="">Kein Testament gewählt</option>
                       {entries.map(e => <option key={e.id} value={e.id}>{e.title.substring(0, 20)}...</option>)}
                     </select>
                  </div>

                  <div className="flex gap-2">
                    <button onClick={exportBackup} className="flex-1 flex items-center justify-center gap-1.5 p-2.5 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700"><Icon name="download" size={14}/> Backup</button>
                    <label className="flex-1 flex items-center justify-center gap-1.5 p-2.5 bg-slate-700 text-slate-200 rounded-xl text-xs font-bold cursor-pointer border border-transparent shadow-sm hover:bg-slate-600">
                      <Icon name="upload" size={14}/> Import
                      <input type="file" accept=".legacy,.json" onChange={importBackup} className="hidden" />
                    </label>
                  </div>
                </div>

              </div>
            )}

            {['dashboard', 'vault', 'archive'].includes(view) && (
              <>
                {view === 'dashboard' && (
                  <div className="flex overflow-x-auto gap-2 pb-3 mb-2 custom-scrollbar snap-x">
                    {['Alle', ...CATEGORIES].map(cat => (
                      <button 
                        key={cat} onClick={() => setActiveCategory(cat)}
                        className={`px-4 py-1.5 rounded-full whitespace-nowrap snap-start text-xs font-bold transition-all ${activeCategory === cat ? 'bg-slate-800 text-white shadow-md' : 'bg-white/10 border border-white/10 opacity-70 hover:opacity-100 text-white'}`}
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                )}

                {visibleEntries.length === 0 && (
                  <div className="flex flex-col items-center justify-center py-20 text-center opacity-40 animate-fade-in">
                    {view === 'vault' ? <Icon name="shield-check" size={48} className="mb-4"/> : view === 'archive' ? <Icon name="archive" size={48} className="mb-4"/> : <Icon name="layout-grid" size={48} className="mb-4"/>}
                    <p className="text-lg font-medium tracking-wide">
                      {view === 'vault' ? 'Tresor leer.' : view === 'archive' ? 'Archiv leer.' : 'Dein Vermächtnis beginnt.'}
                    </p>
                  </div>
                )}

                <div className="columns-1 sm:columns-2 gap-4 space-y-4 pb-4">
                  {visibleEntries.map(entry => {
                    const isCapsuleLocked = entry.unlockDate && new Date(entry.unlockDate) > now;
                    const isGeoLocked = entry.unlockLocation;
                    
                    if (view === 'vault' || isCapsuleLocked || isGeoLocked) {
                      return (
                        <div 
                          key={entry.id} onClick={() => (!isCapsuleLocked || isGeoLocked) && handleVaultClick(entry)}
                          className="break-inside-avoid relative rounded-[1.5rem] p-5 shadow-sm transition-all cursor-pointer border flex flex-col justify-between items-center text-center aspect-square flex justify-center bg-slate-900 border-white/5 hover:bg-slate-800"
                        >
                          <div className={`p-4 rounded-full mb-4 ${isCapsuleLocked ? 'bg-indigo-900/50 text-indigo-400' : isGeoLocked ? 'bg-emerald-900/50 text-emerald-400' : 'bg-rose-900/50 text-rose-400'}`}>
                            {isCapsuleLocked ? <Icon name="calendar-clock" size={36} /> : isGeoLocked ? <Icon name="map-pin" size={36} /> : <Icon name="lock" size={36} />}
                          </div>
                          <div className="w-full px-2">
                            <h3 className="font-bold text-lg tracking-tight leading-snug truncate">{entry.title}</h3>
                            <span className="text-[10px] opacity-50 uppercase tracking-widest mt-1 block truncate">
                              {isCapsuleLocked ? `Öffnet ${new Date(entry.unlockDate).toLocaleDateString('de-DE')}` : isGeoLocked ? 'Orts-Siegel' : 'Verwahrt'}
                            </span>
                          </div>
                        </div>
                      );
                    }

                    const textColor = 'text-white';
                    const subTextColor = 'text-white/70';

                    return (
                      <div 
                        key={entry.id} onClick={() => view === 'dashboard' ? openEditor(entry) : null}
                        className={`break-inside-avoid group relative rounded-[1.5rem] shadow-sm transition-all duration-300 overflow-hidden cursor-pointer border flex flex-col border-white/5 ${entry.manifested ? 'ring-2 ring-amber-400/50' : ''}`}
                        style={{ backgroundColor: entry.color }}
                      >
                        {entry.inheritedFrom && (
                          <div className="absolute top-3 left-3 z-30 bg-black/80 text-amber-400 text-[9px] font-black uppercase tracking-widest px-2 py-1 rounded-md shadow-sm flex items-center gap-1 backdrop-blur-md">
                            <Icon name="git-merge" size={10}/> Von {entry.inheritedFrom.split(' ')[0]}
                          </div>
                        )}
                        {entry.manifested && (
                          <div className="absolute top-3 right-3 z-30 bg-amber-400 text-amber-900 text-[9px] font-black uppercase tracking-widest px-2 py-1 rounded-md shadow-sm flex items-center gap-1">
                            <Icon name="sparkles" size={10}/> Manifestiert
                          </div>
                        )}
                        
                        {entry.image && (
                          <div className="w-full relative overflow-hidden bg-black/20 flex justify-center items-center border-b border-white/10">
                            <img src={entry.image} alt="Vision" className="w-full h-auto max-h-[400px] object-contain transform group-hover:scale-105 transition-transform duration-1000" />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent z-10 pointer-events-none" />
                            <h3 className="absolute bottom-4 left-4 right-4 z-20 font-bold text-xl text-white drop-shadow-md leading-snug line-clamp-2">{entry.title}</h3>
                          </div>
                        )}

                        <div className="p-5 flex-1 flex flex-col">
                          {!entry.image && <h3 className={`font-bold text-xl leading-snug mb-2 ${textColor} line-clamp-2`}>{entry.title}</h3>}
                          
                          {entry.type === 'letter' && <div className="mb-2 text-[10px] font-bold uppercase tracking-widest opacity-50 flex items-center gap-1"><Icon name="quote" size={12}/> Zukunfts-Brief</div>}
                          
                          {entry.text && (
                            <div className={`text-sm leading-relaxed mb-4 ${subTextColor} font-light line-clamp-3 legacy-content`} dangerouslySetInnerHTML={{ __html: entry.text }} />
                          )}

                          <div className="flex flex-wrap items-center justify-between pt-3 border-t border-current border-opacity-10 mt-auto">
                            <div className="flex flex-col">
                               <span className={`text-[9px] font-black uppercase tracking-widest ${subTextColor} opacity-60`}>
                                 {new Date(entry.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' })}
                               </span>
                            </div>
                            
                            <div className="flex gap-1.5 items-center">
                              {entry.mood && (() => {
                                 const moodObj = MOODS.find(m=>m.label===entry.mood);
                                 if (!moodObj) return null;
                                 return <Icon name={moodObj.id} size={14} className={moodObj.color} />;
                              })()}
                              {entry.location && <Icon name="map-pin" size={14} className={subTextColor} />}
                              {(entry.audio || entry.video) && <Icon name="mic" size={14} className={subTextColor} />}
                              
                              {view === 'archive' && (
                                <div className="flex gap-1 ml-1">
                                  <button onClick={(e) => { e.stopPropagation(); setEntries(prev => prev.map(ex => ex.id === entry.id ? { ...ex, archived: false } : ex)); }} className={`p-1.5 rounded-full bg-white/20 ${textColor}`}><Icon name="rotate-ccw" size={14} /></button>
                                  <button onClick={(e) => { e.stopPropagation(); confirmArchiveDelete(entry.id); }} className="p-1.5 rounded-full bg-rose-500/20 text-rose-500"><Icon name="trash-2" size={14} /></button>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}
          </main>

          {/* EDITOR OVERLAY */}
          {showEditor && (
            <div className="fixed inset-0 z-[90] flex items-end sm:items-center justify-center sm:p-6 transition-all bg-slate-900/60 backdrop-blur-sm">
              <div className="absolute inset-0 bg-transparent" onClick={closeEditor} />
              
              <div 
                className="relative w-full max-w-2xl mx-auto flex flex-col shadow-2xl transition-all h-[100dvh] sm:rounded-none bg-transparent sm:h-[90dvh] max-h-[900px] rounded-t-[2rem] sm:rounded-[2rem] border-t border-white/10"
                style={{ backgroundColor: zenMode ? 'transparent' : selectedColor }}
              >
                <div className={`flex justify-between items-center px-5 py-4 border-b ${zenMode ? 'border-transparent' : 'border-white/5 bg-white/10'}`}>
                  <button onClick={closeEditor} className="p-1.5 rounded-full transition-colors text-white hover:bg-black/5"><Icon name="x" size={22}/></button>
                  
                  {!zenMode && (
                    <div className="flex gap-1 overflow-x-auto hide-scrollbar items-center">
                      {autoSaveStatus && <span className="flex items-center text-[10px] font-bold text-emerald-500 animate-pulse mr-1"><Icon name="check" size={12} className="mr-0.5"/> {autoSaveStatus}</span>}
                      
                      <button onClick={() => confirmDelete(editingId)} className="p-2 rounded-full hover:bg-rose-500/10 text-slate-300 hover:text-rose-400 transition-colors" title="Verwerfen / Löschen">
                        <Icon name="trash-2" size={18}/>
                      </button>
                      
                      <button onClick={() => {
                          const entryToArchive = {
                            id: editingId || generateId(),
                            title: title || 'Ohne Titel', text, color: selectedColor,
                            image: selectedImage, video: selectedVideo, audio: audioUrl,
                            locked: isLocked, archived: true, manifested: isManifested,
                            unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
                            date: editingId ? (entries.find(e => e.id === editingId)?.date || new Date().toISOString()) : new Date().toISOString(),
                          };
                          saveToDB(entryToArchive);
                          closeEditor();
                      }} className="p-2 rounded-full hover:bg-amber-500/10 text-slate-300 hover:text-amber-400 transition-colors" title="Ins Archiv verschieben">
                          <Icon name="archive" size={18}/>
                      </button>

                      <button onClick={() => setZenMode(true)} className="p-2 rounded-full hover:bg-white/10 text-slate-300"><Icon name="maximize-2" size={18}/></button>
                      <button onClick={() => setIsManifested(!isManifested)} className={`p-2 rounded-full ${isManifested ? 'bg-amber-400 text-amber-900' : 'text-slate-300 opacity-80 hover:opacity-100'}`}><Icon name="sparkles" size={18}/></button>
                      <button onClick={() => setIsLocked(!isLocked)} className={`p-2 rounded-full ${isLocked ? 'bg-rose-500 text-white' : 'text-slate-300 opacity-80 hover:opacity-100'}`}><Icon name="lock" size={18}/></button>
                    </div>
                  )}
                  {zenMode && <button onClick={() => setZenMode(false)} className="text-white/70 hover:text-white"><Icon name="minimize-2" size={22}/></button>}

                  <button onClick={checkSaveEntry} className="bg-white text-slate-900 p-2.5 rounded-full font-bold shadow-md hover:scale-105 transition-transform flex items-center justify-center"><Icon name="save" size={20}/></button>
                </div>

                <div className={`flex-1 overflow-y-auto p-5 sm:p-8 flex flex-col gap-4 custom-scrollbar w-full text-white`}>
                  
                  {!zenMode && (
                    <div className="flex flex-wrap gap-2 text-[10px] font-bold uppercase tracking-widest opacity-60 shrink-0">
                      <select value={category} onChange={e=>setCategory(e.target.value)} className="bg-transparent border-none outline-none focus:ring-0 p-0 font-bold text-white">
                        {CATEGORIES.map(c => <option key={c} value={c} className="text-black">{c}</option>)}
                      </select>
                      <span>•</span>
                      <select value={entryType} onChange={e=>setEntryType(e.target.value)} className="bg-transparent border-none outline-none focus:ring-0 p-0 font-bold text-white">
                        <option value="vision" className="text-black">Vision</option>
                        <option value="letter" className="text-black">Brief</option>
                      </select>
                    </div>
                  )}

                  <input type="text" placeholder="Titel..." value={title} onChange={(e) => setTitle(e.target.value)} className="w-full shrink-0 bg-transparent text-3xl font-serif font-bold placeholder-white/30 opacity-90 border-none focus:ring-0 p-0 focus:outline-none" />
                  
                  {!zenMode && (
                    <div className="flex gap-1 py-1.5 border-y border-current border-opacity-10 opacity-70 shrink-0">
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('bold', false, null); }} className="p-1.5 rounded hover:bg-white/10" title="Fett"><Icon name="bold" size={16}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('italic', false, null); }} className="p-1.5 rounded hover:bg-white/10" title="Kursiv"><Icon name="italic" size={16}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('insertUnorderedList', false, null); }} className="p-1.5 rounded hover:bg-white/10"><Icon name="list-todo" size={16}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('formatBlock', false, 'blockquote'); }} className="p-1.5 rounded hover:bg-white/10"><Icon name="quote" size={16}/></button>
                    </div>
                  )}

                  <div 
                    ref={editorRef}
                    contentEditable={true}
                    suppressContentEditableWarning={true}
                    data-placeholder="Schreibe deine Gedanken hier..."
                    onInput={(e) => setText(e.currentTarget.innerHTML)}
                    className="w-full flex-1 min-h-[250px] bg-transparent text-lg sm:text-xl leading-relaxed focus:outline-none font-serif empty:before:content-[attr(data-placeholder)] empty:before:opacity-40 empty:before:cursor-text legacy-editor-content pb-10"
                  />

                  {!zenMode && (
                    <div className="space-y-3 shrink-0 pb-4">
                      {selectedImage && <div className="relative rounded-2xl overflow-hidden shadow-sm bg-black/20 flex justify-center"><img src={selectedImage} alt="Preview" className="w-full h-auto max-h-[40vh] object-contain" /><button onClick={() => setSelectedImage(null)} className="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full z-10"><Icon name="x" size={14}/></button></div>}
                      {selectedVideo && <div className="relative rounded-2xl overflow-hidden shadow-sm flex justify-center bg-black/20"><video src={selectedVideo} controls className="w-full h-auto max-h-[40vh] object-contain bg-black" /><button onClick={() => setSelectedVideo(null)} className="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full z-10"><Icon name="x" size={14}/></button></div>}
                      {audioUrl && <div className="bg-white/10 p-3 rounded-xl flex items-center justify-between backdrop-blur-md"><audio src={audioUrl} controls className="w-full h-8" /><button onClick={() => setAudioUrl(null)} className="p-1.5 bg-rose-500/20 text-rose-500 rounded-full ml-2"><Icon name="trash-2" size={14}/></button></div>}
                    </div>
                  )}
                </div>

                {!zenMode && (
                  <div className="border-t border-white/5 bg-black/40 backdrop-blur-xl p-3 sm:p-4 flex flex-col gap-3 pb-[env(safe-area-inset-bottom,16px)]">
                    
                    <div className="flex justify-between items-center overflow-x-auto hide-scrollbar gap-2">
                      <div className="flex gap-1.5 shrink-0">
                        <label className="p-2.5 rounded-full bg-white/10 shadow-sm cursor-pointer text-white"><Icon name="image" size={18}/><input type="file" accept="image/*" onChange={(e)=>handleFileUpload(e,'image')} className="hidden" /></label>
                        <button onClick={() => setIsDrawing(true)} className="p-2.5 rounded-full bg-white/10 shadow-sm text-white"><Icon name="pen-tool" size={18}/></button>
                        
                        <label className="p-2.5 rounded-full bg-white/10 shadow-sm cursor-pointer text-white" title="Video aufnehmen">
                           <Icon name="video" size={18}/>
                           <input type="file" accept="video/*" capture="environment" onChange={(e)=>handleFileUpload(e,'video')} className="hidden" />
                        </label>

                        <label className="p-2.5 rounded-full bg-white/10 shadow-sm cursor-pointer text-white" title="Sprachnotiz aufnehmen / hochladen">
                           <Icon name="mic" size={18}/>
                           <input type="file" accept="audio/*" capture="environment" onChange={handleAudioUpload} className="hidden" />
                        </label>
                      </div>
                      
                      <div className="flex gap-1.5 shrink-0 border-l border-white/10 pl-2">
                        <button onClick={insertPrompt} className="p-2.5 rounded-full bg-indigo-900/50 text-indigo-300 shadow-sm flex items-center gap-1 text-[10px] font-bold"><Icon name="sparkles" size={14}/> Deep Prompt</button>
                        
                        <label className={`relative p-2.5 rounded-full shadow-sm flex items-center justify-center cursor-pointer overflow-hidden ${unlockDate ? 'bg-indigo-500 text-white' : 'bg-white/10 text-white'}`}>
                          <Icon name="calendar-clock" size={18}/>
                          <input type="date" value={unlockDate} onChange={e=>setUnlockDate(e.target.value)} className="absolute opacity-0 w-[200%] h-[200%] -top-1/2 -left-1/2 cursor-pointer" />
                        </label>
                      </div>
                    </div>

                    <div className="flex justify-between items-center overflow-x-auto hide-scrollbar gap-4 border-t border-white/5 pt-3">
                      <div className="flex gap-1.5 shrink-0">
                         {MOODS.map(m => (
                           <button key={m.id} onClick={()=>setMood(m.label===mood ? null : m.label)} className={`p-1.5 rounded-full transition-all ${mood===m.label ? 'bg-slate-800 shadow-sm scale-110 ' + m.color : 'opacity-40 text-white'}`}>
                             <Icon name={m.id} size={18} />
                           </button>
                         ))}
                      </div>
                      <div className="flex gap-1.5 shrink-0">
                        {COLORS.slice(0, 18).map((c) => (
                          <button key={c} onClick={() => setSelectedColor(c)} className={`w-6 h-6 rounded-full shadow-sm border-2 ${selectedColor === c ? 'scale-125 border-current z-10' : 'border-transparent opacity-80'}`} style={{ backgroundColor: c }} />
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {isDrawing && (
            <div className="fixed inset-0 z-[120] flex flex-col bg-slate-900 text-white">
              <div className="flex justify-between items-center p-4 border-b border-white/10">
                <button onClick={() => setIsDrawing(false)} className="p-2 text-white/70 hover:text-white"><Icon name="x" size={24} /></button>
                <span className="font-bold">Freihand Skizze</span>
                <button 
                  onClick={() => {
                     if(canvasRef.current) {
                       setSelectedImage(canvasRef.current.toDataURL());
                       setIsDrawing(false);
                     }
                  }} 
                  className="bg-amber-500 text-black px-4 py-2 rounded-full font-bold flex gap-2 items-center"
                >
                  <Icon name="check" size={18}/> Übernehmen
                </button>
              </div>
              <div className="flex-1 relative bg-white touch-none">
                <canvas 
                  ref={canvasRef} 
                  className="absolute inset-0 w-full h-full cursor-crosshair touch-none"
                  onMouseDown={startDrawing}
                  onMouseMove={draw}
                  onMouseUp={stopDrawing}
                  onMouseLeave={stopDrawing}
                  onTouchStart={startDrawing}
                  onTouchMove={draw}
                  onTouchEnd={stopDrawing}
                />
              </div>
              <div className="p-4 bg-slate-900 flex justify-center">
                 <button onClick={() => { 
                   if (!canvasRef.current) return;
                   const canvas = canvasRef.current; 
                   const ctx = canvas.getContext('2d'); 
                   ctx.save();
                   ctx.setTransform(1, 0, 0, 1, 0, 0);
                   ctx.fillStyle = '#ffffff'; 
                   ctx.fillRect(0, 0, canvas.width, canvas.height); 
                   ctx.restore();
                 }} className="p-3 bg-white/10 rounded-full hover:bg-white/20 text-white"><Icon name="eraser" size={24}/></button>
              </div>
            </div>
          )}

          <nav className="fixed bottom-0 left-0 right-0 backdrop-blur-2xl border-t z-40 transition-colors duration-500 bg-slate-950/90 border-white/10 pb-[env(safe-area-inset-bottom,0px)]">
            <div className="flex justify-between items-center h-16 max-w-sm mx-auto px-8">
              <button onClick={() => setView('dashboard')} className={`flex flex-col items-center justify-center h-full space-y-1 transition-colors ${view === 'dashboard' ? 'text-indigo-500' : 'opacity-40 text-white'}`}><Icon name="layout-grid" size={24} /><span className="text-[10px] font-bold">Visionen</span></button>
              
              <div className="relative -top-5">
                <button onClick={() => openEditor()} className="w-16 h-16 rounded-full shadow-lg flex items-center justify-center active:scale-95 text-white border-[4px] border-slate-950 transition-colors duration-300" style={{ backgroundColor: user.nameColor || '#f59e0b' }}><Icon name="plus" size={32} /></button>
              </div>
              
              <button onClick={() => setView('vault')} className={`flex flex-col items-center justify-center h-full space-y-1 transition-colors ${view === 'vault' ? 'text-amber-500' : 'opacity-40 text-white'}`}><Icon name="lock" size={24} /><span className="text-[10px] font-bold">Tresor</span></button>
            </div>
          </nav>
          
        </div>
        </ErrorBoundary>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
