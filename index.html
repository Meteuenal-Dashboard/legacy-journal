<!DOCTYPE html>
<html lang="de" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Legacy Vision Journal</title>
  
  <!-- PWA & Standalone App Setup -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">
  
  <link rel="manifest" href="manifest.json">
  
  <!-- Zeitlose Typografie: Lora & Playfair Display -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Blockiert die Einmischung des Handy-Betriebssystems -->
  <script>
    tailwind.config = {
      darkMode: 'class', 
    }
  </script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel für JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* PURE DARK MODE & TYPOGRAFIE */
    :root { color-scheme: dark !important; }
    
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Lora', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      background-color: #020617 !important; 
      color: #f8fafc !important;
    }

    h1, h2, h3, h4, h5, h6, .font-serif {
      font-family: 'Playfair Display', serif !important;
    }
    
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 24px); }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
    @keyframes slide-up { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes scale-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } } .animate-scale-in { animation: scale-in 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } } .animate-shake { animation: shake 0.4s ease-in-out; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; } .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    .hide-scrollbar::-webkit-scrollbar { display: none; } .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .legacy-editor-content ul, .legacy-content ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .legacy-editor-content li, .legacy-content li { margin-bottom: 0.25rem; }
    .legacy-editor-content b, .legacy-editor-content strong, .legacy-content b, .legacy-content strong { font-weight: bold; color: white; font-family: 'Lora', serif; }
    .legacy-editor-content i, .legacy-editor-content em, .legacy-content i, .legacy-content em { font-style: italic; }
    .legacy-editor-content blockquote, .legacy-content blockquote { border-left: 4px solid #f59e0b; padding-left: 1.5rem; margin-left: 0; font-style: italic; opacity: 0.9; background: rgba(245, 158, 11, 0.05); padding: 1rem 1.5rem; border-radius: 0 12px 12px 0; margin-top: 1rem; margin-bottom: 1rem; }
    [contenteditable="true"]:empty:before { content: attr(data-placeholder); opacity: 0.3; pointer-events: none; display: block; color: #cbd5e1; }

    /* Haptisches Rauschen (Film Grain) für organisches Gefühl */
    .grain-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      opacity: 0.04;
      pointer-events: none;
      z-index: 9999;
    }

    html, body, #root { width: 100%; height: 100%; overflow-x: hidden; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const safeStorageGet = (key) => {
      try { return localStorage.getItem(key); } catch(e) { return null; }
    };
    const safeStorageSet = (key, val) => {
      try { localStorage.setItem(key, val); } catch(e) {}
    };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      componentDidCatch(error, errorInfo) { console.error("App Crash:", error, errorInfo); }
      render() { 
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white p-8 text-center">
              <div>
                <h1 className="text-2xl font-bold text-rose-500 mb-4 font-serif">Ein Moment bitte...</h1>
                <p className="opacity-70 mb-8 font-serif">Die App hat sich beim Laden verschluckt. Bitte lade die Seite neu.</p>
                <button onClick={() => window.location.reload()} className="px-6 py-3 bg-amber-500 text-slate-900 font-bold rounded-xl shadow-lg">Neu laden</button>
              </div>
            </div>
          );
        }
        return this.props.children; 
      }
    }

    const Icon = ({ name, size = 24, className = '', ...props }) => {
      const spanRef = useRef(null);
      useEffect(() => {
        const renderIcon = () => {
          if (spanRef.current && window.lucide) {
            spanRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
            window.lucide.createIcons({ root: spanRef.current });
            const svg = spanRef.current.querySelector('svg');
            if (svg) {
              svg.setAttribute('width', size);
              svg.setAttribute('height', size);
              if (className) svg.setAttribute('class', `lucide lucide-${name} ${className}`);
            }
          }
        };
        if (window.lucide) renderIcon();
        else setTimeout(renderIcon, 100);
      }, [name, size, className]);

      return <span ref={spanRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} {...props}></span>;
    };

    const COLORS = [
      '#1f2937', '#111827', '#0f172a', '#374151', '#475569', '#334155',
      '#7f1d1d', '#991b1b', '#78350f', '#92400e', '#14532d', '#166534',
      '#1e3a8a', '#1e40af', '#4c1d95', '#5b21b6', '#831843', '#9d174d'
    ];

    const CATEGORIES = ['Allgemein', 'Familie', 'Karriere', 'Seele', 'Gesundheit', 'Finanzen'];
    const MOODS = [
      { id: 'smile', label: 'Strahlend', color: 'text-amber-500', iconName: 'smile' },
      { id: 'heart', label: 'Liebevoll', color: 'text-rose-500', iconName: 'heart' },
      { id: 'coffee', label: 'Fokussiert', color: 'text-amber-700', iconName: 'coffee' },
      { id: 'cloud-lightning', label: 'Stürmisch', color: 'text-indigo-500', iconName: 'cloud-lightning' },
      { id: 'frown', label: 'Nachdenklich', color: 'text-slate-400', iconName: 'frown' }
    ];

    const DEEP_PROMPTS = [
      "Wofür bist du heute am tiefsten dankbar?",
      "Welche Angst hat dich heute zurückgehalten?",
      "Was würdest du deinem 10 Jahre jüngeren Ich heute sagen?",
      "Was ist dein größter Traum, den du dich noch nicht traust auszusprechen?",
      "Welchen Meilenstein möchtest du in genau einem Jahr erreicht haben?"
    ];

    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

    const getDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371e3; 
      const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180;
      const dp = (lat2-lat1) * Math.PI/180, dl = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    };

    const initDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('LegacyVisionDB', 3);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('entries')) db.createObjectStore('entries', { keyPath: 'id' });
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    };

    const App = () => {
      const [db, setDb] = useState(null);
      const [entries, setEntries] = useState([]);
      const [user, setUser] = useState({ name: '', motto: '', pin: '', avatar: null, nameColor: '#f59e0b', testamentId: null });
      const [view, setView] = useState('loading'); 
      const [isLoaded, setIsLoaded] = useState(false);
      
      const [searchQuery, setSearchQuery] = useState('');
      const [activeCategory, setActiveCategory] = useState('Alle');
      const [isSearchOpen, setIsSearchOpen] = useState(false);
      
      // Dialog & Picker
      const [dialog, setDialog] = useState(null);
      const [picker, setPicker] = useState(null);
      const [installHint, setInstallHint] = useState('');
      
      // Fokus-Lesemodus
      const [viewingEntry, setViewingEntry] = useState(null);
      
      const [showEditor, setShowEditor] = useState(false);
      const [affirmation, setAffirmation] = useState(null);
      const [echoEntry, setEchoEntry] = useState(null);
      
      // Security
      const [unlockTarget, setUnlockTarget] = useState(null);
      const [pinInput, setPinInput] = useState('');
      const [pinError, setPinError] = useState(false);
      const [isChangingPin, setIsChangingPin] = useState(false);
      const [oldPinInput, setOldPinInput] = useState('');
      const [newPinInput, setNewPinInput] = useState('');

      // Editor
      const [editingId, setEditingId] = useState(null);
      const [title, setTitle] = useState('');
      const [text, setText] = useState('');
      const [selectedColor, setSelectedColor] = useState(COLORS[2]);
      const [selectedImage, setSelectedImage] = useState(null);
      const [selectedVideo, setSelectedVideo] = useState(null);
      const [isLocked, setIsLocked] = useState(false);
      const [audioUrl, setAudioUrl] = useState(null);
      const [isManifested, setIsManifested] = useState(false);
      const [unlockDate, setUnlockDate] = useState(''); 
      const [unlockLocation, setUnlockLocation] = useState(null); 
      const [entryType, setEntryType] = useState('vision');
      const [category, setCategory] = useState(CATEGORIES[0]);
      const [mood, setMood] = useState(null);
      const [location, setLocation] = useState(null);
      const [parentId, setParentId] = useState(''); 
      const [zenMode, setZenMode] = useState(false);
      const [inheritedFrom, setInheritedFrom] = useState(null); 

      // Tools
      const [isDrawing, setIsDrawing] = useState(false);
      const canvasRef = useRef(null);
      const editorRef = useRef(null); 
      const [autoSaveStatus, setAutoSaveStatus] = useState('');
      const [burnText, setBurnText] = useState('');
      const [isBurning, setIsBurning] = useState(false);
      const [symphonyIndex, setSymphonyIndex] = useState(0);
      const audioPlayerRef = useRef(null);
      
      const [isRecording, setIsRecording] = useState(false);
      const [isDictating, setIsDictating] = useState(false);
      const mediaRecorderRef = useRef(null);
      const dictationRef = useRef(null);

      // Refs für sicheres Back-Button Handling
      const viewRef = useRef(view);
      const editorRefState = useRef(showEditor);
      const closeEditorRef = useRef(null);
      const viewingEntryRef = useRef(viewingEntry);

      useEffect(() => { viewRef.current = view; }, [view]);
      useEffect(() => { editorRefState.current = showEditor; }, [showEditor]);
      useEffect(() => { viewingEntryRef.current = viewingEntry; }, [viewingEntry]);

      const showDialog = (options) => {
         setDialog({ type: 'alert', confirmLabel: 'Verstanden', ...options });
      };

      const closeEditor = () => {
        setShowEditor(false);
        if (isRecording) stopRecording();
        if (isDictating) toggleDictation();
      };

      useEffect(() => {
        closeEditorRef.current = closeEditor;
      });

      useEffect(() => {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
        if (!isStandalone) {
          if (window.location.protocol.includes('file') || window.location.protocol.includes('content')) {
             setInstallHint("Tipp: Du hast die Datei lokal geöffnet (Datenbank blockiert!). Rufe deinen GitHub-Link auf und installiere sie von dort!");
          }
        }
      }, []);

      // Navigation & Back-Button Protection
      useEffect(() => {
        if (!isLoaded) return;
        window.history.pushState({ locked: true }, '');

        const handlePopState = (e) => {
          window.history.pushState({ locked: true }, '');

          if (viewingEntryRef.current) {
             setViewingEntry(null);
          } else if (editorRefState.current && closeEditorRef.current) {
             closeEditorRef.current();
          } else if (viewRef.current !== 'dashboard' && viewRef.current !== 'loading' && viewRef.current !== 'onboarding') {
             setView('dashboard');
          } else if (viewRef.current === 'dashboard') {
            showDialog({
                type: 'confirm',
                title: 'Journal verlassen?',
                message: 'Möchtest du das Vermächtnis wirklich verlassen?',
                icon: 'log-out',
                iconColor: 'text-rose-500',
                confirmLabel: 'Verlassen',
                confirmColor: 'bg-rose-600',
                onConfirm: () => { window.location.href = "about:blank"; }
            });
          }
        };

        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, [isLoaded]);

      // Initial Load
      useEffect(() => {
        const loadApp = async () => {
          try {
            const savedUser = safeStorageGet('legacy_user');
            let currentUser = { name: '', motto: '', pin: '', avatar: null, nameColor: '#f59e0b', testamentId: null };
            if (savedUser) {
              const parsed = JSON.parse(savedUser);
              if (parsed.isDark !== undefined) delete parsed.isDark; // Clean legacy
              currentUser = { ...currentUser, ...parsed };
              setUser(currentUser);
            }

            try {
                const database = await initDB();
                setDb(database);
                
                const transaction = database.transaction('entries', 'readonly');
                const request = transaction.objectStore('entries').getAll();
                
                request.onsuccess = () => {
                  let loadedEntries = request.result || [];
                  const lastActiveStr = safeStorageGet('legacy_last_active');
                  const lastActive = lastActiveStr ? new Date(lastActiveStr) : new Date();
                  const daysInactive = (new Date() - lastActive) / (1000 * 60 * 60 * 24);
                  
                  safeStorageSet('legacy_last_active', new Date().toISOString());
                  setEntries(loadedEntries.sort((a,b) => new Date(b.date) - new Date(a.date)));
                  setIsLoaded(true);

                  if (!currentUser.name) {
                    setView('onboarding');
                  } else if (currentUser.testamentId && daysInactive > 365) {
                    setView('testament'); 
                  } else {
                    setView('dashboard');
                    checkDailyAffirmation(loadedEntries);
                  }
                };
            } catch (dbError) {
                console.error("IndexedDB blocked", dbError);
                showDialog({
                   title: 'Datenbank blockiert',
                   message: 'Dein Browser blockiert den Speicher. Nutze Chrome für den vollen Umfang!',
                   icon: 'alert-triangle',
                   iconColor: 'text-amber-500'
                });
                setIsLoaded(true);
                if (!currentUser.name) setView('onboarding');
                else setView('dashboard');
            }
          } catch (e) {
            console.error("Critical Boot Error", e);
            setIsLoaded(true);
            setView('onboarding');
          }
        };
        loadApp();
      }, []);

      const checkDailyAffirmation = (allEntries) => {
        const today = new Date().toDateString();
        if (safeStorageGet('legacy_last_affirmation') !== today && allEntries.length > 0) {
          const publicEntries = allEntries.filter(e => !e.locked && !e.archived);
          if (publicEntries.length > 0) {
            setAffirmation(publicEntries[Math.floor(Math.random() * publicEntries.length)]);
            safeStorageSet('legacy_last_affirmation', today);
          }
        }
      };

      useEffect(() => {
        if (isLoaded) safeStorageSet('legacy_user', JSON.stringify(user));
      }, [user, isLoaded]);

      const saveToDB = async (entry) => {
        try {
            if (db) {
              const tx = db.transaction('entries', 'readwrite');
              tx.objectStore('entries').put(entry);
              tx.oncomplete = () => {
                setEntries(prev => {
                  const exists = prev.find(e => e.id === entry.id);
                  if (exists) return prev.map(e => e.id === entry.id ? entry : e);
                  return [entry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
                });
              };
            } else {
              setEntries(prev => {
                  const exists = prev.find(e => e.id === entry.id);
                  if (exists) return prev.map(e => e.id === entry.id ? entry : e);
                  return [entry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
              });
            }
        } catch (e) { console.error("Save Error", e); }
      };

      const checkSaveEntry = () => {
        const executeSave = () => {
            const newEntry = {
              id: editingId || generateId(),
              title: title || 'Ohne Titel', text, color: selectedColor,
              image: selectedImage, video: selectedVideo, audio: audioUrl,
              locked: isLocked, archived: false, manifested: isManifested,
              unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
              date: editingId ? (entries.find(e => e.id === editingId)?.date || new Date().toISOString()) : new Date().toISOString(),
            };
            saveToDB(newEntry);
            closeEditor();
        };

        const isEmpty = !title.trim() && !text.replace(/<[^>]*>?/gm, '').trim() && !selectedImage && !selectedVideo && !audioUrl;
        if (isEmpty && unlockDate) {
            showDialog({
                type: 'confirm',
                title: 'Leeres Datums-Siegel?',
                message: 'Du hast ein Datum im Kalender ausgewählt, aber keinen Text geschrieben. Möchtest du diese leere Kapsel wirklich versiegeln?',
                icon: 'calendar-clock',
                iconColor: 'text-indigo-400',
                confirmLabel: 'Trotzdem speichern',
                confirmColor: 'bg-indigo-500 hover:bg-indigo-600',
                cancelLabel: 'Abbrechen',
                onConfirm: () => { executeSave(); setDialog(null); }
            });
        } else if (isEmpty && !editingId) {
            showDialog({
                type: 'confirm',
                title: 'Leerer Gedanke',
                message: 'Dein Eintrag enthält noch keinen Inhalt. Möchtest du ihn trotzdem speichern oder den Vorgang abbrechen?',
                icon: 'file-question',
                iconColor: 'text-slate-400',
                confirmLabel: 'Speichern',
                confirmColor: 'bg-slate-700 hover:bg-slate-600',
                cancelLabel: 'Verwerfen',
                onCancel: () => { closeEditor(); setDialog(null); },
                onConfirm: () => { executeSave(); setDialog(null); }
            });
        } else {
            executeSave();
        }
      };

      const confirmDelete = (id) => {
        showDialog({
            type: 'confirm',
            title: 'Vision vernichten?',
            message: 'Bist du sicher, dass du diesen Gedanken für immer aus deinem Vermächtnis löschen möchtest? Dieser Schritt kann nicht rückgängig gemacht werden.',
            icon: 'trash-2',
            iconColor: 'text-rose-500',
            confirmLabel: 'Ja, löschen',
            confirmColor: 'bg-rose-600 hover:bg-rose-700',
            onConfirm: () => { deleteFromDB(id); closeEditor(); setViewingEntry(null); setDialog(null); }
        });
      };

      const confirmArchiveDelete = (id) => {
        showDialog({
            type: 'confirm',
            title: 'Endgültig löschen?',
            message: 'Dieser Eintrag wird unwiderruflich aus dem Archiv gelöscht. Es gibt kein Zurück.',
            icon: 'alert-triangle',
            iconColor: 'text-rose-500',
            confirmLabel: 'Vernichten',
            confirmColor: 'bg-rose-600 hover:bg-rose-700',
            onConfirm: () => { deleteFromDB(id); setDialog(null); }
        });
      };

      // Auto-Save Timeout
      useEffect(() => {
        if (!showEditor || (!title && !text) || view === 'burn') return;
        const timer = setTimeout(() => {
          setAutoSaveStatus('Speichert...');
          const currentEntry = {
            id: editingId || generateId(),
            title: title || 'Ohne Titel', text, color: selectedColor,
            image: selectedImage, video: selectedVideo, audio: audioUrl,
            locked: isLocked, archived: false, manifested: isManifested,
            unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
            date: editingId ? (entries.find(e => e.id === editingId)?.date || new Date().toISOString()) : new Date().toISOString(),
          };
          if (!editingId) setEditingId(currentEntry.id);
          if (db) {
            const tx = db.transaction('entries', 'readwrite');
            tx.objectStore('entries').put(currentEntry);
            tx.oncomplete = () => {
              setEntries(prev => {
                const exists = prev.find(e => e.id === currentEntry.id);
                if (exists) return prev.map(e => e.id === currentEntry.id ? currentEntry : e);
                return [currentEntry, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date));
              });
              setAutoSaveStatus('Gespeichert');
              setTimeout(() => setAutoSaveStatus(''), 2000);
            };
          }
        }, 2000);
        return () => clearTimeout(timer);
      }, [title, text, selectedColor, selectedImage, selectedVideo, audioUrl, isLocked, isManifested, unlockDate, unlockLocation, category, mood, location, parentId, inheritedFrom, db, showEditor, editingId, entries, view]);

      useEffect(() => {
        if (showEditor && editorRef.current && editorRef.current.innerHTML !== text) {
          editorRef.current.innerHTML = text || '';
        }
      }, [showEditor, editingId]);

      // Zeichenfläche
      useEffect(() => {
        let canvasEl = canvasRef.current;
        const preventScroll = (e) => { e.preventDefault(); };
        if (isDrawing && canvasEl) {
           canvasEl.addEventListener('touchstart', preventScroll, { passive: false });
           canvasEl.addEventListener('touchmove', preventScroll, { passive: false });
           setTimeout(() => {
             if (!canvasEl) return;
             const rect = canvasEl.parentElement.getBoundingClientRect();
             const dpr = window.devicePixelRatio || 1;
             canvasEl.width = rect.width * dpr; canvasEl.height = rect.height * dpr;
             canvasEl.style.width = `${rect.width}px`; canvasEl.style.height = `${rect.height}px`;
             const ctx = canvasEl.getContext('2d'); ctx.scale(dpr, dpr); ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, rect.width, rect.height);
             ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 5; ctx.strokeStyle = '#1e293b';
           }, 50);
        }
        return () => {
          if (canvasEl) { canvasEl.removeEventListener('touchstart', preventScroll); canvasEl.removeEventListener('touchmove', preventScroll); }
        };
      }, [isDrawing]);

      const getCoordinates = (e, canvas) => {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        }
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      };

      const startDrawing = (e) => {
        if (!canvasRef.current) return;
        const coords = getCoordinates(e.nativeEvent || e, canvasRef.current);
        const ctx = canvasRef.current.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(coords.x, coords.y);
        canvasRef.current.isPainting = true;
      };

      const draw = (e) => {
        if (!canvasRef.current?.isPainting) return;
        const coords = getCoordinates(e.nativeEvent || e, canvasRef.current);
        const ctx = canvasRef.current.getContext('2d');
        ctx.lineTo(coords.x, coords.y);
        ctx.stroke();
      };

      const stopDrawing = () => {
        if (canvasRef.current) canvasRef.current.isPainting = false;
      };

      const deleteFromDB = async (id) => {
        if (!db) return;
        const tx = db.transaction('entries', 'readwrite');
        tx.objectStore('entries').delete(id);
        tx.oncomplete = () => setEntries(prev => prev.filter(e => e.id !== id));
      };

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            if (type === 'image') { setSelectedImage(reader.result); setSelectedVideo(null); }
            if (type === 'video') { setSelectedVideo(reader.result); setSelectedImage(null); }
          };
          reader.readAsDataURL(file);
        }
      };
      
      const handleAudioUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setAudioUrl(reader.result);
          };
          reader.readAsDataURL(file);
        }
      };

      const handleAvatarUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const MAX_SIZE = 400; let width = img.width; let height = img.height;
              if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
              else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
              canvas.width = width; canvas.height = height;
              const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
              setUser(prev => ({ ...prev, avatar: canvas.toDataURL('image/jpeg', 0.8) }));
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
        e.target.value = null;
      };

      const exportText = () => {
        let textContent = "# LEGACY VISION JOURNAL\n\n";
        textContent += `Eigentümer: ${user.name}\n`;
        if (user.motto) textContent += `Lebensmotto: ${user.motto}\n`;
        textContent += `Exportiert am: ${new Date().toLocaleDateString('de-DE')}\n\n`;
        textContent += "=========================================\n\n";
        
        entries.filter(e => !e.locked && !e.archived).forEach(entry => {
            textContent += `## ${entry.title}\n`;
            textContent += `Datum: ${new Date(entry.date).toLocaleDateString('de-DE')}\n`;
            if (entry.category) textContent += `Kategorie: ${entry.category}\n`;
            if (entry.mood) textContent += `Stimmung: ${entry.mood}\n`;
            textContent += "\n";
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = entry.text || '';
            textContent += tempDiv.textContent || tempDiv.innerText || "";
            textContent += "\n\n-----------------------------------------\n\n";
        });
        
        const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Legacy_Text_Export_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
      };

      const exportBackup = () => {
        const data = { user, entries };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Legacy_Backup_${new Date().toISOString().split('T')[0]}.legacy`;
        a.click();
      };

      const importBackup = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.entries) {
              const isForeign = data.user && data.user.name !== user.name;
              if (db) {
                  const tx = db.transaction('entries', 'readwrite');
                  const store = tx.objectStore('entries');
                  let mergedCount = 0;
                  data.entries.forEach(entry => {
                     if (!entries.find(ex => ex.id === entry.id)) {
                        if (isForeign) entry.inheritedFrom = data.user.name;
                        store.put(entry);
                        mergedCount++;
                     }
                  });
                  const req = store.getAll();
                  req.onsuccess = () => {
                     setEntries(req.result.sort((a,b) => new Date(b.date) - new Date(a.date)));
                     showDialog({ title: 'Erfolg', message: `Fusion erfolgreich! ${mergedCount} neue Visionen importiert.`, icon: 'check' });
                  };
              }
            }
          } catch (err) { showDialog({ title: 'Fehler', message: 'Ungültige Legacy-Datei.', icon: 'x' }); }
        };
        reader.readAsText(file);
      };

      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream);
          audioChunksRef.current = [];
          mediaRecorderRef.current.ondataavailable = (e) => { if (e.data.size > 0) audioChunksRef.current.push(e.data); };
          mediaRecorderRef.current.onstop = () => {
            const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => setAudioUrl(reader.result); 
          };
          mediaRecorderRef.current.start();
          setIsRecording(true);
        } catch (err) { showDialog({ title: 'Fehler', message: 'Mikrofon-Zugriff verweigert.', icon: 'x' }); }
      };
      
      const stopRecording = () => { if (mediaRecorderRef.current) { mediaRecorderRef.current.stop(); setIsRecording(false); } };

      const toggleDictation = () => {
        if (isDictating) { dictationRef.current?.stop(); setIsDictating(false); return; }
        const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRec) { showDialog({ title: 'Fehler', message: 'Dein Browser unterstützt leider kein Diktieren.', icon: 'x' }); return; }
        dictationRef.current = new SpeechRec();
        dictationRef.current.lang = 'de-DE';
        dictationRef.current.continuous = true;
        dictationRef.current.interimResults = true;
        dictationRef.current.onresult = (e) => {
          let finalTranscript = '';
          for (let i = e.resultIndex; i < e.results.length; ++i) {
            if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript + ' ';
          }
          if (finalTranscript && editorRef.current) {
             editorRef.current.focus();
             document.execCommand('insertText', false, finalTranscript);
             setText(editorRef.current.innerHTML);
          }
        };
        try { dictationRef.current.start(); setIsDictating(true); } 
        catch(e) { showDialog({ title: 'Fehler', message: 'Mikrofon-Zugriff verweigert.', icon: 'x' }); }
      };

      const setGeoLock = () => {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition((pos) => {
            setUnlockLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            setLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
            showDialog({ title: 'Erfolg', message: 'Der Eintrag wurde magisch an diesen physischen Ort gebunden!', icon: 'map-pin', iconColor: 'text-emerald-500' });
          }, () => showDialog({ title: 'Fehler', message: 'Dein Standort konnte nicht ermittelt werden.', icon: 'x' }));
        }
      };

      const triggerBurn = () => { setIsBurning(true); setTimeout(() => { setBurnText(''); setIsBurning(false); setView('dashboard'); }, 2000); };
      const findResonance = () => {
        if (entries.length < 2) return;
        const withMood = entries.filter(e => e.mood && !e.locked);
        if (withMood.length > 0) setEchoEntry(withMood[Math.floor(Math.random() * withMood.length)]);
      };
      const insertPrompt = () => {
        const prompt = DEEP_PROMPTS[Math.floor(Math.random() * DEEP_PROMPTS.length)];
        if (editorRef.current) { editorRef.current.focus(); document.execCommand('insertHTML', false, `<br><strong>[Reflexion]</strong> ${prompt}<br><br>`); setText(editorRef.current.innerHTML); }
      };

      const openEditor = (entry = null) => {
        if (entry && entry.id) {
          setEditingId(entry.id); setTitle(entry.title); 
          let initialText = entry.text || '';
          if (initialText && !initialText.includes('<') && (initialText.includes('**') || initialText.includes('*'))) {
              initialText = initialText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
          }
          setText(initialText); setSelectedColor(entry.color); setSelectedImage(entry.image); setSelectedVideo(entry.video);
          setIsLocked(entry.locked); setAudioUrl(entry.audio); setIsManifested(entry.manifested || false);
          setUnlockDate(entry.unlockDate || ''); setUnlockLocation(entry.unlockLocation || null);
          setEntryType(entry.type || 'vision'); setCategory(entry.category || CATEGORIES[0]);
          setMood(entry.mood || null); setLocation(entry.location || null);
          setParentId(entry.parentId || ''); setInheritedFrom(entry.inheritedFrom || null);
        } else {
          setEditingId(null); setTitle(''); setText(''); setSelectedColor(COLORS[2]); 
          setSelectedImage(null); setSelectedVideo(null); setIsLocked(view === 'vault');
          setAudioUrl(null); setIsManifested(false); setUnlockDate(''); setUnlockLocation(null);
          setEntryType('vision'); setCategory(activeCategory === 'Alle' ? CATEGORIES[0] : activeCategory);
          setMood(null); setLocation(null); setParentId(''); setInheritedFrom(null);
        }
        setZenMode(false); setShowEditor(true);
      };

      const handleVaultClick = async (entry) => {
        if (entry.unlockLocation) {
           if (!("geolocation" in navigator)) { showDialog({ title: 'Fehler', message: 'Ortung nicht verfügbar.', icon: 'x' }); return; }
           navigator.geolocation.getCurrentPosition((pos) => {
             const dist = getDistance(pos.coords.latitude, pos.coords.longitude, entry.unlockLocation.lat, entry.unlockLocation.lng);
             if (dist > 200) { showDialog({ title: 'Blockiert', message: 'Das Orts-Siegel hält stand. Du bist zu weit entfernt. Gehe an den Ursprungsort zurück.', icon: 'lock', iconColor: 'text-rose-500' }); return; } 
             else { triggerUnlock(entry); }
           }, () => { showDialog({ title: 'Fehler', message: 'Dein Ort konnte nicht ermittelt werden.', icon: 'x' }); });
        } else { triggerUnlock(entry); }
      };

      const triggerUnlock = (entry) => {
        if (!user.pin) { showDialog({ title: 'Hinweis', message: 'Bitte richte zuerst eine PIN in den Einstellungen ein.', icon: 'key-round' }); setView('settings'); return; }
        setUnlockTarget(entry); setPinInput(''); setPinError(false); 
      };

      const submitPin = () => {
        if (pinInput === user.pin) { openEditor(unlockTarget); setUnlockTarget(null); } 
        else { setPinError(true); setTimeout(() => setPinError(false), 800); setPinInput(''); }
      };

      const now = new Date();
      
      const visibleEntries = entries.filter(e => {
        const matchesSearch = e.title.toLowerCase().includes(searchQuery.toLowerCase()) || (e.text && e.text.toLowerCase().includes(searchQuery.toLowerCase()));
        const matchesCategory = activeCategory === 'Alle' || e.category === activeCategory;
        if (!matchesSearch || !matchesCategory) return false;
        if (view === 'dashboard') return !e.locked && !e.archived;
        if (view === 'vault') return e.locked && !e.archived;
        if (view === 'archive') return e.archived;
        return false;
      });

      // Echos der Zeit Logik
      const todayDate = new Date();
      const echoOfTime = view === 'dashboard' && searchQuery === '' && activeCategory === 'Alle' ? entries.find(e => {
          if(e.locked || e.archived) return false;
          const eDate = new Date(e.date);
          return eDate.getDate() === todayDate.getDate() && 
                 eDate.getMonth() === todayDate.getMonth() && 
                 eDate.getFullYear() < todayDate.getFullYear();
      }) : null;
      const renderEntries = echoOfTime ? visibleEntries.filter(e => e.id !== echoOfTime.id) : visibleEntries;

      const getWisdoms = () => {
        let wisdoms = [];
        entries.forEach(e => {
           if (e.text && e.text.includes('<blockquote>')) {
             const matches = e.text.match(/<blockquote>(.*?)<\/blockquote>/g);
             if (matches) { matches.forEach(m => wisdoms.push({ text: m.replace(/<\/?blockquote>/g, ''), entry: e })); }
           }
        });
        return wisdoms;
      };

      if (view === 'loading') return <div className="min-h-screen flex items-center justify-center bg-slate-950"><div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div></div>;

      if (view === 'testament') {
        const testamentEntry = entries.find(e => e.id === user.testamentId);
        return (
          <div className="min-h-screen bg-black text-white p-6 sm:p-20 flex flex-col justify-center items-center text-center animate-fade-in relative overflow-hidden">
             <div className="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-amber-500 via-black to-black animate-pulse" />
             <Icon name="skull" size={48} className="text-amber-500 mb-8 z-10 opacity-50" />
             <h1 className="text-3xl font-serif italic mb-12 z-10 text-amber-200">Das Testament von {user.name}</h1>
             {testamentEntry ? (
               <div className="max-w-3xl z-10 bg-white/5 p-6 sm:p-10 rounded-3xl backdrop-blur-xl border border-white/10 w-full mx-4">
                 <h2 className="text-2xl sm:text-4xl font-bold mb-6 font-serif">{testamentEntry.title}</h2>
                 {testamentEntry.video && <video src={testamentEntry.video} controls className="w-full rounded-xl mb-6 shadow-2xl" />}
                 <div className="text-base sm:text-xl leading-relaxed font-serif text-white/80" dangerouslySetInnerHTML={{__html: testamentEntry.text}} />
                 {testamentEntry.audio && <audio src={testamentEntry.audio} controls className="w-full mt-6 opacity-70" />}
               </div>
             ) : ( <p className="z-10 text-white/50">Es wurde keine finale Botschaft hinterlassen.</p> )}
             <button onClick={() => { localStorage.setItem('legacy_last_active', new Date().toISOString()); setView('dashboard'); }} className="mt-20 z-10 text-xs uppercase tracking-widest opacity-30 hover:opacity-100 transition-opacity p-4">Zurück ins Leben (App entsperren)</button>
          </div>
        );
      }

      if (view === 'burn') {
        return (
          <div className={`min-h-screen transition-colors duration-1000 p-4 sm:p-6 flex flex-col ${isBurning ? 'bg-black' : 'bg-rose-950'} relative overflow-hidden`}>
            {isBurning && <div className="absolute inset-0 bg-red-600/20 animate-pulse z-0 mix-blend-overlay" />}
            <div className="flex justify-between items-center mb-8 z-10">
              <button onClick={() => setView('dashboard')} className="text-rose-200 hover:text-white p-2"><Icon name="x" size={28}/></button>
              <span className="text-rose-400 font-serif italic tracking-widest uppercase text-xs font-bold">Lass es los</span>
            </div>
            <textarea value={burnText} onChange={e => setBurnText(e.target.value)} placeholder="Was beschwert deine Seele? Schreibe es auf. Es wird nie gespeichert." className={`flex-1 bg-transparent text-rose-100 placeholder-rose-400/30 text-xl sm:text-4xl leading-relaxed font-serif resize-none focus:outline-none z-10 transition-all duration-1000 ${isBurning ? 'opacity-0 blur-xl translate-y-10 scale-95' : 'opacity-100'} p-2 custom-scrollbar`} />
            <div className="py-10 flex justify-center z-10">
              <button onClick={triggerBurn} disabled={!burnText || isBurning} className="p-5 rounded-full bg-rose-600 text-white shadow-[0_0_40px_rgba(225,29,72,0.6)] hover:scale-110 hover:bg-rose-500 transition-all disabled:opacity-30 disabled:hover:scale-100">
                <Icon name="flame" size={32} className={isBurning ? 'animate-bounce' : ''} />
              </button>
            </div>
          </div>
        );
      }

      if (view === 'galaxy') {
        return (
          <div className="min-h-screen bg-slate-950 text-white overflow-hidden relative touch-pan-x touch-pan-y">
             <button onClick={() => setView('dashboard')} className="absolute top-4 left-4 z-50 p-3 bg-white/10 rounded-full hover:bg-white/20 backdrop-blur-md"><Icon name="x" size={24}/></button>
             <div className="absolute top-6 right-6 z-50 text-right opacity-50 font-serif italic">Deine Gedanken-Galaxie<br/><span className="text-xs font-sans">Ziehe zum Entdecken</span></div>
             <div className="w-[300vw] h-[300vh] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center">
                {entries.filter(e => !e.locked && !e.archived).map((entry, i) => {
                   const angle = (i * 137.5) * (Math.PI / 180);
                   const radius = 80 + (i * 15);
                   const x = Math.cos(angle) * radius; const y = Math.sin(angle) * radius;
                   const isBig = entry.manifested;
                   const starColor = MOODS.find(m => m.label === entry.mood)?.color.replace('text-', 'bg-') || 'bg-slate-700';
                   return (
                     <div key={entry.id} onClick={() => setViewingEntry(entry)} className={`absolute rounded-full cursor-pointer transition-transform hover:scale-150 shadow-[0_0_20px_currentColor] ${starColor} ${isBig ? 'w-5 h-5' : 'w-2 h-2 animate-pulse'}`} style={{ transform: `translate(${x}px, ${y}px)` }} title={entry.title}>
                        {isBig && <div className="absolute inset-0 bg-white/30 rounded-full animate-ping" />}
                        <div className="absolute top-full mt-2 left-1/2 -translate-x-1/2 whitespace-nowrap text-[10px] opacity-0 hover:opacity-100 transition-opacity bg-black/80 px-2 py-1 rounded font-serif">{entry.title}</div>
                     </div>
                   )
                })}
             </div>
          </div>
        );
      }

      if (view === 'symphony') {
        const audioEntries = entries.filter(e => e.audio);
        const currentAudio = audioEntries[symphonyIndex];
        return (
          <div className="min-h-screen bg-slate-950 text-white flex flex-col p-4 sm:p-6 items-center justify-center relative overflow-hidden">
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/40 via-slate-950 to-slate-950 animate-pulse" />
            <button onClick={() => setView('dashboard')} className="absolute top-4 left-4 p-3 bg-white/10 rounded-full hover:bg-white/20 z-10"><Icon name="x" size={24}/></button>
            <Icon name="headphones" size={48} className="text-indigo-500 mb-8 z-10 opacity-80" />
            <h1 className="text-2xl sm:text-3xl font-serif mb-2 z-10">Lebens-Symphonie</h1>
            <p className="opacity-50 mb-10 z-10 text-sm">{audioEntries.length} Erinnerungen in deiner Stimme</p>
            {currentAudio ? (
              <div className="w-full max-w-md bg-white/5 p-6 rounded-3xl backdrop-blur-md border border-white/10 z-10 text-center">
                 <h2 className="text-xl sm:text-2xl font-bold mb-2 font-serif">{currentAudio.title}</h2>
                 <p className="text-xs opacity-50 mb-6">{new Date(currentAudio.date).toLocaleDateString('de-DE')}</p>
                 <audio ref={audioPlayerRef} src={currentAudio.audio} controls autoPlay onEnded={() => setSymphonyIndex(prev => (prev + 1) % audioEntries.length)} className="w-full custom-audio-player h-10" />
                 <div className="flex justify-between mt-6">
                    <button onClick={() => setSymphonyIndex(prev => prev > 0 ? prev - 1 : audioEntries.length - 1)} className="p-2 opacity-50 hover:opacity-100 text-sm">Zurück</button>
                    <button onClick={() => setSymphonyIndex(prev => (prev + 1) % audioEntries.length)} className="p-2 opacity-50 hover:opacity-100 text-sm">Nächste</button>
                 </div>
              </div>
            ) : ( <p className="z-10 opacity-50 text-sm text-center">Du hast noch keine Sprachnotizen aufgenommen.</p> )}
          </div>
        );
      }

      if (view === 'wisdom') {
        const wisdoms = getWisdoms();
        return (
          <div className="min-h-screen bg-slate-900 text-slate-100 p-4 sm:p-10 font-serif">
            <button onClick={() => setView('dashboard')} className="mb-8 p-3 bg-black/20 rounded-full hover:bg-black/40"><Icon name="x" size={24}/></button>
            <div className="max-w-2xl mx-auto">
               <h1 className="text-4xl sm:text-5xl font-bold mb-4 text-center border-b border-white/10 pb-4 font-serif">Buch der Weisheit</h1>
               <p className="text-center italic opacity-60 mb-12 text-sm">Extrahierte Essenzen deines Lebens.</p>
               <div className="space-y-12">
                 {wisdoms.length === 0 ? <p className="text-center opacity-50 text-sm">Nutze im Editor das Zitat-Icon, um Sätze als Weisheit zu markieren.</p> : null}
                 {wisdoms.map((w, i) => (
                    <div key={i} className="relative px-4">
                      <Icon name="quote" size={28} className="absolute -top-3 -left-2 text-amber-500/20 rotate-180" />
                      <p className="text-lg sm:text-2xl leading-relaxed z-10 relative text-white/90 font-serif">{w.text}</p>
                      <p className="text-[10px] font-sans uppercase tracking-widest mt-3 opacity-40">— aus "{w.entry.title}" ({new Date(w.entry.date).getFullYear()})</p>
                    </div>
                 ))}
               </div>
            </div>
          </div>
        );
      }

      if (view === 'legacy_print') {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-10 print-container">
            <div className="no-print mb-8 flex justify-between">
              <button onClick={() => setView('settings')} className="px-4 py-2 bg-slate-800 rounded-xl">Zurück</button>
              <button onClick={() => window.print()} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-bold flex gap-2"><Icon name="printer" /> Als PDF drucken</button>
            </div>
            <div className="max-w-3xl mx-auto space-y-20">
              <div className="text-center space-y-4 py-32 border-b-2 border-white/20">
                <h1 className="text-5xl font-serif font-bold">Das Vermächtnis</h1>
                <h2 className="text-3xl font-light">von {user.name}</h2>
                <p className="italic text-xl">"{user.motto}"</p>
              </div>
              {entries.filter(e => !e.locked && !e.archived).map(entry => (
                <div key={entry.id} className="break-inside-avoid space-y-6">
                  <h3 className="text-3xl font-serif font-bold border-b border-white/20 pb-2">{entry.title}</h3>
                  <p className="text-sm opacity-50">{new Date(entry.date).toLocaleDateString('de-DE')} • {entry.category}</p>
                  {entry.image && <img src={entry.image} className="w-full max-h-96 object-cover rounded-xl" alt="Vision"/>}
                  <div className="text-lg leading-relaxed font-serif legacy-content" dangerouslySetInnerHTML={{ __html: entry.text }} />
                </div>
              ))}
            </div>
          </div>
        );
      }

      if (view === 'onboarding') {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 transition-colors duration-700 bg-slate-950 text-white relative">
            <div className="grain-overlay"></div>
            <div className="max-w-md w-full space-y-8 animate-slide-up z-10">
              <div className="text-center space-y-2">
                <Icon name="book-open" size={48} className="mx-auto text-amber-500 mb-6" />
                <h1 className="text-4xl font-extrabold font-serif text-amber-100">Dein Vermächtnis</h1>
                <p className="text-lg opacity-60 font-light font-serif italic">Ein Ort für deine tiefsten Visionen. Für die Ewigkeit.</p>
              </div>
              <div className="p-8 rounded-3xl shadow-2xl backdrop-blur-xl border bg-white/5 border-white/10">
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium opacity-70 mb-2 uppercase tracking-widest">Wie lautet dein Name?</label>
                    <input type="text" value={user.name} onChange={(e) => setUser({...user, name: e.target.value})} className="w-full p-4 rounded-xl border-none focus:ring-2 focus:ring-amber-500 transition-all text-lg bg-black/20 text-white font-serif" placeholder="Schreibe hier..." />
                  </div>
                  <button onClick={() => user.name.trim() ? setView('dashboard') : showDialog({ title: 'Name fehlt', message: 'Bitte gib deinen Namen ein.', icon: 'user', iconColor: 'text-amber-500'})} className="w-full py-4 rounded-xl bg-gradient-to-r from-amber-600 to-amber-500 text-slate-900 font-bold text-lg hover:opacity-90 transition-opacity shadow-lg">
                    Journal beginnen
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <ErrorBoundary>
        <div className="min-h-screen transition-colors duration-700 font-sans pb-[env(safe-area-inset-bottom,4rem)] mb-16 sm:mb-20 text-slate-100 selection:bg-amber-900 selection:text-amber-100 bg-slate-950 relative">
          
          <div className="grain-overlay"></div> {/* FILM GRAIN HAPTIK */}

          {/* FOKUS LESE-MODUS */}
          {viewingEntry && !showEditor && (
            <div className="fixed inset-0 z-[80] bg-[#020617] overflow-y-auto animate-fade-in custom-scrollbar">
               <div className="max-w-3xl mx-auto min-h-screen flex flex-col p-6 sm:p-12">
                   <div className="flex justify-between items-center mb-10 pt-4">
                       <button onClick={() => setViewingEntry(null)} className="p-3 bg-white/5 rounded-full hover:bg-white/10 transition-colors"><Icon name="arrow-left" size={24} className="text-white/70"/></button>
                       <button onClick={() => { const e = viewingEntry; setViewingEntry(null); openEditor(e); }} className="p-3 bg-indigo-500/20 text-indigo-400 rounded-full hover:bg-indigo-500/30 transition-colors flex items-center gap-2 px-5"><Icon name="edit-3" size={18}/> <span className="text-sm font-bold tracking-wide">Bearbeiten</span></button>
                   </div>
                   {viewingEntry.image && <img src={viewingEntry.image} className="w-full rounded-[2rem] mb-10 object-cover shadow-2xl border border-white/5" alt="Vision" />}
                   <h1 className="text-4xl sm:text-5xl font-serif font-bold text-amber-50 mb-6 leading-tight">{viewingEntry.title}</h1>
                   <div className="flex flex-wrap gap-4 mb-12 text-xs font-bold uppercase tracking-widest text-slate-400">
                       <span className="flex items-center gap-1"><Icon name="calendar" size={14}/> {new Date(viewingEntry.date).toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' })}</span>
                       <span>•</span>
                       <span className="text-indigo-400">{viewingEntry.category}</span>
                       {viewingEntry.mood && (() => {
                          const moodObj = MOODS.find(m=>m.label===viewingEntry.mood);
                          if (!moodObj) return null;
                          return <><span className="mx-2">•</span><span className={`flex items-center gap-1 ${moodObj.color}`}><Icon name={moodObj.iconName} size={14}/> {viewingEntry.mood}</span></>
                       })()}
                   </div>
                   <div className="text-lg sm:text-xl leading-relaxed font-serif text-slate-300 legacy-content pb-20" dangerouslySetInnerHTML={{__html: viewingEntry.text}} />
                   {viewingEntry.audio && <div className="mt-8 mb-20 p-4 bg-white/5 rounded-2xl border border-white/10"><audio src={viewingEntry.audio} controls className="w-full opacity-80" /></div>}
               </div>
            </div>
          )}

          {/* DAS NEUE GLASSMORPHISM DIALOG SYSTEM */}
          {dialog && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-950/80 backdrop-blur-xl animate-fade-in" onClick={() => { if(dialog.type === 'alert') setDialog(null); }}>
              <div className="w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)] border border-white/10 bg-slate-900/90 backdrop-blur-md animate-scale-in" onClick={e => e.stopPropagation()}>
                {dialog.icon && (
                  <div className="w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-6 shadow-inner bg-slate-800 border border-white/5">
                    <Icon name={dialog.icon} size={36} className={dialog.iconColor || 'text-indigo-500'} />
                  </div>
                )}
                <h3 className="text-2xl font-bold leading-tight mb-4 text-white font-serif">{dialog.title}</h3>
                <p className="text-base opacity-70 mb-8 text-white leading-relaxed px-2 font-serif">{dialog.message}</p>
                
                {dialog.type === 'prompt' && (
                  <textarea 
                    autoFocus
                    value={dialog.inputValue || ''}
                    onChange={(e) => setDialog({...dialog, inputValue: e.target.value})}
                    className="w-full p-4 mb-6 rounded-2xl bg-black/30 border border-white/10 text-white placeholder-white/30 focus:ring-2 focus:ring-amber-500 outline-none resize-none h-32 custom-scrollbar font-serif"
                    placeholder={dialog.placeholder || "Schreibe hier..."}
                  />
                )}

                <div className="flex flex-col gap-3 w-full">
                  <button 
                    className={`w-full py-4 text-white rounded-2xl font-bold shadow-lg text-base transition-transform active:scale-95 ${dialog.confirmColor || 'bg-indigo-500 hover:bg-indigo-600'}`} 
                    onClick={() => { if(dialog.onConfirm) dialog.onConfirm(dialog.inputValue); else setDialog(null); }}
                  >
                    {dialog.confirmLabel || 'Verstanden'}
                  </button>
                  {dialog.type !== 'alert' && (
                    <button 
                      className="w-full py-4 rounded-2xl font-bold text-base bg-white/5 text-white hover:bg-white/10 transition-colors active:scale-95" 
                      onClick={() => { if(dialog.onCancel) dialog.onCancel(); else setDialog(null); }}
                    >
                      {dialog.cancelLabel || 'Abbrechen'}
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* CUSTOM PICKER (BOTTOM SHEET) */}
          {picker && (
            <div className="fixed inset-0 z-[250] flex items-end sm:items-center justify-center p-4 sm:p-6 bg-slate-950/80 backdrop-blur-xl animate-fade-in" onClick={() => setPicker(null)}>
              <div className="w-full max-w-sm rounded-[2.5rem] bg-slate-900/95 shadow-[0_0_50px_rgba(0,0,0,0.5)] border border-white/10 overflow-hidden animate-slide-up flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b border-white/10 flex justify-between items-center bg-white/5 shrink-0">
                  <h3 className="font-bold text-xl text-white font-serif">{picker.title}</h3>
                  <button onClick={() => setPicker(null)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 text-white transition-colors"><Icon name="x" size={20}/></button>
                </div>
                <div className="overflow-y-auto custom-scrollbar p-3 space-y-1">
                  {picker.options.map(opt => (
                    <button
                      key={opt.value}
                      onClick={() => { picker.onSelect(opt.value); setPicker(null); }}
                      className={`w-full text-left p-4 rounded-2xl transition-all font-bold text-base flex justify-between items-center ${picker.currentValue === opt.value ? 'bg-indigo-500 text-white shadow-md' : 'text-slate-300 hover:bg-white/10 hover:text-white'}`}
                    >
                      <span className="truncate">{opt.label}</span>
                      {picker.currentValue === opt.value && <Icon name="check" size={18} />}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* TRESOR PIN MODAL */}
          {unlockTarget && (
            <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => { setUnlockTarget(null); }} />
              <div className="relative w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl animate-scale-in border bg-slate-900 border-white/10 z-10">
                <div className="flex flex-col items-center w-full animate-fade-in">
                  <div className="w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-inner bg-slate-800"><Icon name="lock" size={28} className="text-rose-500" /></div>
                  <h3 className="text-2xl font-bold mb-2 font-serif">Tresor Entsperren</h3>
                  <p className="text-sm opacity-60 mb-6 truncate w-full font-serif">"{unlockTarget.title}"</p>
                  <input type="password" autoFocus value={pinInput} onChange={(e) => setPinInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && submitPin()} className={`w-full p-4 text-center text-2xl tracking-[1em] rounded-xl border-2 outline-none ${pinError ? 'border-rose-500 bg-rose-50/10 animate-shake' : 'bg-black/50 border-transparent focus:border-indigo-500'}`} placeholder="••••" />
                  <div className="flex gap-3 w-full mt-6">
                    <button onClick={() => setUnlockTarget(null)} className="flex-1 py-3 font-medium opacity-60 bg-white/5 rounded-xl hover:bg-white/10">Abbrechen</button>
                    <button onClick={submitPin} className="flex-1 py-3 rounded-xl font-bold text-white bg-rose-600 shadow-md">Öffnen</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          <header className="sticky top-0 z-30 backdrop-blur-xl border-b px-4 py-3 sm:px-6 sm:py-4 transition-all duration-500 flex justify-between items-center bg-slate-950/80 border-white/10 relative">
            <div className="flex items-center gap-3 flex-1 overflow-hidden z-10">
              {view === 'settings' ? <h1 className="text-2xl font-extrabold tracking-tight font-serif text-amber-50">Einstellungen</h1> :
               view === 'menu' ? <h1 className="text-2xl font-extrabold tracking-tight font-serif text-amber-50">Entdecken</h1> :
              (
                <>
                  {user.avatar && <img src={user.avatar} alt="Profil" className="w-10 h-10 rounded-full object-cover border-2 shadow-sm shrink-0" style={{ borderColor: user.nameColor || '#f59e0b' }} />}
                  <div className="flex flex-col overflow-hidden">
                    <h1 className="text-xl font-extrabold tracking-tight truncate font-serif" style={{ color: user.nameColor || '#f59e0b' }}>
                      {view === 'archive' ? 'Archiv' : user.name}
                    </h1>
                    {view === 'vault' && <p className="text-xs mt-0.5 font-medium flex items-center gap-1 text-rose-400"><Icon name="shield-check" size={14} /> Sicherer Tresor</p>}
                    {view === 'dashboard' && user.motto && <p className="text-[10px] mt-0.5 italic font-light truncate max-w-[200px] text-white/50 font-serif">"{user.motto}"</p>}
                  </div>
                </>
              )}
            </div>
            
            <div className="flex gap-1 items-center z-10">
              {view === 'dashboard' && (
                 <>
                   <button onClick={findResonance} className="p-2.5 rounded-full transition-colors bg-white/10 hover:bg-white/20" title="Resonanz finden"><Icon name="eye" size={18}/></button>
                   <div className="flex items-center relative">
                      <input type="text" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} placeholder="Suchen..." className={`transition-all duration-300 border-none focus:ring-0 text-sm rounded-full bg-white/10 text-white ${isSearchOpen ? 'w-32 px-4 py-2 mr-1 opacity-100' : 'w-0 p-0 opacity-0 pointer-events-none'}`} />
                      <button onClick={() => setIsSearchOpen(!isSearchOpen)} className={`p-2.5 rounded-full transition-colors bg-white/10 hover:bg-white/20 ${isSearchOpen ? 'bg-amber-100 text-amber-600' : ''}`}><Icon name="search" size={18}/></button>
                   </div>
                   <button onClick={() => setView('menu')} className="p-2.5 rounded-full transition-colors bg-white/10 hover:bg-white/20"><Icon name="menu" size={18}/></button>
                 </>
              )}
              {(view === 'settings' || view === 'menu' || view === 'archive') && <button onClick={() => setView('dashboard')} className="p-2.5 rounded-full border border-transparent bg-white/10 hover:bg-white/20"><Icon name="x" size={18} /></button>}
            </div>
          </header>

          <main className="p-4 sm:p-6 max-w-4xl mx-auto min-h-[60vh] relative z-10">
            
            {installHint && view === 'dashboard' && (
              <div className="mb-6 p-4 bg-indigo-500/10 border border-indigo-500/20 rounded-2xl flex gap-3 items-start text-indigo-300 text-sm font-medium shadow-sm animate-fade-in backdrop-blur-md">
                 <Icon name="info" size={20} className="shrink-0 mt-0.5" />
                 <p className="flex-1 leading-relaxed">{installHint}</p>
                 <button onClick={() => setInstallHint('')} className="shrink-0 opacity-50 hover:opacity-100"><Icon name="x" size={18}/></button>
              </div>
            )}
            
            {view === 'menu' && (
              <div className="grid grid-cols-2 gap-4 sm:gap-6 animate-slide-up">
                 <button onClick={() => setView('wisdom')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-lg bg-amber-950/20 border-amber-900/50 hover:bg-amber-900/30">
                    <Icon name="book-open" size={36} className="text-amber-500" />
                    <span className="font-bold text-sm tracking-wide font-serif">Buch der Weisheit</span>
                 </button>
                 <button onClick={() => setView('symphony')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-lg bg-indigo-950/20 border-indigo-900/50 hover:bg-indigo-900/30">
                    <Icon name="headphones" size={36} className="text-indigo-500" />
                    <span className="font-bold text-sm tracking-wide font-serif">Symphonie</span>
                 </button>
                 <button onClick={() => setView('burn')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-lg bg-rose-950/20 border-rose-900/50 hover:bg-rose-900/30">
                    <Icon name="flame" size={36} className="text-rose-500" />
                    <span className="font-bold text-sm tracking-wide font-serif">Katharsis</span>
                 </button>
                 <button onClick={() => setView('galaxy')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-lg bg-slate-900/50 border-white/10 hover:bg-slate-800">
                    <Icon name="orbit" size={36} className="text-white" />
                    <span className="font-bold text-sm tracking-wide font-serif">Galaxie</span>
                 </button>
                 <button onClick={() => setView('archive')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-lg bg-slate-900/50 border-white/10 hover:bg-slate-800">
                    <Icon name="archive" size={36} className="opacity-50" />
                    <span className="font-bold text-sm tracking-wide font-serif">Archiv</span>
                 </button>
                 <button onClick={() => setView('settings')} className="p-6 sm:p-8 rounded-3xl flex flex-col items-center justify-center gap-4 text-center border transition-all active:scale-95 shadow-lg bg-slate-900/50 border-white/10 hover:bg-slate-800">
                    <Icon name="settings" size={36} className="opacity-50" />
                    <span className="font-bold text-sm tracking-wide font-serif">Einstellungen</span>
                 </button>
              </div>
            )}

            {view === 'settings' && (
              <div className="space-y-6 animate-slide-up grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div className="p-6 rounded-[2rem] shadow-lg border bg-white/5 border-white/10 backdrop-blur-md">
                  <h2 className="text-lg font-bold mb-6 flex items-center gap-2 font-serif"><Icon name="user" size={20} className="text-amber-500" /> Profil</h2>
                  <div className="flex items-center gap-5 mb-6">
                    <div className="relative shrink-0">
                      <div className="w-20 h-20 rounded-full overflow-hidden border-[3px] shadow-sm flex items-center justify-center bg-slate-800 border-slate-700" style={{ borderColor: user.avatar ? user.nameColor : undefined }}>
                        {user.avatar ? <img src={user.avatar} alt="Avatar" className="w-full h-full object-cover" /> : <Icon name="user" size={32} className="text-slate-400" />}
                      </div>
                      <label className="absolute -bottom-1 -right-1 p-2 bg-amber-500 text-white rounded-full cursor-pointer shadow-lg hover:scale-110 transition-transform"><Icon name="camera" size={14} /><input type="file" accept="image/*" onChange={handleAvatarUpload} className="hidden" /></label>
                    </div>
                    <div className="flex-1 space-y-3">
                      <input type="text" value={user.name} onChange={(e) => setUser({...user, name: e.target.value})} className="w-full p-3 rounded-xl border-none focus:ring-2 focus:ring-amber-500 text-base bg-black/30 text-white font-serif" placeholder="Dein Name" />
                      <div className="flex gap-2 flex-wrap">
                        {['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#8b5cf6', '#ffffff', '#1f2937'].map(color => (
                          <button key={color} onClick={() => setUser({...user, nameColor: color})} className={`w-6 h-6 rounded-full border-2 transition-transform ${user.nameColor === color ? 'border-slate-400 scale-125' : 'border-transparent hover:scale-110'}`} style={{ backgroundColor: color }} />
                        ))}
                      </div>
                    </div>
                  </div>
                  <textarea value={user.motto} onChange={(e) => setUser({...user, motto: e.target.value})} className="w-full p-4 rounded-xl border-none focus:ring-2 focus:ring-amber-500 h-20 resize-none text-sm bg-black/30 text-white font-serif italic" placeholder="Dein Lebensmotto..." />
                </div>
                
                <div className="p-6 rounded-[2rem] shadow-lg border bg-rose-950/20 border-rose-900/50 backdrop-blur-md">
                  <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-rose-500 font-serif"><Icon name="key-round" size={20} /> Sicherheit</h2>
                  {!user.pin ? (
                    <div>
                      <input type="password" value={newPinInput} onChange={(e) => setNewPinInput(e.target.value)} placeholder="Neue PIN (z.B. 4 Zahlen)" className="w-full p-4 rounded-xl border-none focus:ring-2 focus:ring-rose-500 tracking-[0.5em] text-center text-xl mb-4 bg-black/30 text-white" />
                      <button onClick={() => { if(newPinInput.length >= 4) { setUser({...user, pin: newPinInput}); setNewPinInput(''); } else showDialog({ title: 'PIN zu kurz', message: 'Die PIN muss mindestens 4 Zeichen lang sein.', icon: 'x' }); }} className="w-full py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold text-sm transition-colors shadow-lg">PIN speichern</button>
                    </div>
                  ) : isChangingPin ? (
                    <div className="space-y-3">
                      <input type="password" value={oldPinInput} onChange={(e) => setOldPinInput(e.target.value)} placeholder="Alte PIN" className="w-full p-3 rounded-xl text-center tracking-[0.5em] text-lg bg-black/30 text-white" />
                      <input type="password" value={newPinInput} onChange={(e) => setNewPinInput(e.target.value)} placeholder="Neue PIN" className="w-full p-3 rounded-xl text-center tracking-[0.5em] text-lg bg-black/30 text-white" />
                      <div className="flex gap-3">
                        <button onClick={() => setIsChangingPin(false)} className="flex-1 py-3 bg-slate-800 rounded-xl text-sm font-medium hover:bg-slate-700 transition-colors">Abbrechen</button>
                        <button onClick={() => { if (oldPinInput === user.pin) { setUser({...user, pin: newPinInput}); setIsChangingPin(false); showDialog({ title: 'Erfolg', message: 'PIN erfolgreich geändert.', icon: 'check', iconColor: 'text-emerald-500' }); } else showDialog({ title: 'Fehler', message: 'Die alte PIN ist falsch.', icon: 'x', iconColor: 'text-rose-500' }); }} className="flex-1 py-3 bg-rose-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-rose-700 transition-colors">Speichern</button>
                      </div>
                    </div>
                  ) : (
                    <div className="flex justify-between items-center bg-black/20 p-4 rounded-xl border border-white/5">
                      <span className="font-bold text-sm tracking-wide">PIN Aktiv</span>
                      <button onClick={() => setIsChangingPin(true)} className="px-4 py-2 bg-rose-500/20 hover:bg-rose-500/30 transition-colors text-rose-400 rounded-lg font-bold text-xs">Ändern</button>
                    </div>
                  )}
                </div>

                <div className="p-6 rounded-[2rem] shadow-lg border bg-white/5 border-white/10 backdrop-blur-md">
                  <h2 className="text-lg font-bold mb-6 flex items-center gap-2 font-serif"><Icon name="sparkles" size={20} className="text-amber-500" /> Lebensstatistik</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-5 rounded-2xl text-center bg-black/30 border border-white/5">
                      <p className="text-4xl font-black text-indigo-400 mb-1">{entries.length}</p>
                      <p className="text-[10px] opacity-60 uppercase tracking-widest">Erinnerungen</p>
                    </div>
                    <div className="p-5 rounded-2xl text-center bg-black/30 border border-white/5">
                      <p className="text-4xl font-black text-amber-500 mb-1">{entries.filter(e => e.manifested).length}</p>
                      <p className="text-[10px] opacity-60 uppercase tracking-widest">Manifestiert</p>
                    </div>
                  </div>
                </div>

                <div className="p-6 rounded-[2rem] shadow-lg border space-y-4 bg-indigo-950/20 border-indigo-900/50 backdrop-blur-md">
                  <h2 className="text-lg font-bold mb-2 flex items-center gap-2 text-indigo-400 font-serif"><Icon name="archive" size={20} /> System & Vermächtnis</h2>
                  
                  <div className="p-4 bg-black/30 rounded-xl space-y-3 border border-white/5">
                     <div className="flex items-center justify-between">
                        <span className="font-medium text-sm text-slate-300">Testament (Dead Man's Switch)</span>
                        <Icon name="skull" size={16} className="opacity-50" />
                     </div>
                     <button onClick={() => setPicker({
                        title: 'Testament wählen', 
                        currentValue: user.testamentId || '', 
                        options: [{label: 'Kein Testament gewählt', value: ''}, ...entries.map(e => ({label: e.title, value: e.id}))], 
                        onSelect: (val) => setUser({...user, testamentId: val})
                     })} className="w-full p-3 rounded-xl text-sm bg-white/5 hover:bg-white/10 transition-colors text-white border-none flex justify-between items-center">
                       <span className="truncate">{user.testamentId ? entries.find(e => e.id === user.testamentId)?.title || 'Unbekannt' : 'Kein Testament gewählt'}</span>
                       <Icon name="chevron-down" size={16} className="opacity-50 shrink-0 ml-2" />
                     </button>
                  </div>

                  <div className="flex flex-col gap-2 pt-2">
                    <button onClick={exportText} className="w-full flex items-center justify-center gap-2 p-3 bg-slate-800 text-white rounded-xl text-sm font-bold shadow-md hover:bg-slate-700 transition-colors border border-white/5">
                       <Icon name="file-text" size={16}/> Text Export (TXT)
                    </button>
                    <div className="flex gap-2">
                      <button onClick={exportBackup} className="flex-1 flex items-center justify-center gap-1.5 p-3 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-md hover:bg-indigo-500 transition-colors"><Icon name="download" size={16}/> Backup</button>
                      <label className="flex-1 flex items-center justify-center gap-1.5 p-3 bg-slate-800 text-slate-200 rounded-xl text-sm font-bold cursor-pointer border border-white/5 shadow-sm hover:bg-slate-700 transition-colors">
                        <Icon name="upload" size={16}/> Import
                        <input type="file" accept=".legacy,.json" onChange={importBackup} className="hidden" />
                      </label>
                    </div>
                  </div>
                </div>

              </div>
            )}

            {['dashboard', 'vault', 'archive'].includes(view) && (
              <>
                {/* Echos der Zeit */}
                {renderEntries.length > 0 && echoOfTime && (
                   <div className="mb-8 relative animate-fade-in">
                      <div className="absolute -inset-1 bg-gradient-to-r from-amber-500 to-rose-500 rounded-[2.5rem] blur opacity-20 animate-pulse"></div>
                      <div onClick={() => setViewingEntry(echoOfTime)} className="relative p-6 sm:p-8 rounded-[2rem] border border-amber-500/30 bg-slate-900/90 backdrop-blur-xl cursor-pointer hover:scale-[1.02] transition-transform">
                         <div className="flex items-center gap-2 text-amber-500 mb-4">
                            <Icon name="sparkles" size={18} />
                            <span className="text-xs font-bold uppercase tracking-widest">Heute vor {todayDate.getFullYear() - new Date(echoOfTime.date).getFullYear()} Jahren</span>
                         </div>
                         <h3 className="text-2xl sm:text-3xl font-serif font-bold text-amber-50 mb-3">{echoOfTime.title}</h3>
                         <div className="text-sm text-slate-400 font-serif line-clamp-2 legacy-content opacity-80" dangerouslySetInnerHTML={{ __html: echoOfTime.text }} />
                      </div>
                   </div>
                )}

                {view === 'dashboard' && (
                  <div className="flex overflow-x-auto gap-2 pb-4 mb-6 custom-scrollbar snap-x">
                    {['Alle', ...CATEGORIES].map(cat => (
                      <button 
                        key={cat} onClick={() => setActiveCategory(cat)}
                        className={`px-5 py-2 rounded-full whitespace-nowrap snap-start text-sm font-bold transition-all ${activeCategory === cat ? 'bg-indigo-500 text-white shadow-lg' : 'bg-white/5 border border-white/10 opacity-70 hover:opacity-100 hover:bg-white/10 text-white'}`}
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                )}

                {visibleEntries.length === 0 && !echoOfTime && (
                  <div className="flex flex-col items-center justify-center py-32 text-center opacity-30 animate-fade-in">
                    {view === 'vault' ? <Icon name="shield-check" size={64} className="mb-6"/> : view === 'archive' ? <Icon name="archive" size={64} className="mb-6"/> : <Icon name="book-open" size={64} className="mb-6"/>}
                    <p className="text-xl font-medium tracking-wide font-serif italic">
                      {view === 'vault' ? 'Tresor leer.' : view === 'archive' ? 'Archiv leer.' : 'Dein Vermächtnis beginnt.'}
                    </p>
                  </div>
                )}

                <div className="columns-1 sm:columns-2 gap-6 space-y-6 pb-20">
                  {renderEntries.map(entry => {
                    const isCapsuleLocked = entry.unlockDate && new Date(entry.unlockDate) > now;
                    const isGeoLocked = entry.unlockLocation;
                    
                    if (view === 'vault' || isCapsuleLocked || isGeoLocked) {
                      return (
                        <div 
                          key={entry.id} onClick={() => (!isCapsuleLocked || isGeoLocked) && handleVaultClick(entry)}
                          className="break-inside-avoid relative rounded-[2rem] p-6 shadow-lg transition-all cursor-pointer border flex flex-col justify-between items-center text-center aspect-square flex justify-center bg-slate-900 border-white/5 hover:bg-slate-800 hover:border-white/10"
                        >
                          <div className={`p-5 rounded-full mb-6 ${isCapsuleLocked ? 'bg-indigo-900/50 text-indigo-400' : isGeoLocked ? 'bg-emerald-900/50 text-emerald-400' : 'bg-rose-900/50 text-rose-400'}`}>
                            {isCapsuleLocked ? <Icon name="calendar-clock" size={40} /> : isGeoLocked ? <Icon name="map-pin" size={40} /> : <Icon name="lock" size={40} />}
                          </div>
                          <div className="w-full px-2">
                            <h3 className="font-bold text-xl tracking-tight leading-snug truncate font-serif text-slate-200">{entry.title}</h3>
                            <span className="text-[10px] opacity-50 uppercase tracking-widest mt-2 block truncate">
                              {isCapsuleLocked ? `Öffnet ${new Date(entry.unlockDate).toLocaleDateString('de-DE')}` : isGeoLocked ? 'Orts-Siegel' : 'Verwahrt'}
                            </span>
                          </div>
                        </div>
                      );
                    }

                    const textColor = 'text-white';
                    const subTextColor = 'text-white/70';

                    return (
                      <div 
                        key={entry.id} onClick={() => view === 'dashboard' ? setViewingEntry(entry) : null}
                        className={`break-inside-avoid group relative rounded-[2.5rem] shadow-lg transition-all duration-500 overflow-hidden cursor-pointer border border-white/5 hover:border-white/10 ${entry.manifested ? 'ring-2 ring-amber-400/50' : ''}`}
                        style={{ backgroundColor: entry.color }}
                      >
                        {entry.inheritedFrom && (
                          <div className="absolute top-4 left-4 z-30 bg-black/80 text-amber-400 text-[9px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1 backdrop-blur-md">
                            <Icon name="git-merge" size={12}/> Von {entry.inheritedFrom.split(' ')[0]}
                          </div>
                        )}
                        {entry.manifested && (
                          <div className="absolute top-4 right-4 z-30 bg-amber-500 text-slate-900 text-[9px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1">
                            <Icon name="sparkles" size={12}/> Manifestiert
                          </div>
                        )}
                        
                        {entry.image && (
                          <div className="w-full relative overflow-hidden bg-black/20 flex justify-center items-center border-b border-white/5 min-h-[200px]">
                            <img src={entry.image} alt="Vision" className="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-1000" />
                            <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent z-10 pointer-events-none" />
                            <h3 className="absolute bottom-6 left-6 right-6 z-20 font-bold text-2xl text-white drop-shadow-md leading-snug line-clamp-2 font-serif">{entry.title}</h3>
                          </div>
                        )}

                        <div className="p-6 sm:p-8 flex-1 flex flex-col">
                          {!entry.image && <h3 className="font-bold text-3xl leading-tight mb-4 text-white line-clamp-2 font-serif">{entry.title}</h3>}
                          
                          {entry.type === 'letter' && <div className="mb-4 text-[10px] font-bold uppercase tracking-widest opacity-50 flex items-center gap-1 text-white"><Icon name="quote" size={12}/> Brief an die Zukunft</div>}
                          
                          {entry.text && (
                            <div className="text-base leading-relaxed mb-6 text-white/70 font-light line-clamp-4 legacy-content font-serif" dangerouslySetInnerHTML={{ __html: entry.text }} />
                          )}

                          <div className="flex flex-wrap items-center justify-between pt-4 border-t border-white/10 mt-auto">
                            <div className="flex flex-col">
                               <span className="text-[10px] font-bold uppercase tracking-widest text-white/50">
                                 {new Date(entry.date).toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' })}
                               </span>
                            </div>
                            
                            <div className="flex gap-2 items-center text-white/50">
                              {entry.mood && (() => {
                                 const moodObj = MOODS.find(m=>m.label===entry.mood);
                                 if (!moodObj) return null;
                                 return <Icon name={moodObj.iconName} size={16} className={moodObj.color} />;
                              })()}
                              {entry.location && <Icon name="map-pin" size={16} />}
                              {(entry.audio || entry.video) && <Icon name="mic" size={16} />}
                              
                              {view === 'archive' && (
                                <div className="flex gap-2 ml-2">
                                  <button onClick={(e) => { e.stopPropagation(); setEntries(prev => prev.map(ex => ex.id === entry.id ? { ...ex, archived: false } : ex)); }} className="p-2 rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors"><Icon name="rotate-ccw" size={16} /></button>
                                  <button onClick={(e) => { e.stopPropagation(); confirmArchiveDelete(entry.id); }} className="p-2 rounded-full bg-rose-500/20 text-rose-500 hover:bg-rose-600 hover:text-white transition-colors"><Icon name="trash-2" size={16} /></button>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}
          </main>

          {/* EDITOR OVERLAY */}
          {showEditor && (
            <div className="fixed inset-0 z-[100] flex items-end sm:items-center justify-center sm:p-6 transition-all bg-slate-950/80 backdrop-blur-md">
              <div className="absolute inset-0 bg-transparent" onClick={() => checkSaveEntry()} />
              
              <div 
                className="relative w-full max-w-3xl mx-auto flex flex-col shadow-2xl transition-all h-[100dvh] sm:rounded-none bg-transparent sm:h-[90dvh] max-h-[900px] rounded-t-[2rem] sm:rounded-[2.5rem] border-t border-white/10"
                style={{ backgroundColor: zenMode ? 'transparent' : selectedColor }}
              >
                <div className={`flex justify-between items-center px-6 py-5 border-b ${zenMode ? 'border-transparent' : 'border-white/5 bg-white/5'}`}>
                  <button onClick={() => checkSaveEntry()} className="p-2 rounded-full transition-colors text-white hover:bg-white/10"><Icon name="chevron-down" size={24}/></button>
                  
                  {!zenMode && (
                    <div className="flex gap-2 overflow-x-auto hide-scrollbar items-center">
                      {autoSaveStatus && <span className="flex items-center text-xs font-bold text-emerald-400 animate-pulse mr-2"><Icon name="check" size={14} className="mr-1"/> {autoSaveStatus}</span>}
                      
                      {editingId && <button onClick={() => confirmDelete(editingId)} className="p-2.5 rounded-full hover:bg-rose-500/20 text-slate-400 hover:text-rose-400 transition-colors" title="Löschen"><Icon name="trash-2" size={20}/></button>}
                      
                      <button onClick={() => {
                          const entryToArchive = {
                            id: editingId || generateId(),
                            title: title || 'Ohne Titel', text, color: selectedColor,
                            image: selectedImage, video: selectedVideo, audio: audioUrl,
                            locked: isLocked, archived: true, manifested: isManifested,
                            unlockDate, unlockLocation, type: entryType, category, mood, location, parentId, inheritedFrom,
                            date: editingId ? (entries.find(e => e.id === editingId)?.date || new Date().toISOString()) : new Date().toISOString(),
                          };
                          saveToDB(entryToArchive);
                          closeEditor();
                      }} className="p-2.5 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors" title="Ins Archiv"><Icon name="archive" size={20}/></button>

                      <button onClick={() => setZenMode(true)} className="p-2.5 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors"><Icon name="maximize-2" size={20}/></button>
                      <button onClick={() => setIsManifested(!isManifested)} className={`p-2.5 rounded-full transition-colors ${isManifested ? 'bg-amber-500/20 text-amber-400' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}><Icon name="sparkles" size={20}/></button>
                      <button onClick={() => setIsLocked(!isLocked)} className={`p-2.5 rounded-full transition-colors ${isLocked ? 'bg-rose-500/20 text-rose-400' : 'text-slate-400 hover:text-white hover:bg-white/10'}`}><Icon name="lock" size={20}/></button>
                    </div>
                  )}
                  {zenMode && <button onClick={() => setZenMode(false)} className="text-white/50 hover:text-white"><Icon name="minimize-2" size={24}/></button>}

                  <button onClick={checkSaveEntry} className="bg-white text-slate-900 px-6 py-2.5 rounded-full font-bold shadow-lg hover:scale-105 transition-transform flex items-center justify-center text-sm">Sichern</button>
                </div>

                <div className={`flex-1 overflow-y-auto p-6 sm:p-10 flex flex-col gap-6 custom-scrollbar w-full text-white`}>
                  
                  {!zenMode && (
                    <div className="flex flex-wrap gap-3 text-xs font-bold uppercase tracking-widest opacity-70 shrink-0">
                      <button onClick={() => setPicker({
                          title: 'Kategorie wählen', 
                          currentValue: category, 
                          options: CATEGORIES.map(c => ({label: c, value: c})), 
                          onSelect: setCategory
                      })} className="bg-white/10 hover:bg-white/20 transition-colors px-3 py-1.5 rounded-lg text-white flex items-center gap-2">
                        {category} <Icon name="chevron-down" size={14} className="shrink-0"/>
                      </button>
                      
                      <button onClick={() => setPicker({
                          title: 'Art des Eintrags', 
                          currentValue: entryType, 
                          options: [{label: 'Vision / Idee', value: 'vision'}, {label: 'Brief an die Zukunft', value: 'letter'}], 
                          onSelect: setEntryType
                      })} className="bg-white/10 hover:bg-white/20 transition-colors px-3 py-1.5 rounded-lg text-white flex items-center gap-2">
                        {entryType === 'vision' ? 'Vision' : 'Brief'} <Icon name="chevron-down" size={14} className="shrink-0"/>
                      </button>
                      
                      <button onClick={() => setPicker({
                          title: 'Ursprung wählen', 
                          currentValue: parentId, 
                          options: [{label: 'Neuer Gedanke', value: ''}, ...entries.filter(e => e.id !== editingId).map(e => ({label: `Aus: ${e.title}`, value: e.id}))], 
                          onSelect: setParentId
                      })} className="bg-white/10 hover:bg-white/20 transition-colors px-3 py-1.5 rounded-lg text-white flex items-center gap-2 max-w-[200px]">
                        <span className="truncate">{parentId ? `Aus: ${entries.find(e => e.id === parentId)?.title || 'Unbekannt'}` : 'Neuer Gedanke'}</span>
                        <Icon name="chevron-down" size={14} className="shrink-0"/>
                      </button>
                    </div>
                  )}

                  <input type="text" placeholder="Titel deiner Vision..." value={title} onChange={(e) => setTitle(e.target.value)} className="w-full shrink-0 bg-transparent text-4xl sm:text-5xl font-serif font-bold placeholder-white/20 border-none focus:ring-0 p-0 focus:outline-none text-white" />
                  
                  {!zenMode && (
                    <div className="flex gap-2 py-3 border-y border-white/10 opacity-70 shrink-0">
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('bold', false, null); }} className="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Fett"><Icon name="bold" size={18}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('italic', false, null); }} className="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Kursiv"><Icon name="italic" size={18}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('insertUnorderedList', false, null); }} className="p-2 rounded-lg hover:bg-white/10 transition-colors"><Icon name="list-todo" size={18}/></button>
                      <button onMouseDown={(e) => { e.preventDefault(); document.execCommand('formatBlock', false, 'blockquote'); }} className="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Als Weisheit markieren"><Icon name="quote" size={18}/></button>
                    </div>
                  )}

                  <div 
                    ref={editorRef}
                    contentEditable={true}
                    suppressContentEditableWarning={true}
                    data-placeholder="Schreibe deine Gedanken hier..."
                    onInput={(e) => setText(e.currentTarget.innerHTML)}
                    className="w-full flex-1 min-h-[300px] bg-transparent text-lg sm:text-xl leading-relaxed focus:outline-none font-serif empty:before:content-[attr(data-placeholder)] empty:before:opacity-30 empty:before:cursor-text legacy-editor-content pb-20 text-white"
                  />

                  {!zenMode && (
                    <div className="space-y-4 shrink-0 pb-6">
                      {selectedImage && <div className="relative rounded-[2rem] overflow-hidden shadow-2xl bg-black/40 border border-white/10"><img src={selectedImage} alt="Preview" className="w-full h-auto max-h-[50vh] object-cover" /><button onClick={() => setSelectedImage(null)} className="absolute top-4 right-4 bg-black/60 backdrop-blur-md text-white p-3 rounded-full hover:scale-110 transition-transform"><Icon name="x" size={18}/></button></div>}
                      {selectedVideo && <div className="relative rounded-[2rem] overflow-hidden shadow-2xl bg-black/40 border border-white/10"><video src={selectedVideo} controls className="w-full h-auto max-h-[50vh] object-cover bg-black" /><button onClick={() => setSelectedVideo(null)} className="absolute top-4 right-4 bg-black/60 backdrop-blur-md text-white p-3 rounded-full hover:scale-110 transition-transform"><Icon name="x" size={18}/></button></div>}
                      {audioUrl && <div className="bg-white/5 p-4 rounded-2xl flex items-center justify-between backdrop-blur-md border border-white/10"><audio src={audioUrl} controls className="w-full h-10 custom-audio-player" /><button onClick={() => setAudioUrl(null)} className="p-3 bg-rose-500/20 text-rose-500 rounded-full ml-4 hover:bg-rose-500 hover:text-white transition-colors"><Icon name="trash-2" size={18}/></button></div>}
                    </div>
                  )}
                </div>

                {!zenMode && (
                  <div className="border-t border-white/5 bg-black/40 backdrop-blur-2xl p-4 sm:p-6 flex flex-col gap-4 pb-[env(safe-area-inset-bottom,24px)]">
                    
                    <div className="flex justify-between items-center overflow-x-auto hide-scrollbar gap-4">
                      <div className="flex gap-2 shrink-0">
                        <label className="p-3.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors shadow-sm cursor-pointer text-white"><Icon name="image" size={20}/><input type="file" accept="image/*" onChange={(e)=>handleFileUpload(e,'image')} className="hidden" /></label>
                        <button onClick={() => setIsDrawing(true)} className="p-3.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors shadow-sm text-white"><Icon name="pen-tool" size={20}/></button>
                        
                        <label className="p-3.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors shadow-sm cursor-pointer text-white" title="Video aufnehmen">
                           <Icon name="video" size={20}/>
                           <input type="file" accept="video/*" capture="environment" onChange={(e)=>handleFileUpload(e,'video')} className="hidden" />
                        </label>

                        <label className="p-3.5 rounded-full bg-white/10 hover:bg-white/20 transition-colors shadow-sm cursor-pointer text-white" title="Sprachnotiz aufnehmen / hochladen">
                           <Icon name="mic" size={20}/>
                           <input type="file" accept="audio/*" capture="environment" onChange={handleAudioUpload} className="hidden" />
                        </label>
                      </div>
                      
                      <div className="flex gap-2 shrink-0 border-l border-white/10 pl-4">
                        <button onClick={insertPrompt} className="px-4 py-3 rounded-full bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30 transition-colors shadow-sm flex items-center gap-2 text-xs font-bold uppercase tracking-wide"><Icon name="sparkles" size={16}/> Deep Prompt</button>
                        
                        <label className={`relative p-3.5 rounded-full shadow-sm flex items-center justify-center cursor-pointer overflow-hidden transition-colors ${unlockDate ? 'bg-indigo-500 text-white' : 'bg-white/10 hover:bg-white/20 text-white'}`}>
                          <Icon name="calendar-clock" size={20}/>
                          <input type="date" value={unlockDate} onChange={e=>setUnlockDate(e.target.value)} className="absolute opacity-0 w-[200%] h-[200%] -top-1/2 -left-1/2 cursor-pointer" />
                        </label>
                      </div>
                    </div>

                    <div className="flex justify-between items-center overflow-x-auto hide-scrollbar gap-6 border-t border-white/5 pt-4">
                      <div className="flex gap-2 shrink-0">
                         {MOODS.map(m => (
                           <button key={m.id} onClick={()=>setMood(m.label===mood ? null : m.label)} className={`p-2.5 rounded-full transition-all ${mood===m.label ? 'bg-slate-800 shadow-lg scale-110 ' + m.color : 'opacity-50 hover:opacity-100 hover:bg-white/5 text-white'}`}>
                             <Icon name={m.id} size={20} />
                           </button>
                         ))}
                      </div>
                      <div className="flex gap-2 shrink-0">
                        {COLORS.slice(0, 18).map((c) => (
                          <button key={c} onClick={() => setSelectedColor(c)} className={`w-8 h-8 rounded-full shadow-sm border-2 transition-transform ${selectedColor === c ? 'scale-110 border-white z-10' : 'border-transparent opacity-60 hover:opacity-100 hover:scale-105'}`} style={{ backgroundColor: c }} />
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* DRAWING MODAL */}
          {isDrawing && (
            <div className="fixed inset-0 z-[120] flex flex-col bg-slate-900 text-white">
              <div className="flex justify-between items-center p-6 border-b border-white/10 bg-slate-950">
                <button onClick={() => setIsDrawing(false)} className="p-3 text-white/70 hover:text-white bg-white/5 rounded-full"><Icon name="x" size={24} /></button>
                <span className="font-bold font-serif text-xl">Freihand Skizze</span>
                <button 
                  onClick={() => {
                     if(canvasRef.current) {
                       setSelectedImage(canvasRef.current.toDataURL());
                       setIsDrawing(false);
                     }
                  }} 
                  className="bg-amber-500 text-slate-900 px-6 py-3 rounded-full font-bold flex gap-2 items-center shadow-lg"
                >
                  <Icon name="check" size={18}/> Übernehmen
                </button>
              </div>
              <div className="flex-1 relative bg-slate-100 touch-none">
                <canvas 
                  ref={canvasRef} 
                  className="absolute inset-0 w-full h-full cursor-crosshair touch-none"
                  onMouseDown={startDrawing}
                  onMouseMove={draw}
                  onMouseUp={stopDrawing}
                  onMouseLeave={stopDrawing}
                  onTouchStart={startDrawing}
                  onTouchMove={draw}
                  onTouchEnd={stopDrawing}
                />
              </div>
              <div className="p-6 bg-slate-950 flex justify-center border-t border-white/10">
                 <button onClick={() => { 
                   if (!canvasRef.current) return;
                   const canvas = canvasRef.current; 
                   const ctx = canvas.getContext('2d'); 
                   ctx.save();
                   ctx.setTransform(1, 0, 0, 1, 0, 0);
                   ctx.fillStyle = '#f1f5f9'; // passend zu bg-slate-100
                   ctx.fillRect(0, 0, canvas.width, canvas.height); 
                   ctx.restore();
                 }} className="p-4 bg-white/10 rounded-full hover:bg-white/20 text-white flex gap-2 items-center"><Icon name="eraser" size={24}/> <span className="font-bold">Leeren</span></button>
              </div>
            </div>
          )}

          <nav className="fixed bottom-0 left-0 right-0 backdrop-blur-3xl border-t z-40 transition-colors duration-500 bg-slate-950/90 border-white/10 pb-[env(safe-area-inset-bottom,0px)]">
            <div className="flex justify-between items-center h-20 max-w-md mx-auto px-8">
              <button onClick={() => setView('dashboard')} className={`flex flex-col items-center justify-center h-full space-y-1 transition-all ${view === 'dashboard' ? 'text-amber-500 scale-105' : 'text-slate-500 hover:text-slate-300'}`}><Icon name="layout-grid" size={24} /><span className="text-[10px] font-bold uppercase tracking-widest">Visionen</span></button>
              
              <div className="relative -top-6">
                <button onClick={() => openEditor()} className="w-16 h-16 rounded-full shadow-[0_10px_30px_rgba(245,158,11,0.3)] flex items-center justify-center hover:scale-105 active:scale-95 text-slate-900 border-[4px] border-slate-950 transition-transform duration-300 bg-gradient-to-tr from-amber-600 to-amber-400"><Icon name="plus" size={32} /></button>
              </div>
              
              <button onClick={() => setView('vault')} className={`flex flex-col items-center justify-center h-full space-y-1 transition-all ${view === 'vault' ? 'text-indigo-400 scale-105' : 'text-slate-500 hover:text-slate-300'}`}><Icon name="lock" size={24} /><span className="text-[10px] font-bold uppercase tracking-widest">Tresor</span></button>
            </div>
          </nav>
          
        </div>
        </ErrorBoundary>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
